# 聊天功能拓展API汇总

> 文档版本: v1.0
> 更新日期: 2026-01-13
> 适用对象: 前端开发人员

---

## 目录

1. [消息搜索功能](#1-消息搜索功能)
2. [消息引用/回复功能](#2-消息引用回复功能)
3. [消息转发功能](#3-消息转发功能)
4. [消息撤回配置功能](#4-消息撤回配置功能)
5. [通用说明](#5-通用说明)
6. [错误码说明](#6-错误码说明)
7. [前端集成示例](#7-前端集成示例)

---

## 通用说明

### 基础URL

```
http://your-domain/api/v1
```

### 请求头

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Content-Type | String | 是 | application/json |
| Authorization | String | 是 | Bearer {token} |

### 通用响应格式

所有接口返回统一的JSON格式：

```json
{
  "code": 200,
  "message": "success",
  "data": {}
}
```

### 状态码说明

| 状态码 | 说明 |
|--------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 403 | 禁止访问 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

---

## 1. 消息搜索功能

### 1.1 搜索消息

#### 接口信息

- **请求路径**: `/chat/messages/search`
- **请求方法**: `POST`
- **接口描述**: 根据关键词、发送者、时间范围等条件搜索消息，支持分页查询

#### 权限说明

- 用户只能搜索自己参与的会话中的消息
- 需要验证用户是否为会话参与者

#### 请求参数

##### Query参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | 是 | 当前用户ID |

##### Body参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| conversationId | Long | 是 | 会话ID |
| keyword | String | 否 | 搜索关键词（模糊匹配） |
| senderId | Long | 否 | 发送者ID（精确匹配） |
| messageType | String | 否 | 消息类型（精确匹配）：TEXT, IMAGE, FILE, VOICE, VIDEO |
| startTime | DateTime | 否 | 开始时间（ISO 8601格式） |
| endTime | DateTime | 否 | 结束时间（ISO 8601格式） |
| includeDeleted | Boolean | 否 | 是否包含已删除消息，默认false |
| includeRecalled | Boolean | 否 | 是否包含已撤回消息，默认false |
| pageNum | Integer | 否 | 页码，默认1 |
| pageSize | Integer | 否 | 每页大小，默认20，最大100 |

#### 请求示例

##### 搜索关键词

```http
POST /api/v1/chat/messages/search?userId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "conversationId": 1,
  "keyword": "案件",
  "pageNum": 1,
  "pageSize": 20
}
```

##### 按发送者搜索

```http
POST /api/v1/chat/messages/search?userId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "conversationId": 1,
  "senderId": 2,
  "pageNum": 1,
  "pageSize": 20
}
```

##### 按时间范围搜索

```http
POST /api/v1/chat/messages/search?userId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "conversationId": 1,
  "startTime": "2026-01-01T00:00:00",
  "endTime": "2026-01-31T23:59:59",
  "pageNum": 1,
  "pageSize": 20
}
```

##### 组合搜索

```http
POST /api/v1/chat/messages/search?userId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "conversationId": 1,
  "keyword": "案件",
  "messageType": "TEXT",
  "startTime": "2026-01-01T00:00:00",
  "endTime": "2026-01-31T23:59:59",
  "includeDeleted": false,
  "includeRecalled": false,
  "pageNum": 1,
  "pageSize": 20
}
```

#### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "records": [
      {
        "id": 123,
        "conversationId": 1,
        "senderId": 2,
        "senderName": "李四",
        "receiverId": 1,
        "receiverName": "张三",
        "messageType": "TEXT",
        "content": "案件进展如何？",
        "replyToMessageId": null,
        "replyToContent": null,
        "replyToSenderId": null,
        "replyToSenderName": null,
        "fileId": null,
        "fileName": null,
        "fileSize": null,
        "fileUrl": null,
        "messageStatus": "READ",
        "readTime": "2026-01-12T10:35:00",
        "isDeleted": false,
        "isRecalled": false,
        "isForwarded": false,
        "forwardedFromMessageId": null,
        "forwardedFromConversationId": null,
        "forwardedFromSenderId": null,
        "forwardedFromSenderName": null,
        "createTime": "2026-01-12T10:30:00"
      },
      {
        "id": 124,
        "conversationId": 1,
        "senderId": 2,
        "senderName": "李四",
        "receiverId": 1,
        "receiverName": "张三",
        "messageType": "TEXT",
        "content": "案件审理情况更新",
        "replyToMessageId": null,
        "replyToContent": null,
        "replyToSenderId": null,
        "replyToSenderName": null,
        "fileId": null,
        "fileName": null,
        "fileSize": null,
        "fileUrl": null,
        "messageStatus": "READ",
        "readTime": "2026-01-12T11:00:00",
        "isDeleted": false,
        "isRecalled": false,
        "isForwarded": false,
        "forwardedFromMessageId": null,
        "forwardedFromConversationId": null,
        "forwardedFromSenderId": null,
        "forwardedFromSenderName": null,
        "createTime": "2026-01-12T10:50:00"
      }
    ],
    "total": 2,
    "pageNum": 1,
    "pageSize": 20
  }
}
```

#### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| records | Array | 消息列表 |
| total | Long | 总记录数 |
| pageNum | Integer | 当前页码 |
| pageSize | Integer | 每页大小 |

#### 错误响应示例

```json
{
  "code": 400,
  "message": "会话不存在",
  "data": null
}
```

```json
{
  "code": 403,
  "message": "无权搜索此会话的消息",
  "data": null
}
```

#### 注意事项

1. **搜索规则**：
   - 关键词搜索采用模糊匹配（LIKE %keyword%）
   - 发送者ID和消息类型采用精确匹配
   - 时间范围包含边界值

2. **性能优化**：
   - 建议pageSize不超过100
   - 避免频繁调用搜索接口
   - 可以实现前端缓存机制

3. **数据验证**：
   - conversationId必须存在且用户为参与者
   - startTime必须早于endTime（如果同时提供）
   - pageNum和pageSize必须为正整数

4. **搜索建议**：
   - 优先使用关键词搜索
   - 结合时间范围缩小结果
   - 避免空关键词搜索（返回所有消息）

---

## 2. 消息引用/回复功能

### 2.1 回复消息

#### 接口信息

- **请求路径**: `/chat/messages/reply`
- **请求方法**: `POST`
- **接口描述**: 回复指定消息，支持引用原始消息内容

#### 权限说明

- 用户只能回复自己会话中的消息
- 被回复的消息必须存在且未被删除

#### 请求参数

##### Query参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| senderId | Long | 是 | 发送者ID |

##### Body参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| replyToMessageId | Long | 是 | 被回复的消息ID |
| receiverId | Long | 是 | 接收者ID |
| messageType | String | 是 | 消息类型：TEXT, IMAGE, FILE, VOICE, VIDEO |
| content | String | 否 | 文本内容（TEXT类型必填） |
| fileId | Long | 否 | 文件ID（FILE/IMAGE/VOICE/VIDEO类型必填） |
| fileName | String | 否 | 文件名 |
| fileSize | Long | 否 | 文件大小（字节） |
| fileUrl | String | 否 | 文件URL |

#### 请求示例

##### 回复文本消息

```http
POST /api/v1/chat/messages/reply?senderId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "replyToMessageId": 123,
  "receiverId": 2,
  "messageType": "TEXT",
  "content": "好的，我明白了"
}
```

##### 回复图片消息

```http
POST /api/v1/chat/messages/reply?senderId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "replyToMessageId": 123,
  "receiverId": 2,
  "messageType": "IMAGE",
  "fileId": 456,
  "fileName": "photo.jpg",
  "fileSize": 1024000,
  "fileUrl": "/file/download/456"
}
```

#### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 125,
    "conversationId": 1,
    "senderId": 1,
    "senderName": "张三",
    "receiverId": 2,
    "receiverName": "李四",
    "messageType": "TEXT",
    "content": "好的，我明白了",
    "replyToMessageId": 123,
    "replyToContent": "案件进展如何？",
    "replyToSenderId": 2,
    "replyToSenderName": "李四",
    "fileId": null,
    "fileName": null,
    "fileSize": null,
    "fileUrl": null,
    "messageStatus": "SENT",
    "readTime": null,
    "isDeleted": false,
    "isRecalled": false,
    "isForwarded": false,
    "forwardedFromMessageId": null,
    "forwardedFromConversationId": null,
    "forwardedFromSenderId": null,
    "forwardedFromSenderName": null,
    "createTime": "2026-01-13T09:00:00"
  }
}
```

#### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| replyToMessageId | Long | 被回复的消息ID |
| replyToContent | String | 被回复消息的内容快照 |
| replyToSenderId | Long | 被回复消息的发送者ID |
| replyToSenderName | String | 被回复消息的发送者名称 |
| 其他字段 | - | 同普通消息 |

#### 错误响应示例

```json
{
  "code": 400,
  "message": "被回复的消息不存在",
  "data": null
}
```

```json
{
  "code": 400,
  "message": "不能给自己发送消息",
  "data": null
}
```

#### 注意事项

1. **引用机制**：
   - replyToContent保存被回复消息的快照
   - 即使原消息被删除，引用内容仍保留
   - 支持嵌套回复（回复的回复）

2. **会话处理**：
   - 回复消息会自动创建或获取会话
   - 会话的lastMessage会更新为回复消息
   - 接收者的未读消息数会增加

3. **前端展示**：
   - 建议显示引用消息的预览
   - 提供点击跳转到原消息的功能
   - 区分显示回复消息和普通消息

4. **数据验证**：
   - replyToMessageId必须存在
   - receiverId不能与senderId相同
   - messageType与content/fileId必须匹配

---

## 3. 消息转发功能

### 3.1 转发消息

#### 接口信息

- **请求路径**: `/chat/messages/forward`
- **请求方法**: `POST`
- **接口描述**: 转发一条或多条消息到指定会话

#### 权限说明

- 用户只能转发自己会话中的消息
- 目标会话必须用户为参与者
- 转发的消息必须存在且未被删除

#### 请求参数

##### Query参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| senderId | Long | 是 | 发送者ID |

##### Body参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| targetConversationId | Long | 是 | 目标会话ID |
| targetReceiverId | Long | 是 | 目标接收者ID |
| messageIds | Array | 是 | 要转发的消息ID列表 |
| forwardComment | String | 否 | 转发评论（可选） |

#### 请求示例

##### 转发单条消息

```http
POST /api/v1/chat/messages/forward?senderId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "targetConversationId": 2,
  "targetReceiverId": 3,
  "messageIds": [123]
}
```

##### 转发多条消息

```http
POST /api/v1/chat/messages/forward?senderId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "targetConversationId": 2,
  "targetReceiverId": 3,
  "messageIds": [123, 124, 125]
}
```

##### 转发带评论

```http
POST /api/v1/chat/messages/forward?senderId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "targetConversationId": 2,
  "targetReceiverId": 3,
  "messageIds": [123],
  "forwardComment": "请查看以下消息"
}
```

#### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 126,
      "conversationId": 2,
      "senderId": 1,
      "senderName": "张三",
      "receiverId": 3,
      "receiverName": "王五",
      "messageType": "TEXT",
      "content": "案件进展如何？",
      "replyToMessageId": null,
      "replyToContent": null,
      "replyToSenderId": null,
      "replyToSenderName": null,
      "fileId": null,
      "fileName": null,
      "fileSize": null,
      "fileUrl": null,
      "messageStatus": "SENT",
      "readTime": null,
      "isDeleted": false,
      "isRecalled": false,
      "isForwarded": true,
      "forwardedFromMessageId": 123,
      "forwardedFromConversationId": 1,
      "forwardedFromSenderId": 2,
      "forwardedFromSenderName": "李四",
      "createTime": "2026-01-13T09:10:00"
    }
  ]
}
```

#### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| isForwarded | Boolean | 是否为转发消息 |
| forwardedFromMessageId | Long | 转发源消息ID |
| forwardedFromConversationId | Long | 转发源会话ID |
| forwardedFromSenderId | Long | 转发源消息发送者ID |
| forwardedFromSenderName | String | 转发源消息发送者名称 |
| 其他字段 | - | 同普通消息 |

#### 错误响应示例

```json
{
  "code": 400,
  "message": "要转发的消息不存在",
  "data": null
}
```

```json
{
  "code": 403,
  "message": "无权转发到此会话",
  "data": null
}
```

#### 注意事项

1. **转发机制**：
   - 转发消息会创建新的消息记录
   - 保留原消息的所有属性（内容、文件等）
   - 记录转发源信息（会话、发送者）

2. **转发评论**：
   - forwardComment会覆盖原消息的content
   - 建议显示转发评论和原消息内容
   - 不提供评论时显示原消息内容

3. **会话处理**：
   - 目标会话的lastMessage会更新
   - 接收者的未读消息数会增加
   - 每条转发消息都会触发WebSocket推送

4. **批量转发**：
   - 支持一次转发多条消息
   - 按messageIds顺序创建转发消息
   - 建议限制单次转发数量（如最多10条）

5. **前端展示**：
   - 建议显示"转发"标识
   - 显示转发源信息（发送者、会话）
   - 提供查看原消息的链接

---

## 4. 消息撤回配置功能

### 4.1 更新撤回配置

#### 接口信息

- **请求路径**: `/chat/recall/config`
- **请求方法**: `PUT`
- **接口描述**: 更新消息撤回配置（全局或用户级别）

#### 权限说明

- 全局配置需要管理员权限
- 用户配置只能更新自己的配置

#### 请求参数

##### Body参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| configType | String | 是 | 配置类型：GLOBAL（全局）或 USER（用户） |
| targetId | Long | 否 | 目标ID（用户配置时必填） |
| recallTimeLimit | Integer | 否 | 撤回时间限制（秒），默认120 |
| allowRecall | Boolean | 否 | 是否允许撤回，默认true |
| maxRecallTimes | Integer | 否 | 每日最大撤回次数，默认10 |
| remark | String | 否 | 备注说明 |

#### 请求示例

##### 更新全局配置

```http
PUT /api/v1/chat/recall/config
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "configType": "GLOBAL",
  "recallTimeLimit": 300,
  "allowRecall": true,
  "maxRecallTimes": 50,
  "remark": "全局撤回配置：5分钟内可撤回，每日最多50次"
}
```

##### 更新用户配置

```http
PUT /api/v1/chat/recall/config
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "configType": "USER",
  "targetId": 1,
  "recallTimeLimit": 180,
  "allowRecall": true,
  "maxRecallTimes": 20,
  "remark": "用户1的撤回配置：3分钟内可撤回，每日最多20次"
}
```

#### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": null
}
```

#### 错误响应示例

```json
{
  "code": 400,
  "message": "用户配置必须指定用户ID",
  "data": null
}
```

```json
{
  "code": 400,
  "message": "不支持的配置类型",
  "data": null
}
```

### 4.2 获取撤回配置

#### 接口信息

- **请求路径**: `/chat/recall/config`
- **请求方法**: `GET`
- **接口描述**: 获取用户的撤回配置（优先返回用户配置，否则返回全局配置）

#### 权限说明

- 用户只能查看自己的配置
- 配置优先级：用户配置 > 全局配置

#### 请求参数

##### Query参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | 是 | 用户ID |

#### 请求示例

```http
GET /api/v1/chat/recall/config?userId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

#### 成功响应示例

##### 用户配置

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "configType": "USER",
    "targetId": 1,
    "recallTimeLimit": 180,
    "allowRecall": true,
    "maxRecallTimes": 20,
    "status": "ACTIVE",
    "createTime": "2026-01-13T08:00:00",
    "updateTime": "2026-01-13T09:00:00",
    "remark": "用户1的撤回配置：3分钟内可撤回，每日最多20次"
  }
}
```

##### 全局配置

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "configType": "GLOBAL",
    "targetId": null,
    "recallTimeLimit": 120,
    "allowRecall": true,
    "maxRecallTimes": 50,
    "status": "ACTIVE",
    "createTime": "2026-01-12T00:00:00",
    "updateTime": "2026-01-12T00:00:00",
    "remark": "全局默认撤回配置：2分钟内可撤回，每日最多50次"
  }
}
```

#### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | Long | 配置ID |
| configType | String | 配置类型：GLOBAL, USER, ROLE |
| targetId | Long | 目标ID（用户ID或角色ID，GLOBAL类型为null） |
| recallTimeLimit | Integer | 撤回时间限制（秒） |
| allowRecall | Boolean | 是否允许撤回 |
| maxRecallTimes | Integer | 每日最大撤回次数 |
| status | String | 配置状态：ACTIVE, DISABLED |
| createTime | DateTime | 创建时间 |
| updateTime | DateTime | 更新时间 |
| remark | String | 备注说明 |

#### 错误响应示例

```json
{
  "code": 400,
  "message": "撤回配置不存在",
  "data": null
}
```

#### 注意事项

1. **配置优先级**：
   - 用户配置优先于全局配置
   - 如果没有用户配置，使用全局配置
   - 配置类型必须为GLOBAL或USER

2. **撤回限制**：
   - recallTimeLimit：撤回时间限制（秒）
   - maxRecallTimes：每日最大撤回次数
   - allowRecall：是否允许撤回

3. **配置管理**：
   - 全局配置影响所有用户
   - 用户配置仅影响指定用户
   - 建议提供配置管理界面

4. **数据验证**：
   - recallTimeLimit必须为正整数
   - maxRecallTimes必须为正整数
   - USER类型必须提供targetId

5. **前端展示**：
   - 显示当前撤回配置
   - 显示今日已撤回次数
   - 提供配置修改入口

---

## 5. 通用说明

### 5.1 数据格式要求

#### 时间格式

所有时间参数使用ISO 8601格式：

```
2026-01-13T09:00:00
```

#### 消息类型

| 类型 | 说明 | content字段 | fileId字段 |
|------|------|------------|------------|
| TEXT | 文本消息 | 必填 | 可选 |
| IMAGE | 图片消息 | 可选 | 必填 |
| FILE | 文件消息 | 可选 | 必填 |
| VOICE | 语音消息 | 可选 | 必填 |
| VIDEO | 视频消息 | 可选 | 必填 |

#### 配置类型

| 类型 | 说明 | targetId字段 |
|------|------|--------------|
| GLOBAL | 全局配置 | null |
| USER | 用户配置 | 用户ID |
| ROLE | 角色配置 | 角色ID（预留） |

### 5.2 权限控制说明

#### 会话权限

- 用户只能访问自己参与的会话
- 会话参与者：userId1或userId2等于当前用户ID
- 搜索、回复、转发都需要验证会话权限

#### 消息权限

- 用户只能删除自己发送的消息
- 用户只能撤回自己发送的消息
- 用户只能回复自己会话中的消息

#### 配置权限

- 全局配置需要管理员权限
- 用户配置只能操作自己的配置
- 配置查看需要验证用户身份

### 5.3 数据验证规则

#### 必填字段验证

- conversationId：必须存在且用户为参与者
- replyToMessageId：必须存在且未被删除
- targetConversationId：必须存在且用户为参与者
- messageIds：必须全部存在且未被删除

#### 数据格式验证

- pageNum：必须为正整数，默认1
- pageSize：必须为正整数，默认20，最大100
- recallTimeLimit：必须为正整数，单位秒
- maxRecallTimes：必须为正整数

#### 业务逻辑验证

- senderId不能等于receiverId
- startTime必须早于endTime（如果同时提供）
- configType为USER时必须提供targetId

### 5.4 分页机制

#### 分页参数

- pageNum：页码，从1开始
- pageSize：每页大小，建议不超过100
- 返回total总记录数

#### 分页建议

- 初始加载第一页
- 向上滚动加载更多
- 实现无限滚动或分页按钮
- 缓存已加载的数据

### 5.5 性能优化建议

#### 搜索优化

- 避免空关键词搜索
- 结合时间范围缩小结果
- 使用前端搜索缓存
- 限制单次搜索数量

#### 消息加载

- 分批加载历史消息
- 实现虚拟滚动
- 使用懒加载图片
- 压缩大文件

#### WebSocket优化

- 批量处理消息
- 避免频繁重连
- 实现消息队列
- 处理网络异常

---

## 6. 错误码说明

### 6.1 业务错误码

| 错误码 | 说明 | 解决方案 |
|--------|------|---------|
| 10001 | 用户不存在 | 检查用户ID是否正确 |
| 10002 | 消息不存在 | 检查消息ID是否正确 |
| 10003 | 会话不存在 | 检查会话ID是否正确 |
| 10004 | 不能与自己创建会话 | 选择其他用户 |
| 10005 | 不能给自己发送消息 | 选择其他接收者 |
| 10006 | 消息已被撤回 | 无法操作已撤回的消息 |
| 10007 | 超过撤回时间限制 | 在允许时间内撤回 |
| 10008 | 无权操作此消息 | 检查消息所有权 |
| 10009 | 无权操作此会话 | 检查会话参与者身份 |
| 10010 | 被回复的消息不存在 | 检查replyToMessageId |
| 10011 | 要转发的消息不存在 | 检查messageIds |
| 10012 | 无权转发到此会话 | 检查目标会话参与者身份 |
| 10013 | 用户配置必须指定用户ID | 提供targetId参数 |
| 10014 | 不支持的配置类型 | 使用GLOBAL或USER |
| 10015 | 撤回配置不存在 | 检查配置是否存在 |
| 10016 | 超过每日撤回次数限制 | 次日再试或联系管理员 |
| 10017 | 撤回功能已禁用 | 联系管理员启用 |

### 6.2 HTTP状态码

| 状态码 | 说明 | 常见原因 |
|--------|------|---------|
| 200 | 请求成功 | - |
| 400 | 请求参数错误 | 参数缺失、格式错误、业务验证失败 |
| 401 | 未授权 | Token无效或过期 |
| 403 | 禁止访问 | 无权限访问资源 |
| 404 | 资源不存在 | 会话、消息、配置不存在 |
| 500 | 服务器内部错误 | 系统异常 |

### 6.3 错误处理建议

#### 前端错误处理

```javascript
async function callApi(url, data) {
    try {
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + getToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        });

        const result = await response.json();

        if (result.code === 200) {
            return result.data;
        } else {
            handleError(result.code, result.message);
            throw new Error(result.message);
        }
    } catch (error) {
        console.error('API调用失败:', error);
        showErrorMessage('网络错误，请稍后重试');
    }
}

function handleError(code, message) {
    switch (code) {
        case 401:
            showErrorMessage('登录已过期，请重新登录');
            redirectToLogin();
            break;
        case 403:
            showErrorMessage('无权限访问');
            break;
        case 404:
            showErrorMessage('资源不存在');
            break;
        case 10007:
            showErrorMessage('超过撤回时间限制');
            break;
        case 10016:
            showErrorMessage('超过每日撤回次数限制');
            break;
        default:
            showErrorMessage(message || '操作失败，请稍后重试');
    }
}
```

---

## 7. 前端集成示例

### 7.1 消息搜索示例

```javascript
async function searchMessages(conversationId, keyword) {
    const request = {
        conversationId: conversationId,
        keyword: keyword,
        pageNum: 1,
        pageSize: 20
    };

    const response = await fetch('/api/v1/chat/messages/search?userId=' + currentUserId, {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + getToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(request)
    });

    const result = await response.json();
    if (result.code === 200) {
        const messages = result.data.records;
        renderMessages(messages);
    }
}

// 使用示例
document.getElementById('searchInput').addEventListener('input', debounce(async (e) => {
    const keyword = e.target.value;
    if (keyword.length >= 2) {
        await searchMessages(currentConversationId, keyword);
    }
}, 300));
```

### 7.2 消息回复示例

```javascript
async function replyMessage(replyToMessageId, content) {
    const request = {
        replyToMessageId: replyToMessageId,
        receiverId: receiverUserId,
        messageType: 'TEXT',
        content: content
    };

    const response = await fetch('/api/v1/chat/messages/reply?senderId=' + currentUserId, {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + getToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(request)
    });

    const result = await response.json();
    if (result.code === 200) {
        const message = result.data;
        addMessageToChat(message);
    }
}

// 使用示例
document.getElementById('replyButton').addEventListener('click', async () => {
    const content = document.getElementById('replyInput').value;
    if (content.trim()) {
        await replyMessage(originalMessageId, content);
    }
});
```

### 7.3 消息转发示例

```javascript
async function forwardMessages(messageIds, targetConversationId, comment) {
    const request = {
        targetConversationId: targetConversationId,
        targetReceiverId: targetReceiverId,
        messageIds: messageIds,
        forwardComment: comment
    };

    const response = await fetch('/api/v1/chat/messages/forward?senderId=' + currentUserId, {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer ' + getToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(request)
    });

    const result = await response.json();
    if (result.code === 200) {
        const messages = result.data;
        showSuccessMessage('转发成功');
        switchToConversation(targetConversationId);
    }
}

// 使用示例
document.getElementById('forwardButton').addEventListener('click', async () => {
    const selectedMessages = getSelectedMessages();
    const targetConversationId = document.getElementById('targetConversation').value;
    const comment = document.getElementById('forwardComment').value;

    if (selectedMessages.length > 0) {
        await forwardMessages(selectedMessages, targetConversationId, comment);
    }
});
```

### 7.4 撤回配置管理示例

```javascript
async function getRecallConfig() {
    const response = await fetch('/api/v1/chat/recall/config?userId=' + currentUserId, {
        method: 'GET',
        headers: {
            'Authorization': 'Bearer ' + getToken()
        }
    });

    const result = await response.json();
    if (result.code === 200) {
        const config = result.data;
        renderRecallConfig(config);
    }
}

async function updateRecallConfig(config) {
    const response = await fetch('/api/v1/chat/recall/config', {
        method: 'PUT',
        headers: {
            'Authorization': 'Bearer ' + getToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(config)
    });

    const result = await response.json();
    if (result.code === 200) {
        showSuccessMessage('配置更新成功');
        await getRecallConfig();
    }
}

// 使用示例
document.getElementById('saveConfigButton').addEventListener('click', async () => {
    const config = {
        configType: 'USER',
        targetId: currentUserId,
        recallTimeLimit: parseInt(document.getElementById('recallTimeLimit').value),
        allowRecall: document.getElementById('allowRecall').checked,
        maxRecallTimes: parseInt(document.getElementById('maxRecallTimes').value)
    };

    await updateRecallConfig(config);
});
```

### 7.5 完整聊天组件示例（React）

```javascript
import React, { useState, useEffect, useRef } from 'react';
import { debounce } from 'lodash';

function ChatComponent({ conversationId, currentUserId, receiverId }) {
    const [messages, setMessages] = useState([]);
    const [searchResults, setSearchResults] = useState([]);
    const [isSearching, setIsSearching] = useState(false);
    const [replyToMessage, setReplyToMessage] = useState(null);
    const [selectedMessages, setSelectedMessages] = useState([]);
    const messagesEndRef = useRef(null);

    useEffect(() => {
        loadMessages();
    }, [conversationId]);

    const loadMessages = async () => {
        const response = await fetch(`/api/v1/chat/messages?conversationId=${conversationId}&pageNum=1&pageSize=20`, {
            headers: { 'Authorization': 'Bearer ' + getToken() }
        });
        const result = await response.json();
        if (result.code === 200) {
            setMessages(result.data.records);
        }
    };

    const searchMessages = debounce(async (keyword) => {
        if (keyword.length < 2) {
            setSearchResults([]);
            setIsSearching(false);
            return;
        }

        setIsSearching(true);
        const response = await fetch(`/api/v1/chat/messages/search?userId=${currentUserId}`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + getToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                conversationId,
                keyword,
                pageNum: 1,
                pageSize: 20
            })
        });
        const result = await response.json();
        if (result.code === 200) {
            setSearchResults(result.data.records);
        }
    }, 300);

    const handleReply = async (content) => {
        const response = await fetch(`/api/v1/chat/messages/reply?senderId=${currentUserId}`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + getToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                replyToMessageId: replyToMessage.id,
                receiverId,
                messageType: 'TEXT',
                content
            })
        });
        const result = await response.json();
        if (result.code === 200) {
            setMessages([...messages, result.data]);
            setReplyToMessage(null);
        }
    };

    const handleForward = async (targetConversationId, comment) => {
        const response = await fetch(`/api/v1/chat/messages/forward?senderId=${currentUserId}`, {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ' + getToken(),
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                targetConversationId,
                targetReceiverId: receiverId,
                messageIds: selectedMessages,
                forwardComment: comment
            })
        });
        const result = await response.json();
        if (result.code === 200) {
            showSuccessMessage('转发成功');
            setSelectedMessages([]);
        }
    };

    const renderMessage = (message) => (
        <div key={message.id} className={`message ${message.senderId === currentUserId ? 'sent' : 'received'}`}>
            {message.replyToMessageId && (
                <div className="reply-preview">
                    <span className="reply-sender">{message.replyToSenderName}:</span>
                    <span className="reply-content">{message.replyToContent}</span>
                </div>
            )}
            {message.isForwarded && (
                <div className="forward-badge">
                    <span>转发自 {message.forwardedFromSenderName}</span>
                </div>
            )}
            <div className="message-content">
                {message.messageType === 'TEXT' ? message.content : renderFileMessage(message)}
            </div>
            <div className="message-time">
                {formatTime(message.createTime)}
                {message.isRecalled && <span className="recalled-badge">已撤回</span>}
            </div>
        </div>
    );

    return (
        <div className="chat-container">
            <div className="search-bar">
                <input
                    type="text"
                    placeholder="搜索消息..."
                    onChange={(e) => searchMessages(e.target.value)}
                />
            </div>

            {isSearching ? (
                <div className="search-results">
                    {searchResults.map(renderMessage)}
                </div>
            ) : (
                <div className="messages">
                    {messages.map(renderMessage)}
                </div>
            )}

            {replyToMessage && (
                <div className="reply-box">
                    <div className="reply-preview">
                        回复 {replyToMessage.senderName}: {replyToMessage.content}
                    </div>
                    <textarea
                        placeholder="输入回复内容..."
                        autoFocus
                    />
                    <div className="reply-actions">
                        <button onClick={() => setReplyToMessage(null)}>取消</button>
                        <button onClick={() => handleReply(document.querySelector('.reply-box textarea').value)}>发送</button>
                    </div>
                </div>
            )}

            {selectedMessages.length > 0 && (
                <div className="forward-box">
                    <div className="selected-count">
                        已选择 {selectedMessages.length} 条消息
                    </div>
                    <select>
                        <option value="">选择目标会话</option>
                    </select>
                    <textarea placeholder="转发评论（可选）" />
                    <button onClick={() => handleForward(targetConversationId, comment)}>转发</button>
                    <button onClick={() => setSelectedMessages([])}>取消</button>
                </div>
            )}
        </div>
    );
}

export default ChatComponent;
```

### 7.6 完整聊天组件示例（Vue）

```javascript
<template>
  <div class="chat-container">
    <div class="search-bar">
      <input
        type="text"
        v-model="searchKeyword"
        placeholder="搜索消息..."
        @input="handleSearch"
      />
    </div>

    <div v-if="isSearching" class="search-results">
      <div v-for="message in searchResults" :key="message.id" class="message">
        <div v-if="message.replyToMessageId" class="reply-preview">
          <span class="reply-sender">{{ message.replyToSenderName }}:</span>
          <span class="reply-content">{{ message.replyToContent }}</span>
        </div>
        <div v-if="message.isForwarded" class="forward-badge">
          <span>转发自 {{ message.forwardedFromSenderName }}</span>
        </div>
        <div class="message-content">
          {{ message.messageType === 'TEXT' ? message.content : renderFileMessage(message) }}
        </div>
        <div class="message-time">
          {{ formatTime(message.createTime) }}
          <span v-if="message.isRecalled" class="recalled-badge">已撤回</span>
        </div>
      </div>
    </div>

    <div v-else class="messages">
      <div v-for="message in messages" :key="message.id" class="message">
        <div v-if="message.replyToMessageId" class="reply-preview">
          <span class="reply-sender">{{ message.replyToSenderName }}:</span>
          <span class="reply-content">{{ message.replyToContent }}</span>
        </div>
        <div v-if="message.isForwarded" class="forward-badge">
          <span>转发自 {{ message.forwardedFromSenderName }}</span>
        </div>
        <div class="message-content">
          {{ message.messageType === 'TEXT' ? message.content : renderFileMessage(message) }}
        </div>
        <div class="message-time">
          {{ formatTime(message.createTime) }}
          <span v-if="message.isRecalled" class="recalled-badge">已撤回</span>
        </div>
      </div>
    </div>

    <div v-if="replyToMessage" class="reply-box">
      <div class="reply-preview">
        回复 {{ replyToMessage.senderName }}: {{ replyToMessage.content }}
      </div>
      <textarea
        v-model="replyContent"
        placeholder="输入回复内容..."
        ref="replyInput"
      ></textarea>
      <div class="reply-actions">
        <button @click="cancelReply">取消</button>
        <button @click="sendReply">发送</button>
      </div>
    </div>

    <div v-if="selectedMessages.length > 0" class="forward-box">
      <div class="selected-count">
        已选择 {{ selectedMessages.length }} 条消息
      </div>
      <select v-model="targetConversationId">
        <option value="">选择目标会话</option>
      </select>
      <textarea v-model="forwardComment" placeholder="转发评论（可选）"></textarea>
      <button @click="forwardMessages">转发</button>
      <button @click="cancelForward">取消</button>
    </div>
  </div>
</template>

<script>
import { debounce } from 'lodash';

export default {
  name: 'ChatComponent',
  props: {
    conversationId: Number,
    currentUserId: Number,
    receiverId: Number
  },
  data() {
    return {
      messages: [],
      searchResults: [],
      searchKeyword: '',
      isSearching: false,
      replyToMessage: null,
      replyContent: '',
      selectedMessages: [],
      targetConversationId: null,
      forwardComment: ''
    };
  },
  mounted() {
    this.loadMessages();
  },
  methods: {
    async loadMessages() {
      const response = await fetch(`/api/v1/chat/messages?conversationId=${this.conversationId}&pageNum=1&pageSize=20`, {
        headers: { 'Authorization': 'Bearer ' + this.getToken() }
      });
      const result = await response.json();
      if (result.code === 200) {
        this.messages = result.data.records;
      }
    },
    handleSearch: debounce(async function() {
      if (this.searchKeyword.length < 2) {
        this.searchResults = [];
        this.isSearching = false;
        return;
      }

      this.isSearching = true;
      const response = await fetch(`/api/v1/chat/messages/search?userId=${this.currentUserId}`, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + this.getToken(),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          conversationId: this.conversationId,
          keyword: this.searchKeyword,
          pageNum: 1,
          pageSize: 20
        })
      });
      const result = await response.json();
      if (result.code === 200) {
        this.searchResults = result.data.records;
      }
    }, 300),
    async sendReply() {
      const response = await fetch(`/api/v1/chat/messages/reply?senderId=${this.currentUserId}`, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + this.getToken(),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          replyToMessageId: this.replyToMessage.id,
          receiverId: this.receiverId,
          messageType: 'TEXT',
          content: this.replyContent
        })
      });
      const result = await response.json();
      if (result.code === 200) {
        this.messages.push(result.data);
        this.replyToMessage = null;
        this.replyContent = '';
      }
    },
    cancelReply() {
      this.replyToMessage = null;
      this.replyContent = '';
    },
    async forwardMessages() {
      const response = await fetch(`/api/v1/chat/messages/forward?senderId=${this.currentUserId}`, {
        method: 'POST',
        headers: {
          'Authorization': 'Bearer ' + this.getToken(),
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          targetConversationId: this.targetConversationId,
          targetReceiverId: this.receiverId,
          messageIds: this.selectedMessages,
          forwardComment: this.forwardComment
        })
      });
      const result = await response.json();
      if (result.code === 200) {
        this.$message.success('转发成功');
        this.selectedMessages = [];
        this.targetConversationId = null;
        this.forwardComment = '';
      }
    },
    cancelForward() {
      this.selectedMessages = [];
      this.targetConversationId = null;
      this.forwardComment = '';
    },
    getToken() {
      return localStorage.getItem('token');
    },
    formatTime(time) {
      return new Date(time).toLocaleString();
    },
    renderFileMessage(message) {
      return `[${message.messageType}] ${message.fileName}`;
    }
  }
};
</script>
```

---

## 附录

### A. 完整API列表

| 序号 | 接口名称 | 请求方法 | 请求路径 |
|------|---------|---------|---------|
| 1 | 搜索消息 | POST | /chat/messages/search |
| 2 | 回复消息 | POST | /chat/messages/reply |
| 3 | 转发消息 | POST | /chat/messages/forward |
| 4 | 更新撤回配置 | PUT | /chat/recall/config |
| 5 | 获取撤回配置 | GET | /chat/recall/config |

### B. 数据库表结构

#### tb_chat_message 新增字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| reply_to_message_id | BIGINT | 回复的消息ID |
| reply_to_content | TEXT | 被回复消息的内容快照 |
| reply_to_sender_id | BIGINT | 被回复消息的发送者ID |
| reply_to_sender_name | VARCHAR(100) | 被回复消息的发送者名称 |
| is_forwarded | TINYINT(1) | 是否为转发消息 |
| forwarded_from_message_id | BIGINT | 转发源消息ID |
| forwarded_from_conversation_id | BIGINT | 转发源会话ID |
| forwarded_from_sender_id | BIGINT | 转发源消息发送者ID |
| forwarded_from_sender_name | VARCHAR(100) | 转发源消息发送者名称 |

#### tb_message_recall_config

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 配置ID |
| config_type | VARCHAR(50) | 配置类型：GLOBAL, USER, ROLE |
| target_id | BIGINT | 目标ID |
| recall_time_limit | INT | 撤回时间限制（秒） |
| allow_recall | TINYINT(1) | 是否允许撤回 |
| max_recall_times | INT | 每日最大撤回次数 |
| status | VARCHAR(20) | 配置状态 |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |
| remark | VARCHAR(500) | 备注 |

#### tb_user_recall_record

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 记录ID |
| user_id | BIGINT | 用户ID |
| recall_date | DATE | 撤回日期 |
| recall_count | INT | 撤回次数 |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |

### C. 前端开发检查清单

- [ ] 实现消息搜索功能（关键词、发送者、时间范围）
- [ ] 实现消息回复功能（显示引用、发送回复）
- [ ] 实现消息转发功能（单条/批量、带评论）
- [ ] 实现撤回配置管理（查看、更新配置）
- [ ] 实现消息状态展示（已读、撤回、转发标识）
- [ ] 实现错误处理（统一错误处理、友好提示）
- [ ] 实现分页加载（无限滚动、分页按钮）
- [ ] 实现性能优化（防抖、缓存、懒加载）
- [ ] 实现权限验证（会话权限、消息权限）
- [ ] 实现数据验证（参数验证、格式验证）

---

**文档结束**

如有疑问，请联系后端开发人员。
