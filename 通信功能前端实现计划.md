# 通信功能前端实现计划

## 项目概述
基于现有Vue-Vben-Admin项目，实现完整的即时通信功能，包括联系人管理、实时聊天、文件传输等功能。

## 技术栈
- **前端框架**: Vue 3 + Composition API
- **UI组件库**: Element Plus
- **状态管理**: Pinia
- **路由**: Vue Router
- **HTTP请求**: Axios
- **实时通信**: Socket.IO客户端
- **构建工具**: Vite
- **样式**: Tailwind CSS

## 功能模块

### 1. 联系人管理模块

#### 功能需求
- 联系人列表展示（系统用户 + 手动添加）
- 联系人搜索和筛选
- 联系人分组管理
- 联系人信息编辑
- 在线状态显示
- 聊天置顶功能

#### 页面设计
- **联系人列表页**: 左侧联系人列表，右侧联系人详情
- **联系人详情页**: 显示完整联系人信息
- **联系人编辑页**: 新增/编辑联系人信息

#### 数据结构
```typescript
interface Contact {
  id: number;
  userId: number; // 所属用户ID
  contactUserId?: number; // 如果是系统用户
  name: string;
  phone: string;
  email: string;
  idCard: string;
  avatar: string;
  description: string;
  isSystemUser: boolean;
  groupId?: number; // 分组ID
  isOnline: boolean; // 在线状态
  lastOnlineTime?: Date; // 最后在线时间
  isPinned: boolean; // 是否置顶
  createdAt: Date;
  updatedAt: Date;
}

interface ContactGroup {
  id: number;
  userId: number;
  name: string;
  sortOrder: number;
  color?: string; // 分组颜色
}
```

### 2. 实时聊天模块

#### 功能需求
- 实时消息收发
- 消息类型支持（文本、图片、文件）
- 消息状态管理（发送中、已发送、已读）
- 消息撤回（2分钟内）
- 聊天记录搜索
- 消息通知
- 文件上传下载

#### 页面设计
- **聊天主页面**: 左侧联系人列表，右侧聊天窗口
- **聊天窗口**: 消息展示区 + 消息输入区
- **文件预览页**: 文件查看和下载

#### 数据结构
```typescript
interface ChatMessage {
  id: number;
  senderId: number;
  receiverId: number;
  messageType: 'text' | 'image' | 'file' | 'system';
  content: string;
  fileUrl?: string;
  fileName?: string;
  fileSize?: number;
  thumbnailUrl?: string; // 图片缩略图
  isRecalled: boolean;
  recallTime?: Date;
  readStatus: boolean;
  timestamp: Date;
  status: 'sending' | 'sent' | 'failed'; // 消息状态
}

interface ChatSession {
  contactId: number;
  lastMessage: ChatMessage;
  unreadCount: number;
  isPinned: boolean;
  lastActivityTime: Date;
}
```

### 3. WebSocket通信模块

#### 功能需求
- 建立和维护WebSocket连接
- 消息实时推送
- 连接状态管理
- 自动重连机制
- 心跳检测

#### 实现方案
```typescript
class ChatWebSocket {
  private socket: Socket | null = null;
  private isConnected: boolean = false;
  private reconnectAttempts: number = 0;
  private maxReconnectAttempts: number = 5;

  // 连接WebSocket
  connect(token: string): void;
  
  // 发送消息
  sendMessage(message: Partial<ChatMessage>): void;
  
  // 处理接收消息
  handleMessage(message: ChatMessage): void;
  
  // 处理连接状态变化
  handleConnectionChange(status: boolean): void;
  
  // 重连机制
  reconnect(): void;
}
```

### 4. 文件管理模块

#### 功能需求
- 文件上传（支持拖拽、进度显示）
- 文件预览（图片、PDF、文档等）
- 文件下载
- 文件大小和类型限制
- 文件分片上传（大文件支持）

#### 实现方案
```typescript
interface FileUpload {
  id: string;
  file: File;
  progress: number;
  status: 'uploading' | 'success' | 'error';
  url?: string;
  error?: string;
}

class FileManager {
  // 上传文件
  uploadFile(file: File, onProgress?: (progress: number) => void): Promise<string>;
  
  // 预览文件
  previewFile(url: string, type: string): void;
  
  // 下载文件
  downloadFile(url: string, filename: string): void;
}
```

## 页面路由设计

```typescript
const routes = [
  {
    path: '/chat',
    name: 'Chat',
    component: ChatLayout,
    children: [
      {
        path: '',
        name: 'ChatHome',
        component: ChatHome,
      },
      {
        path: 'contact/:id',
        name: 'ChatDetail',
        component: ChatDetail,
      },
      {
        path: 'contacts',
        name: 'ContactManagement',
        component: ContactManagement,
      },
      {
        path: 'contacts/add',
        name: 'ContactAdd',
        component: ContactEdit,
      },
      {
        path: 'contacts/edit/:id',
        name: 'ContactEdit',
        component: ContactEdit,
      },
    ],
  },
];
```

## 组件结构设计

```
src/views/chat/
├── components/
│   ├── ChatLayout.vue          # 聊天主布局
│   ├── ContactList.vue         # 联系人列表
│   ├── ChatWindow.vue          # 聊天窗口
│   ├── MessageList.vue         # 消息列表
│   ├── MessageInput.vue        # 消息输入框
│   ├── FileUpload.vue          # 文件上传组件
│   ├── ContactCard.vue         # 联系人卡片
│   └── SearchBar.vue           # 搜索栏
├── pages/
│   ├── ChatHome.vue            # 聊天主页
│   ├── ChatDetail.vue          # 聊天详情页
│   ├── ContactManagement.vue   # 联系人管理页
│   └── ContactEdit.vue         # 联系人编辑页
└── stores/
    ├── chat.ts                 # 聊天状态管理
    ├── contact.ts              # 联系人状态管理
    └── websocket.ts            # WebSocket状态管理
```

## API接口设计

### 联系人相关
- `GET /api/contacts` - 获取联系人列表
- `POST /api/contacts` - 新增联系人
- `PUT /api/contacts/:id` - 修改联系人
- `DELETE /api/contacts/:id` - 删除联系人
- `GET /api/contacts/search` - 搜索联系人
- `GET /api/contact-groups` - 获取分组列表
- `POST /api/contact-groups` - 新增分组
- `PUT /api/contact-groups/:id` - 修改分组

### 聊天相关
- `GET /api/messages/:contactId` - 获取聊天记录
- `POST /api/messages` - 发送消息（备用，主要用WebSocket）
- `PUT /api/messages/:id/recall` - 撤回消息
- `GET /api/messages/search` - 搜索聊天记录

### 文件相关
- `POST /api/files/upload` - 上传文件
- `GET /api/files/:id` - 下载文件
- `DELETE /api/files/:id` - 删除文件

## 状态管理设计

### Chat Store
```typescript
interface ChatState {
  // 当前聊天会话
  currentContact: Contact | null;
  // 聊天会话列表
  sessions: ChatSession[];
  // 当前聊天消息
  messages: ChatMessage[];
  // WebSocket连接状态
  isConnected: boolean;
  // 未读消息总数
  totalUnread: number;
}
```

### Contact Store
```typescript
interface ContactState {
  // 联系人列表
  contacts: Contact[];
  // 联系人分组
  groups: ContactGroup[];
  // 搜索关键词
  searchKeyword: string;
  // 选中的分组
  selectedGroup: number | null;
}
```

## 实现优先级

### 第一阶段（核心功能）
1. 联系人列表展示和基本操作
2. 实时文本消息收发
3. WebSocket连接管理
4. 消息状态显示

### 第二阶段（增强功能）
1. 文件上传下载
2. 图片消息支持
3. 消息撤回功能
4. 聊天记录搜索

### 第三阶段（优化功能）
1. 联系人分组管理
2. 聊天置顶功能
3. 消息通知优化
4. 性能优化和错误处理

## 技术难点和解决方案

### 1. WebSocket连接稳定性
- **问题**: 网络波动导致连接中断
- **方案**: 实现自动重连机制，心跳检测

### 2. 大文件上传
- **问题**: 大文件上传失败或超时
- **方案**: 分片上传，断点续传，进度显示

### 3. 消息同步
- **问题**: 多设备消息同步问题
- **方案**: 消息ID唯一性保证，时间戳排序

### 4. 性能优化
- **问题**: 大量消息渲染性能问题
- **方案**: 虚拟滚动，消息分页加载

## 测试计划

### 单元测试
- 组件功能测试
- Store状态管理测试
- 工具函数测试

### 集成测试
- 消息收发流程测试
- 文件上传下载测试
- WebSocket连接测试

### E2E测试
- 完整聊天流程测试
- 多用户并发测试
- 异常情况处理测试

## 部署和监控

### 构建优化
- 代码分割和懒加载
- 图片和文件压缩
- 缓存策略优化

### 性能监控
- WebSocket连接状态监控
- 消息发送成功率监控
- 页面加载性能监控

## 后续扩展考虑

1. **移动端适配**: 响应式设计，PWA支持
2. **语音消息**: 语音录制和播放
3. **视频通话**: WebRTC集成
4. **消息加密**: 端到端加密
5. **多语言支持**: 国际化

---

**备注**: 此文档为前端实现总体计划，具体实现时需根据实际后端接口调整。建议先完成核心功能，再逐步添加增强功能。