# 案件审批设计

## 1. 需求分析

根据审批管理中的案件审批页面需求，需要设计一个案件审批表，用于管理案件的审批流程和状态。审批页面通常需要展示案件基本信息、审批状态、审批人、审批意见等，并支持审批操作（通过/驳回）。

## 2. 数据库设计

### 2.1 表结构设计

```sql
CREATE TABLE `case_approval` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `case_id` BIGINT NOT NULL COMMENT '案件ID，关联案件表',
  `approval_type` VARCHAR(50) NOT NULL COMMENT '审批类型：如立案审批、重整计划审批等',
  `approval_node` VARCHAR(50) NOT NULL COMMENT '审批节点：如部门审批、领导审批等',
  `approval_title` VARCHAR(255) NOT NULL COMMENT '审批标题',
  `approval_content` TEXT DEFAULT NULL COMMENT '审批内容',
  `applicant` VARCHAR(50) NOT NULL COMMENT '申请人',
  `apply_time` DATETIME NOT NULL COMMENT '申请时间',
  `current_approver` VARCHAR(50) NOT NULL COMMENT '当前审批人',
  `status` TINYINT DEFAULT 0 COMMENT '审批状态：0-待审批，1-已通过，2-已驳回',
  `approval_opinion` TEXT DEFAULT NULL COMMENT '审批意见',
  `approval_time` DATETIME DEFAULT NULL COMMENT '审批时间',

  `is_finished` TINYINT DEFAULT 0 COMMENT '是否完成：0-未完成，1-已完成',
  `created_by` VARCHAR(50) NOT NULL COMMENT '创建人',
  `created_at` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `updated_by` VARCHAR(50) DEFAULT NULL COMMENT '修改人',
  `updated_at` DATETIME DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP COMMENT '修改时间',
  PRIMARY KEY (`id`),
  INDEX `idx_case_id` (`case_id`),
  INDEX `idx_status` (`status`),
  INDEX `idx_current_approver` (`current_approver`),
  INDEX `idx_approval_type` (`approval_type`),
  INDEX `idx_is_finished` (`is_finished`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='案件审批表';
```

### 2.2 表字段说明

| 字段名 | 数据类型 | 约束 | 描述 |
| --- | --- | --- | --- |
| id | BIGINT | NOT NULL AUTO_INCREMENT | 主键ID |
| case_id | BIGINT | NOT NULL | 案件ID，关联案件表 |
| approval_type | VARCHAR(50) | NOT NULL | 审批类型：如立案审批、重整计划审批等 |
| approval_node | VARCHAR(50) | NOT NULL | 审批节点：如部门审批、领导审批等 |
| approval_title | VARCHAR(255) | NOT NULL | 审批标题 |
| approval_content | TEXT | DEFAULT NULL | 审批内容 |
| applicant | VARCHAR(50) | NOT NULL | 申请人 |
| apply_time | DATETIME | NOT NULL | 申请时间 |
| current_approver | VARCHAR(50) | NOT NULL | 当前审批人 |
| status | TINYINT | DEFAULT 0 | 审批状态：0-待审批，1-已通过，2-已驳回 |
| approval_opinion | TEXT | DEFAULT NULL | 审批意见 |
| approval_time | DATETIME | DEFAULT NULL | 审批时间 |
| is_finished | TINYINT | DEFAULT 0 | 是否完成：0-未完成，1-已完成 |
| created_by | VARCHAR(50) | NOT NULL | 创建人 |
| created_at | DATETIME | NOT NULL DEFAULT CURRENT_TIMESTAMP | 创建时间 |
| updated_by | VARCHAR(50) | DEFAULT NULL | 修改人 |
| updated_at | DATETIME | DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP | 修改时间 |

## 3. 模拟数据

### 3.1 插入模拟数据SQL

```sql
-- 案件审批模拟数据
INSERT INTO `case_approval` (`case_id`, `approval_type`, `approval_node`, `approval_title`, `approval_content`, `applicant`, `apply_time`, `current_approver`, `status`, `approval_opinion`, `approval_time`, `is_finished`, `created_by`) VALUES
-- 立案审批
(1, '立案审批', '部门审批', 'XX公司破产清算案件立案审批', 'XX公司因经营不善，申请破产清算，现提交立案审批。', '张三', '2023-01-10 10:00:00', '李四', 0, NULL, NULL, 0, 'admin'),
(1, '立案审批', '法院审批', 'XX公司破产清算案件立案审批', 'XX公司因经营不善，申请破产清算，现提交法院审批。', '张三', '2023-01-12 14:30:00', '法院', 1, '同意立案', '2023-01-13 09:15:00', 1, 'admin'),

-- 重整计划审批
(2, '重整计划审批', '法院审批', 'XX公司重整计划审批', 'XX公司重整计划草案已制定完成，现提交法院审批。', '赵六', '2023-03-20 16:45:00', '法院', 2, '重整计划不符合法律规定，驳回。', '2023-04-20 15:20:00', 1, 'admin'),

-- 财产分配方案审批
(3, '财产分配方案审批', '法院审批', 'XX公司财产分配方案审批', 'XX公司财产分配方案已制定完成，现提交法院审批。', '孙七', '2023-05-25 11:00:00', '法院', 0, NULL, NULL, 0, 'admin'),

-- 案件终结审批
(4, '案件终结审批', '法院审批', 'XX公司破产案件终结审批', 'XX公司破产清算工作已完成，现提交法院终结审批。', '郑十', '2023-06-10 14:20:00', '法院', 1, '同意终结本案', '2023-06-15 16:30:00', 1, 'admin');
```

## 4. 后端接口设计

### 4.1 实体类设计

```java
import com.baomidou.mybatisplus.annotation.TableName;
import lombok.Data;

import java.io.Serializable;
import java.time.LocalDateTime;

@Data
@TableName("case_approval")
public class CaseApproval implements Serializable {
    private static final long serialVersionUID = 1L;

    private Long id;
    private Long caseId;
    private String approvalType;
    private String approvalNode;
    private String approvalTitle;
    private String approvalContent;
    private String applicant;
    private LocalDateTime applyTime;
    private String currentApprover;
    private Integer status;
    private String approvalOpinion;
    private LocalDateTime approvalTime;
    private Integer isFinished;
    private String createdBy;
    private LocalDateTime createdAt;
    private String updatedBy;
    private LocalDateTime updatedAt;
}
```

### 4.2 Mapper接口设计

```java
import com.baomidou.mybatisplus.core.mapper.BaseMapper;
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.example.demo.entity.CaseApproval;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

@Mapper
public interface CaseApprovalMapper extends BaseMapper<CaseApproval> {
    
    /**
     * 分页查询案件审批列表
     * @param page 分页参数
     * @param caseId 案件ID
     * @param approvalType 审批类型
     * @param status 审批状态
     * @param currentApprover 当前审批人
     * @return 分页结果
     */
    IPage<CaseApproval> selectApprovalPage(
            Page<CaseApproval> page,
            @Param("caseId") Long caseId,
            @Param("approvalType") String approvalType,
            @Param("status") Integer status,
            @Param("currentApprover") String currentApprover
    );
}
```

### 4.3 Service层设计

```java
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.service.IService;
import com.example.demo.entity.CaseApproval;

import java.util.Map;

public interface CaseApprovalService extends IService<CaseApproval> {
    
    /**
     * 分页查询案件审批列表
     * @param pageNum 页码
     * @param pageSize 每页条数
     * @param params 查询参数
     * @return 分页结果
     */
    IPage<CaseApproval> getApprovalPage(Integer pageNum, Integer pageSize, Map<String, Object> params);
    
    /**
     * 审批通过
     * @param id 审批ID
     * @param approver 审批人
     * @param opinion 审批意见
     * @return 是否成功
     */
    boolean approvePass(Long id, String approver, String opinion);
    
    /**
     * 审批驳回
     * @param id 审批ID
     * @param approver 审批人
     * @param opinion 审批意见
     * @return 是否成功
     */
    boolean approveReject(Long id, String approver, String opinion);
    
    /**
     * 获取案件的审批历史
     * @param caseId 案件ID
     * @return 审批历史列表
     */
    java.util.List<CaseApproval> getApprovalHistory(Long caseId);
}
```

```java
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.baomidou.mybatisplus.extension.plugins.pagination.Page;
import com.baomidou.mybatisplus.extension.service.impl.ServiceImpl;
import com.example.demo.entity.CaseApproval;
import com.example.demo.mapper.CaseApprovalMapper;
import com.example.demo.service.CaseApprovalService;
import org.springframework.stereotype.Service;

import java.time.LocalDateTime;
import java.util.Map;

@Service
public class CaseApprovalServiceImpl extends ServiceImpl<CaseApprovalMapper, CaseApproval> implements CaseApprovalService {
    
    @Override
    public IPage<CaseApproval> getApprovalPage(Integer pageNum, Integer pageSize, Map<String, Object> params) {
        Page<CaseApproval> page = new Page<>(pageNum, pageSize);
        return baseMapper.selectApprovalPage(
                page,
                (Long) params.get("caseId"),
                (String) params.get("approvalType"),
                (Integer) params.get("status"),
                (String) params.get("currentApprover")
        );
    }
    
    @Override
    public boolean approvePass(Long id, String approver, String opinion) {
        CaseApproval approval = this.getById(id);
        if (approval == null) {
            return false;
        }
        
        approval.setStatus(1); // 已通过
        approval.setApprovalOpinion(opinion);
        approval.setApprovalTime(LocalDateTime.now());
        approval.setUpdatedBy(approver);
        approval.setIsFinished(1); // 审批完成
        
        return this.updateById(approval);
    }
    
    @Override
    public boolean approveReject(Long id, String approver, String opinion) {
        CaseApproval approval = this.getById(id);
        if (approval == null) {
            return false;
        }
        
        approval.setStatus(2); // 已驳回
        approval.setApprovalOpinion(opinion);
        approval.setApprovalTime(LocalDateTime.now());
        approval.setUpdatedBy(approver);
        approval.setIsFinished(1); // 审批流程结束
        
        return this.updateById(approval);
    }
    
    @Override
    public java.util.List<CaseApproval> getApprovalHistory(Long caseId) {
        return this.lambdaQuery()
                .eq(CaseApproval::getCaseId, caseId)
                .orderByAsc(CaseApproval::getApplyTime)
                .list();
    }
}
```

### 4.4 Controller层设计

```java
import com.baomidou.mybatisplus.core.metadata.IPage;
import com.example.demo.entity.CaseApproval;
import com.example.demo.service.CaseApprovalService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.*;

import java.util.Map;

@RestController
@RequestMapping("/api/case-approval")
public class CaseApprovalController {
    
    @Autowired
    private CaseApprovalService caseApprovalService;
    
    /**
     * 分页查询案件审批列表
     * @param pageNum 页码
     * @param pageSize 每页条数
     * @param params 查询参数
     * @return 分页结果
     */
    @GetMapping("/page")
    public ResponseEntity<IPage<CaseApproval>> getApprovalPage(
            @RequestParam(defaultValue = "1") Integer pageNum,
            @RequestParam(defaultValue = "10") Integer pageSize,
            @RequestParam Map<String, Object> params) {
        return ResponseEntity.ok(caseApprovalService.getApprovalPage(pageNum, pageSize, params));
    }
    
    /**
     * 审批通过
     * @param id 审批ID
     * @param approver 审批人
     * @param opinion 审批意见
     * @return 是否成功
     */
    @PostMapping("/pass/{id}")
    public ResponseEntity<Boolean> approvePass(
            @PathVariable Long id,
            @RequestParam String approver,
            @RequestParam String opinion) {
        return ResponseEntity.ok(caseApprovalService.approvePass(id, approver, opinion));
    }
    
    /**
     * 审批驳回
     * @param id 审批ID
     * @param approver 审批人
     * @param opinion 审批意见
     * @return 是否成功
     */
    @PostMapping("/reject/{id}")
    public ResponseEntity<Boolean> approveReject(
            @PathVariable Long id,
            @RequestParam String approver,
            @RequestParam String opinion) {
        return ResponseEntity.ok(caseApprovalService.approveReject(id, approver, opinion));
    }
    
    /**
     * 获取案件的审批历史
     * @param caseId 案件ID
     * @return 审批历史列表
     */
    @GetMapping("/history/{caseId}")
    public ResponseEntity<java.util.List<CaseApproval>> getApprovalHistory(@PathVariable Long caseId) {
        return ResponseEntity.ok(caseApprovalService.getApprovalHistory(caseId));
    }
    
    /**
     * 获取单个审批详情
     * @param id 审批ID
     * @return 审批详情
     */
    @GetMapping("/{id}")
    public ResponseEntity<CaseApproval> getApprovalById(@PathVariable Long id) {
        return ResponseEntity.ok(caseApprovalService.getById(id));
    }
}
```

## 5. 审批流程设计

### 5.1 审批流程图

```
申请人提交审批 → 审批人审批 → 审批完成
     ↓                  ↓
  待审批             通过/驳回
     ↓                  ↓
  审批完成        审批完成
```

### 5.2 审批状态流转

| 当前状态 | 操作 | 下一状态 |
| --- | --- | --- |
| 待审批 | 通过 | 已通过（审批完成） |
| 待审批 | 驳回 | 已驳回（审批完成） |
| 已通过 | - | - |
| 已驳回 | - | - |

## 6. 接口调用示例

### 6.1 分页查询审批列表

```http
GET /api/case-approval/page?pageNum=1&pageSize=10&status=0&currentApprover=李四
```

### 6.2 审批通过

```http
POST /api/case-approval/pass/1?approver=李四&opinion=同意该审批
```

### 6.3 审批驳回

```http
POST /api/case-approval/reject/3?approver=王五&opinion=驳回，需补充材料
```

### 6.4 获取审批历史

```http
GET /api/case-approval/history/1
```

## 7. 注意事项

1. **审批流程灵活性**：设计时考虑了审批类型和审批节点的灵活性，可以根据不同案件类型和审批流程进行配置。
2. **审批状态一致性**：确保审批状态的流转逻辑正确，避免出现状态不一致的情况。
3. **权限控制**：在实际应用中，需要结合权限系统，确保只有授权用户才能进行审批操作。
4. **日志记录**：建议添加审批操作日志，记录每一次审批的详细信息，便于审计和追溯。
5. **性能考虑**：对于大量审批数据的查询，需要合理设计索引，优化查询性能。

## 8. 总结

本设计方案针对案件审批页面的需求，设计了一个完整的案件审批表，包含了审批流程所需的所有字段。后端接口设计支持分页查询、审批通过、审批驳回等核心功能，并提供了获取审批历史的接口。模拟数据展示了不同类型和状态的审批记录，便于测试和验证。

该设计方案具有良好的灵活性和扩展性，可以根据实际业务需求进行调整和扩展，适用于各种案件审批场景。
