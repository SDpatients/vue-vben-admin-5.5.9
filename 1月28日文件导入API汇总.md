# 1月28日文件导入API汇总

## 1. 概述

本文档描述债权登记表Excel导入功能的API接口，用于批量导入债权登记数据。前端通过上传Excel文件，后端自动解析并批量创建债权登记记录。

## 2. 基础信息

- **Base URL**: `/api/claim-registration`
- **Content-Type**: `multipart/form-data`
- **认证方式**: Bearer Token (在请求头中携带)
- **响应格式**: 统一使用 `Result` 包装

### 统一响应格式

```json
{
  "code": 200,
  "message": "success",
  "data": {}
}
```

## 3. API接口

### 3.1 Excel导入债权登记

**接口说明**: 上传Excel文件批量导入债权登记数据

**请求方式**: `POST`

**接口路径**: `/api/claim-registration/import`

**请求参数** (multipart/form-data):

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file | File | 是 | Excel文件（.xlsx或.xls格式） |
| caseId | Long | 是 | 案件ID |

**请求示例**:
```
POST /api/claim-registration/import
Content-Type: multipart/form-data

file: [二进制Excel文件数据]
caseId: 1
```

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "successCount": 8,
    "failCount": 2,
    "message": "导入完成，成功8条，失败2条",
    "errors": [
      {
        "row": 3,
        "message": "债权人名称不能为空",
        "creditorName": ""
      },
      {
        "row": 7,
        "message": "总金额必须大于0",
        "creditorName": "张三"
      }
    ]
  }
}
```

**字段说明**:

| 字段名 | 类型 | 说明 |
|--------|------|------|
| successCount | Integer | 成功导入的记录数 |
| failCount | Integer | 失败的记录数 |
| message | String | 导入结果描述 |
| errors | Array | 错误详情列表 |
| errors[].row | Integer | 错误所在的行号（从2开始，第1行为表头） |
| errors[].message | String | 错误信息 |
| errors[].creditorName | String | 债权人名称 |

**注意事项**:
- 文件大小限制：建议不超过10MB
- 支持的文件格式：.xlsx（推荐）或.xls
- Excel第一行必须是表头，从第二行开始是数据
- 导入过程中，如果某条记录失败，不会影响其他记录的导入
- 导入成功后会自动创建对应的债权审查和债权确认记录

---

## 4. Excel文件格式要求

### 4.1 表头字段映射

Excel文件的表头必须使用以下中文名称，后端会自动映射到对应的数据库字段：

| Excel列名 | 数据库字段 | 类型 | 必填 | 说明 |
|-----------|-----------|------|------|------|
| 案件名称 | caseName | String | 否 | 案件名称 |
| 债务人 | debtor | String | 否 | 债务人名称 |
| 债权人名称 | creditorName | String | 是 | 债权人名称 |
| 债权人类型 | creditorType | String | 是 | 债权人类型（如：个人/企业） |
| 统一社会信用代码 | creditCode | String | 否 | 企业信用代码 |
| 法定代表人 | legalRepresentative | String | 否 | 法定代表人姓名 |
| 送达地址 | serviceAddress | String | 否 | 送达地址 |
| 代理人姓名 | agentName | String | 否 | 代理人姓名 |
| 代理人电话 | agentPhone | String | 否 | 代理人电话 |
| 代理人身份证 | agentIdCard | String | 否 | 代理人身份证号 |
| 代理人地址 | agentAddress | String | 否 | 代理人地址 |
| 账户名称 | accountName | String | 否 | 收款账户名称 |
| 债权人银行账号 | creditorBankAccount | String | 否 | 债权人银行账号 |
| 开户行 | bankName | String | 否 | 开户银行名称 |
| 本金 | principal | BigDecimal | 否 | 债权本金 |
| 利息 | interest | BigDecimal | 否 | 债权利息 |
| 违约金 | penalty | BigDecimal | 否 | 违约金 |
| 其他损失 | otherLosses | BigDecimal | 否 | 其他损失 |
| 总金额 | totalAmount | BigDecimal | 是 | 债权总金额（必须大于0） |
| 是否有法院判决 | hasCourtJudgment | Boolean | 否 | 是/否 或 true/false 或 1/0 |
| 是否有执行 | hasExecution | Boolean | 否 | 是/否 或 true/false 或 1/0 |
| 是否有担保 | hasCollateral | Boolean | 否 | 是/否 或 true/false 或 1/0 |
| 债权性质 | claimNature | String | 否 | 债权性质 |
| 债权类型 | claimType | String | 是 | 债权类型（如：普通债权/优先债权） |
| 债权事实 | claimFacts | String | 否 | 债权事实描述 |
| 债权标识 | claimIdentifier | String | 否 | 债权唯一标识 |
| 证据清单 | evidenceList | String | 否 | 证据清单 |
| 证据材料 | evidenceMaterials | String | 否 | 证据材料描述 |
| 证据附件 | evidenceAttachments | String | 否 | 证据附件信息 |
| 登记日期 | registrationDate | DateTime | 否 | 格式：yyyy-MM-dd 或 yyyy-MM-dd HH:mm:ss |
| 登记截止日期 | registrationDeadline | DateTime | 否 | 格式：yyyy-MM-dd 或 yyyy-MM-dd HH:mm:ss |
| 材料接收人 | materialReceiver | String | 否 | 材料接收人姓名 |
| 材料接收日期 | materialReceiveDate | DateTime | 否 | 格式：yyyy-MM-dd 或 yyyy-MM-dd HH:mm:ss |
| 材料完整性 | materialCompleteness | String | 否 | 材料完整性描述 |
| 备注 | remarks | String | 否 | 备注信息 |

### 4.2 Excel模板示例

```
案件名称    债务人    债权人名称    债权人类型    统一社会信用代码    法定代表人    送达地址    代理人姓名    代理人电话    代理人身份证    代理人地址    账户名称    债权人银行账号    开户行    本金    利息    违约金    其他损失    总金额    是否有法院判决    是否有执行    是否有担保    债权性质    债权类型    债权事实    债权标识    证据清单    证据材料    证据附件    登记日期    登记截止日期    材料接收人    材料接收日期    材料完整性    备注
XX破产案    XX公司    张三    个人                    李四    13800138000                        100000    5000    1000        106000    是    否    否        普通债权    借款纠纷    2024-01-01    2024-01-15
XX破产案    XX公司    XX企业    企业    91110000XXXXXXXXXX    王五    北京市朝阳区    赵六    13900139000    110101199001011234    上海市浦东新区    XX企业    6222021234567890123    工商银行    500000    30000    5000    2000    537000    是    是    是    有担保债权    优先债权    借款合同纠纷    CLAIM20240128001    借款合同    借款凭证    附件1.pdf    2024-01-10 10:00:00    2024-01-25    管理人A    2024-01-12    完整
```

### 4.3 数据格式说明

1. **日期时间格式**：
   - 支持 `yyyy-MM-dd` 格式，如：2024-01-15
   - 支持 `yyyy-MM-dd HH:mm:ss` 格式，如：2024-01-15 10:30:00
   - 如果只提供日期，时间部分会自动设置为 00:00:00

2. **金额格式**：
   - 使用数字格式，如：100000 或 100000.50
   - 不支持货币符号（如¥、$）和千分位分隔符

3. **布尔值格式**：
   - 支持中文：是/否
   - 支持英文：true/false
   - 支持数字：1/0

4. **必填字段**：
   - 债权人名称（不能为空）
   - 债权人类型（不能为空）
   - 债权类型（不能为空）
   - 总金额（不能为空且必须大于0）

---

## 5. 前端开发指南

### 5.1 文件上传组件实现

#### 5.1.1 使用Element UI（Vue）

```vue
<template>
  <el-upload
    class="upload-demo"
    action="/api/claim-registration/import"
    :data="{ caseId: currentCaseId }"
    :headers="{ Authorization: `Bearer ${token}` }"
    :on-success="handleSuccess"
    :on-error="handleError"
    :before-upload="beforeUpload"
    :show-file-list="false"
    accept=".xlsx,.xls"
  >
    <el-button type="primary">点击上传Excel</el-button>
    <template #tip>
      <div class="el-upload__tip">
        只能上传 .xlsx 或 .xls 文件，且不超过 10MB
      </div>
    </template>
  </el-upload>
</template>

<script>
export default {
  data() {
    return {
      currentCaseId: 1,
      token: localStorage.getItem('token')
    }
  },
  methods: {
    beforeUpload(file) {
      const isExcel = file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                      file.type === 'application/vnd.ms-excel'
      const isLt10M = file.size / 1024 / 1024 < 10

      if (!isExcel) {
        this.$message.error('只能上传 Excel 文件!')
        return false
      }
      if (!isLt10M) {
        this.$message.error('上传文件大小不能超过 10MB!')
        return false
      }
      return true
    },
    handleSuccess(response) {
      if (response.code === 200) {
        const { successCount, failCount, errors } = response.data
        this.$message.success(`导入完成，成功${successCount}条，失败${failCount}条`)
        
        if (failCount > 0) {
          this.showErrorDialog(errors)
        }
        
        this.$emit('import-complete')
      } else {
        this.$message.error(response.message || '导入失败')
      }
    },
    handleError(error) {
      this.$message.error('上传失败，请重试')
    },
    showErrorDialog(errors) {
      this.$alert(
        errors.map(e => `第${e.row}行：${e.message}（${e.creditorName}）`).join('\n'),
        '导入错误详情',
        {
          confirmButtonText: '确定',
          type: 'error'
        }
      )
    }
  }
}
</script>
```

#### 5.1.2 使用Ant Design（Vue）

```vue
<template>
  <a-upload
    name="file"
    :action="uploadUrl"
    :data="{ caseId: currentCaseId }"
    :headers="{ Authorization: `Bearer ${token}` }"
    :before-upload="beforeUpload"
    @change="handleChange"
    accept=".xlsx,.xls"
  >
    <a-button> <a-icon type="upload" /> 点击上传Excel </a-button>
  </a-upload>
</template>

<script>
export default {
  data() {
    return {
      currentCaseId: 1,
      token: localStorage.getItem('token'),
      uploadUrl: '/api/claim-registration/import'
    }
  },
  methods: {
    beforeUpload(file) {
      const isExcel = file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                      file.type === 'application/vnd.ms-excel'
      const isLt10M = file.size / 1024 / 1024 < 10

      if (!isExcel) {
        this.$message.error('只能上传 Excel 文件!')
        return false
      }
      if (!isLt10M) {
        this.$message.error('上传文件大小不能超过 10MB!')
        return false
      }
      return true
    },
    handleChange(info) {
      if (info.file.status === 'done') {
        const response = info.file.response
        if (response.code === 200) {
          const { successCount, failCount, errors } = response.data
          this.$message.success(`导入完成，成功${successCount}条，失败${failCount}条`)
          
          if (failCount > 0) {
            this.showErrorDialog(errors)
          }
          
          this.$emit('import-complete')
        } else {
          this.$message.error(response.message || '导入失败')
        }
      } else if (info.file.status === 'error') {
        this.$message.error('上传失败，请重试')
      }
    },
    showErrorDialog(errors) {
      this.$error({
        title: '导入错误详情',
        content: errors.map(e => `第${e.row}行：${e.message}（${e.creditorName}）`).join('\n'),
        width: 600
      })
    }
  }
}
</script>
```

#### 5.1.3 使用原生JavaScript

```javascript
async function uploadExcel(file, caseId) {
  const formData = new FormData()
  formData.append('file', file)
  formData.append('caseId', caseId)

  const token = localStorage.getItem('token')

  try {
    const response = await fetch('/api/claim-registration/import', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`
      },
      body: formData
    })

    const result = await response.json()

    if (result.code === 200) {
      const { successCount, failCount, errors } = result.data
      alert(`导入完成，成功${successCount}条，失败${failCount}条`)
      
      if (failCount > 0) {
        showErrorDialog(errors)
      }
      
      return result.data
    } else {
      alert(result.message || '导入失败')
      throw new Error(result.message)
    }
  } catch (error) {
    alert('上传失败，请重试')
    throw error
  }
}

function showErrorDialog(errors) {
  const errorMessages = errors.map(e => 
    `第${e.row}行：${e.message}（${e.creditorName}）`
  ).join('\n')
  
  alert('导入错误详情：\n' + errorMessages)
}

// 使用示例
const fileInput = document.getElementById('fileInput')
fileInput.addEventListener('change', async (e) => {
  const file = e.target.files[0]
  if (file) {
    await uploadExcel(file, 1)
  }
})
```

### 5.2 文件选择和校验

```javascript
// 文件选择处理
function handleFileSelect(event) {
  const file = event.target.files[0]
  
  if (!file) {
    return
  }
  
  // 校验文件类型
  const validTypes = [
    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
    'application/vnd.ms-excel'
  ]
  
  if (!validTypes.includes(file.type)) {
    alert('请选择Excel文件（.xlsx或.xls）')
    return
  }
  
  // 校验文件大小（10MB）
  const maxSize = 10 * 1024 * 1024
  if (file.size > maxSize) {
    alert('文件大小不能超过10MB')
    return
  }
  
  // 上传文件
  uploadExcel(file, currentCaseId)
}
```

### 5.3 导入进度显示

```javascript
// 使用axios上传并显示进度
async function uploadExcelWithProgress(file, caseId, onProgress) {
  const formData = new FormData()
  formData.append('file', file)
  formData.append('caseId', caseId)

  const token = localStorage.getItem('token')

  try {
    const response = await axios.post('/api/claim-registration/import', formData, {
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'multipart/form-data'
      },
      onUploadProgress: (progressEvent) => {
        const percentCompleted = Math.round(
          (progressEvent.loaded * 100) / progressEvent.total
        )
        onProgress(percentCompleted)
      }
    })

    const result = response.data
    if (result.code === 200) {
      return result.data
    } else {
      throw new Error(result.message)
    }
  } catch (error) {
    throw error
  }
}

// 使用示例
uploadExcelWithProgress(file, 1, (percent) => {
  console.log(`上传进度：${percent}%`)
  // 更新进度条UI
})
```

### 5.4 错误处理和用户提示

```javascript
function handleImportResult(result) {
  const { successCount, failCount, errors } = result

  if (failCount === 0) {
    showSuccessMessage(`成功导入${successCount}条债权登记记录`)
  } else {
    showWarningMessage(`导入完成，成功${successCount}条，失败${failCount}条`)
    
    if (errors && errors.length > 0) {
      showDetailedErrors(errors)
    }
  }
}

function showDetailedErrors(errors) {
  const errorTable = errors.map(e => `
    <tr>
      <td>${e.row}</td>
      <td>${e.creditorName || '-'}</td>
      <td>${e.message}</td>
    </tr>
  `).join('')

  const html = `
    <table border="1" style="border-collapse: collapse; width: 100%;">
      <thead>
        <tr>
          <th>行号</th>
          <th>债权人名称</th>
          <th>错误信息</th>
        </tr>
      </thead>
      <tbody>
        ${errorTable}
      </tbody>
    </table>
  `

  // 使用模态框显示错误详情
  showModal('导入错误详情', html)
}
```

### 5.5 完整示例（Vue + Element UI）

```vue
<template>
  <div class="excel-import">
    <el-card>
      <div slot="header">
        <span>Excel导入债权登记</span>
      </div>

      <el-form :model="form" label-width="120px">
        <el-form-item label="选择案件">
          <el-select v-model="form.caseId" placeholder="请选择案件">
            <el-option
              v-for="item in caseList"
              :key="item.id"
              :label="item.caseName"
              :value="item.id"
            />
          </el-select>
        </el-form-item>

        <el-form-item label="上传Excel">
          <el-upload
            ref="upload"
            class="upload-demo"
            action="/api/claim-registration/import"
            :data="{ caseId: form.caseId }"
            :headers="{ Authorization: `Bearer ${token}` }"
            :on-success="handleSuccess"
            :on-error="handleError"
            :before-upload="beforeUpload"
            :on-progress="handleProgress"
            :show-file-list="true"
            :limit="1"
            accept=".xlsx,.xls"
            :auto-upload="false"
          >
            <el-button slot="trigger" size="small" type="primary">选择文件</el-button>
            <el-button
              style="margin-left: 10px"
              size="small"
              type="success"
              @click="submitUpload"
              :loading="uploading"
            >
              开始导入
            </el-button>
            <div slot="tip" class="el-upload__tip">
              只能上传 .xlsx 或 .xls 文件，且不超过 10MB
            </div>
          </el-upload>

          <el-progress
            v-if="uploading"
            :percentage="uploadProgress"
            :status="uploadProgress === 100 ? 'success' : null"
          />
        </el-form-item>
      </el-form>

      <el-alert
        v-if="importResult"
        :title="importResult.message"
        :type="importResult.failCount > 0 ? 'warning' : 'success'"
        :closable="false"
        style="margin-top: 20px"
      >
        <el-button
          v-if="importResult.failCount > 0"
          type="text"
          @click="showErrorDetails"
        >
          查看错误详情
        </el-button>
      </el-alert>
    </el-card>

    <el-dialog
      title="导入错误详情"
      :visible.sync="errorDialogVisible"
      width="60%"
    >
      <el-table :data="importResult.errors" border>
        <el-table-column prop="row" label="行号" width="80" />
        <el-table-column prop="creditorName" label="债权人名称" width="150" />
        <el-table-column prop="message" label="错误信息" />
      </el-table>
      <span slot="footer">
        <el-button @click="errorDialogVisible = false">关闭</el-button>
      </span>
    </el-dialog>
  </div>
</template>

<script>
export default {
  name: 'ExcelImport',
  data() {
    return {
      token: localStorage.getItem('token'),
      form: {
        caseId: null
      },
      caseList: [],
      uploading: false,
      uploadProgress: 0,
      importResult: null,
      errorDialogVisible: false
    }
  },
  created() {
    this.loadCaseList()
  },
  methods: {
    async loadCaseList() {
      try {
        const response = await this.$http.get('/api/cases')
        this.caseList = response.data.data
      } catch (error) {
        this.$message.error('加载案件列表失败')
      }
    },
    beforeUpload(file) {
      const isExcel = file.type === 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' ||
                      file.type === 'application/vnd.ms-excel'
      const isLt10M = file.size / 1024 / 1024 < 10

      if (!isExcel) {
        this.$message.error('只能上传 Excel 文件!')
        return false
      }
      if (!isLt10M) {
        this.$message.error('上传文件大小不能超过 10MB!')
        return false
      }
      if (!this.form.caseId) {
        this.$message.error('请先选择案件!')
        return false
      }
      return true
    },
    submitUpload() {
      if (!this.form.caseId) {
        this.$message.error('请先选择案件!')
        return
      }
      this.$refs.upload.submit()
    },
    handleProgress(event) {
      this.uploadProgress = Math.floor(event.percent)
    },
    handleSuccess(response) {
      this.uploading = false
      this.uploadProgress = 0

      if (response.code === 200) {
        this.importResult = response.data
        
        if (response.data.failCount === 0) {
          this.$message.success('导入成功!')
          this.$emit('import-complete')
        } else {
          this.$message.warning(`导入完成，成功${response.data.successCount}条，失败${response.data.failCount}条`)
        }
      } else {
        this.$message.error(response.message || '导入失败')
      }
    },
    handleError() {
      this.uploading = false
      this.uploadProgress = 0
      this.$message.error('上传失败，请重试')
    },
    showErrorDetails() {
      this.errorDialogVisible = true
    }
  }
}
</script>

<style scoped>
.excel-import {
  padding: 20px;
}
</style>
```

---

## 6. 常见问题

### 6.1 导入失败常见原因

| 错误信息 | 原因 | 解决方案 |
|---------|------|---------|
| 债权人名称不能为空 | Excel中债权人名称列为空 | 检查Excel数据，确保债权人名称列有值 |
| 债权人类型不能为空 | Excel中债权人类型列为空 | 检查Excel数据，填写债权人类型（个人/企业） |
| 债权类型不能为空 | Excel中债权类型列为空 | 检查Excel数据，填写债权类型 |
| 总金额必须大于0 | Excel中总金额列为空或小于等于0 | 检查Excel数据，确保总金额大于0 |
| Excel文件解析失败 | Excel文件格式不正确或已损坏 | 检查Excel文件是否可以正常打开 |
| 案件不存在 | 传入的caseId对应的案件不存在 | 检查caseId是否正确 |

### 6.2 Excel格式注意事项

1. **表头必须准确**：Excel第一行的表头必须与文档中的中文名称完全一致
2. **不要合并单元格**：避免使用合并单元格，可能导致数据解析错误
3. **日期格式**：日期列使用标准日期格式，不要使用文本格式
4. **金额格式**：金额列使用数字格式，不要包含货币符号
5. **布尔值格式**：是/否、true/false、1/0 都可以识别

### 6.3 性能优化建议

1. **分批导入**：如果数据量很大（超过1000条），建议分批上传
2. **异步处理**：对于大批量数据，可以考虑使用异步导入方式
3. **进度反馈**：上传过程中显示进度条，提升用户体验
4. **错误提示**：详细显示错误信息，方便用户修正数据

---

## 7. 错误码说明

| 错误码 | 说明 |
|--------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 403 | 无权限 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

---

## 8. 更新日志

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2026-01-28 | 初始版本，完成债权登记Excel导入API |

---

## 9. 联系方式

如有API使用问题，请联系后端开发团队。
