# 前端文件上传翻新指导文档

## 1. 概述

文件上传系统已进行全面翻新，从原来的分散式文件管理（CaseFile、CaseProcessFile、DocAttachment）统一迁移到 `t_file_record` 表进行集中管理。

### 1.1 主要变化

| 项目 | 旧方案 | 新方案 |
|------|--------|--------|
| 数据表 | 多个分散表（CaseFile、CaseProcessFile、DocAttachment） | 统一表（t_file_record） |
| API路径 | `/api/web/uploadCaseFile`、`/api/web/uploadProcessFile` 等 | `/api/file/upload` |
| 业务标识 | `moduleType`（task、process等） | `bizType`（case、process、notice等） |
| 业务ID | `SEP_ID`（字符串） | `bizId`（Long类型） |
| 文件ID | UUID字符串 | 自增Long类型 |
| 删除方式 | 物理删除 | 逻辑删除（标记删除） |

### 1.2 新增功能

- ✅ 文件哈希（MD5）用于去重和校验
- ✅ 文件扩展名和MIME类型自动识别
- ✅ 逻辑删除，支持数据恢复
- ✅ 删除审计（记录删除人和删除时间）
- ✅ 文件状态管理

---

## 2. 新的文件上传API

### 2.1 单文件上传

**接口地址：** `POST /api/file/upload`

**请求头：**
```
Content-Type: multipart/form-data
Authorization: Bearer {token}  // JWT token
```

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| file | File | 是 | 上传的文件 | - |
| bizType | String | 是 | 业务类型 | case、process、notice |
| bizId | Long | 是 | 业务ID | 123 |

**请求示例（FormData）：**
```javascript
const formData = new FormData();
formData.append('file', file);
formData.append('bizType', 'case');
formData.append('bizId', 123);

axios.post('/api/file/upload', formData, {
  headers: {
    'Content-Type': 'multipart/form-data',
    'Authorization': `Bearer ${token}`
  }
});
```

**响应示例：**
```json
{
  "status": "1",
  "msg": "文件上传成功",
  "data": {
    "id": 1,
    "originalFileName": "合同.pdf",
    "storedFileName": "a1b2c3d4-e5f6-7890-abcd-ef1234567890.pdf",
    "filePath": "case/123/a1b2c3d4-e5f6-7890-abcd-ef1234567890.pdf",
    "fileSize": 1024000,
    "fileExtension": "pdf",
    "mimeType": "application/pdf",
    "fileHash": "d41d8cd98f00b204e9800998ecf8427e",
    "bizType": "case",
    "bizId": 123,
    "uploadTime": "2025-12-27T10:30:00",
    "uploadUser": "1",
    "fileStatus": 1,
    "isDeleted": false
  }
}
```

---

### 2.2 批量文件上传

**接口地址：** `POST /api/file/batchUpload`

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| files | File[] | 是 | 上传的文件数组 |
| bizType | String | 是 | 业务类型 |
| bizId | Long | 是 | 业务ID |

**请求示例：**
```javascript
const formData = new FormData();
files.forEach(file => {
  formData.append('files', file);
});
formData.append('bizType', 'case');
formData.append('bizId', 123);

axios.post('/api/file/batchUpload', formData, {
  headers: {
    'Content-Type': 'multipart/form-data',
    'Authorization': `Bearer ${token}`
  }
});
```

**响应示例：**
```json
{
  "status": "1",
  "msg": "批量上传成功",
  "data": [
    {
      "id": 1,
      "originalFileName": "文件1.pdf",
      // ... 其他字段同单文件上传
    },
    {
      "id": 2,
      "originalFileName": "文件2.jpg",
      // ... 其他字段同单文件上传
    }
  ]
}
```

---

### 2.3 获取文件列表

**接口地址：** `GET /api/file/list`

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 | 示例 |
|--------|------|------|------|------|
| bizType | String | 是 | 业务类型 | case |
| bizId | Long | 是 | 业务ID | 123 |

**请求示例：**
```javascript
axios.get('/api/file/list', {
  params: {
    bizType: 'case',
    bizId: 123
  },
  headers: {
    'Authorization': `Bearer ${token}`
  }
});
```

**响应示例：**
```json
{
  "status": "1",
  "msg": "查询成功",
  "data": [
    {
      "id": 1,
      "originalFileName": "合同.pdf",
      "storedFileName": "a1b2c3d4-e5f6-7890-abcd-ef1234567890.pdf",
      "filePath": "case/123/a1b2c3d4-e5f6-7890-abcd-ef1234567890.pdf",
      "fileSize": 1024000,
      "fileExtension": "pdf",
      "mimeType": "application/pdf",
      "fileHash": "d41d8cd98f00b204e9800998ecf8427e",
      "bizType": "case",
      "bizId": 123,
      "uploadTime": "2025-12-27T10:30:00",
      "uploadUser": "1",
      "fileStatus": 1,
      "isDeleted": false
    }
  ]
}
```

---

### 2.4 下载文件

**接口地址：** `GET /api/file/download/{id}`

**路径参数：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | Long | 是 | 文件记录ID |

**请求示例：**
```javascript
// 方式1：直接下载
window.location.href = `/api/file/download/${fileId}`;

// 方式2：使用axios下载
axios.get(`/api/file/download/${fileId}`, {
  responseType: 'blob',
  headers: {
    'Authorization': `Bearer ${token}`
  }
}).then(response => {
  const url = window.URL.createObjectURL(new Blob([response.data]));
  const link = document.createElement('a');
  link.href = url;
  link.setAttribute('download', fileName);
  document.body.appendChild(link);
  link.click();
});
```

---

### 2.5 在线预览文件

**接口地址：** `GET /api/file/view/{id}`

**路径参数：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | Long | 是 | 文件记录ID |

**支持的文件类型：**
- PDF（.pdf）
- 图片（.jpg、.jpeg、.png、.gif）

**请求示例：**
```javascript
// 在iframe中预览
<iframe :src="`/api/file/view/${fileId}`" width="100%" height="600px"></iframe>

// 或使用新窗口打开
window.open(`/api/file/view/${fileId}`, '_blank');
```

---

### 2.6 删除文件

**接口地址：** `DELETE /api/file/{id}`

**路径参数：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | Long | 是 | 文件记录ID |

**请求示例：**
```javascript
axios.delete(`/api/file/${fileId}`, {
  headers: {
    'Authorization': `Bearer ${token}`
  }
}).then(response => {
  if (response.data.status === '1') {
    // 删除成功，刷新文件列表
  }
});
```

**注意：** 此操作为逻辑删除，不会真正删除文件，只是标记为已删除。

---

### 2.7 批量删除文件（按业务）

**接口地址：** `DELETE /api/file/byBiz`

**请求参数：**

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| bizType | String | 是 | 业务类型 |
| bizId | Long | 是 | 业务ID |

**请求示例：**
```javascript
axios.delete('/api/file/byBiz', {
  params: {
    bizType: 'case',
    bizId: 123
  },
  headers: {
    'Authorization': `Bearer ${token}`
  }
});
```

---

## 3. 业务类型（bizType）映射表

| 业务模块 | 旧moduleType | 新bizType | 说明 |
|----------|---------------|------------|------|
| 案件管理主页 | task | case | 案件相关文件 |
| 流程管理任务 | process | process | 流程任务相关文件 |
| 公告管理 | notice | notice | 公告相关文件 |

---

## 4. 迁移步骤

### 4.1 案件管理主页

**旧API：** `POST /api/web/uploadCaseFile`

**新API：** `POST /api/file/upload`

**迁移步骤：**

1. **修改上传接口调用**
```javascript
// 旧代码
const formData = new FormData();
formData.append('file', file);
formData.append('SEP_ID', caseId);
formData.append('moduleType', 'task');
axios.post('/api/web/uploadCaseFile', formData);

// 新代码
const formData = new FormData();
formData.append('file', file);
formData.append('bizType', 'case');
formData.append('bizId', caseId);
axios.post('/api/file/upload', formData);
```

2. **修改文件列表获取**
```javascript
// 旧代码
axios.get('/api/web/getCaseFiles', {
  params: { SEP_ID: caseId }
});

// 新代码
axios.get('/api/file/list', {
  params: { bizType: 'case', bizId: caseId }
});
```

3. **修改文件下载**
```javascript
// 旧代码
window.location.href = `/api/web/downloadCaseFile/${fileId}`;

// 新代码
window.location.href = `/api/file/download/${fileId}`;
```

4. **修改文件删除**
```javascript
// 旧代码
axios.delete(`/api/web/deleteCaseFile/${fileName}`);

// 新代码
axios.delete(`/api/file/${fileId}`);
```

5. **数据结构变化**
```javascript
// 旧数据结构
{
  id: "uuid-string",
  name: "文件名.pdf",
  url: "/api/web/downloadCaseFile/文件名.pdf",
  size: 1024000,
  type: "application/pdf",
  uploadTime: "2025-12-27T10:30:00"
}

// 新数据结构
{
  id: 1,  // 改为Long类型
  originalFileName: "文件名.pdf",  // 字段名变化
  storedFileName: "uuid-string.pdf",  // 新增字段
  filePath: "case/123/uuid-string.pdf",  // 新增字段
  fileSize: 1024000,
  fileExtension: "pdf",  // 新增字段
  mimeType: "application/pdf",  // 字段名变化
  fileHash: "md5-hash",  // 新增字段
  bizType: "case",  // 新增字段
  bizId: 123,  // 新增字段
  uploadTime: "2025-12-27T10:30:00",
  uploadUser: "1",
  fileStatus: 1,  // 新增字段
  isDeleted: false  // 新增字段
}
```

---

### 4.2 流程管理任务编辑页面

**旧API：** `POST /api/web/uploadProcessFile`

**新API：** `POST /api/file/upload`

**迁移步骤：**

1. **修改上传接口调用**
```javascript
// 旧代码
const formData = new FormData();
formData.append('file', file);
formData.append('SEP_ID', taskId);
formData.append('moduleType', 'process');
axios.post('/api/web/uploadProcessFile', formData);

// 新代码
const formData = new FormData();
formData.append('file', file);
formData.append('bizType', 'process');
formData.append('bizId', taskId);
axios.post('/api/file/upload', formData);
```

2. **修改文件列表获取**
```javascript
// 旧代码
axios.get('/api/web/getProcessFiles', {
  params: { taskId: taskId }
});

// 新代码
axios.get('/api/file/list', {
  params: { bizType: 'process', bizId: taskId }
});
```

3. **修改文件下载和删除**（参考案件管理主页）

---

### 4.3 公告管理

**旧API：** `POST /api/web/uploadNoticeFile`

**新API：** `POST /api/file/upload`

**迁移步骤：**

1. **修改上传接口调用**
```javascript
// 旧代码
const formData = new FormData();
formData.append('file', file);
formData.append('SEP_ID', noticeId);
axios.post('/api/web/uploadNoticeFile', formData);

// 新代码
const formData = new FormData();
formData.append('file', file);
formData.append('bizType', 'notice');
formData.append('bizId', noticeId);
axios.post('/api/file/upload', formData);
```

2. **修改文件列表获取**
```javascript
// 旧代码
axios.get('/api/web/getNoticeFiles', {
  params: { noticeId: noticeId }
});

// 新代码
axios.get('/api/file/list', {
  params: { bizType: 'notice', bizId: noticeId }
});
```

---

## 5. 未来新增模块文件上传的步骤

当需要为新的业务模块添加文件上传功能时，只需按照以下步骤操作：

### 5.1 步骤1：确定业务类型

为新模块定义一个唯一的 `bizType` 标识符。

**命名规范：**
- 使用小写字母
- 使用英文单词
- 简洁明了，能体现业务含义

**示例：**
- 案件管理：`case`
- 流程管理：`process`
- 公告管理：`notice`
- 文书管理：`document`
- 用户头像：`avatar`
- 聊天附件：`chat`

### 5.2 步骤2：调用统一上传接口

无需后端开发新的上传接口，直接使用统一的文件上传API。

```javascript
// 上传文件
const uploadFile = async (file, bizType, bizId) => {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('bizType', bizType);
  formData.append('bizId', bizId);

  const response = await axios.post('/api/file/upload', formData, {
    headers: {
      'Content-Type': 'multipart/form-data',
      'Authorization': `Bearer ${token}`
    }
  });

  return response.data.data;
};

// 使用示例
const fileRecord = await uploadFile(selectedFile, 'document', documentId);
console.log('文件ID:', fileRecord.id);
```

### 5.3 步骤3：获取文件列表

```javascript
// 获取文件列表
const getFileList = async (bizType, bizId) => {
  const response = await axios.get('/api/file/list', {
    params: { bizType, bizId },
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });

  return response.data.data;
};

// 使用示例
const files = await getFileList('document', documentId);
```

### 5.4 步骤4：文件下载和预览

```javascript
// 下载文件
const downloadFile = (fileId) => {
  window.location.href = `/api/file/download/${fileId}`;
};

// 预览文件
const previewFile = (fileId) => {
  window.open(`/api/file/view/${fileId}`, '_blank');
};
```

### 5.5 步骤5：删除文件

```javascript
// 删除单个文件
const deleteFile = async (fileId) => {
  await axios.delete(`/api/file/${fileId}`, {
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  // 刷新文件列表
};

// 删除业务相关的所有文件
const deleteAllFiles = async (bizType, bizId) => {
  await axios.delete('/api/file/byBiz', {
    params: { bizType, bizId },
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });
  // 刷新文件列表
};
```

### 5.6 完整示例组件

```vue
<template>
  <div class="file-uploader">
    <!-- 文件上传 -->
    <el-upload
      :action="uploadUrl"
      :headers="uploadHeaders"
      :data="uploadData"
      :on-success="handleUploadSuccess"
      :on-error="handleUploadError"
      :before-upload="beforeUpload"
      :file-list="fileList"
      :on-remove="handleRemove"
      multiple
    >
      <el-button type="primary">点击上传</el-button>
    </el-upload>

    <!-- 文件列表 -->
    <el-table :data="fileList" style="margin-top: 20px;">
      <el-table-column prop="originalFileName" label="文件名" />
      <el-table-column prop="fileSize" label="大小" :formatter="formatFileSize" />
      <el-table-column prop="uploadTime" label="上传时间" :formatter="formatDate" />
      <el-table-column label="操作">
        <template #default="{ row }">
          <el-button size="small" @click="downloadFile(row.id)">下载</el-button>
          <el-button size="small" @click="previewFile(row.id)">预览</el-button>
          <el-button size="small" type="danger" @click="deleteFile(row.id)">删除</el-button>
        </template>
      </el-table-column>
    </el-table>
  </div>
</template>

<script>
import { getToken } from '@/utils/auth';

export default {
  name: 'FileUploader',
  props: {
    bizType: {
      type: String,
      required: true
    },
    bizId: {
      type: Number,
      required: true
    }
  },
  data() {
    return {
      uploadUrl: '/api/file/upload',
      uploadHeaders: {
        'Authorization': `Bearer ${getToken()}`
      },
      uploadData: {
        bizType: '',
        bizId: 0
      },
      fileList: []
    };
  },
  watch: {
    bizId: {
      immediate: true,
      handler(newVal) {
        if (newVal) {
          this.uploadData.bizId = newVal;
          this.loadFileList();
        }
      }
    },
    bizType: {
      immediate: true,
      handler(newVal) {
        if (newVal) {
          this.uploadData.bizType = newVal;
        }
      }
    }
  },
  methods: {
    async loadFileList() {
      try {
        const response = await this.$http.get('/api/file/list', {
          params: {
            bizType: this.bizType,
            bizId: this.bizId
          }
        });
        this.fileList = response.data.data;
      } catch (error) {
        this.$message.error('加载文件列表失败');
      }
    },
    handleUploadSuccess(response, file, fileList) {
      if (response.status === '1') {
        this.$message.success('上传成功');
        this.loadFileList();
      } else {
        this.$message.error(response.msg);
      }
    },
    handleUploadError(error) {
      this.$message.error('上传失败');
    },
    beforeUpload(file) {
      const maxSize = 10 * 1024 * 1024; // 10MB
      if (file.size > maxSize) {
        this.$message.error('文件大小不能超过10MB');
        return false;
      }
      return true;
    },
    async handleRemove(file) {
      try {
        await this.$http.delete(`/api/file/${file.id}`);
        this.$message.success('删除成功');
        this.loadFileList();
      } catch (error) {
        this.$message.error('删除失败');
      }
    },
    downloadFile(fileId) {
      window.location.href = `/api/file/download/${fileId}`;
    },
    previewFile(fileId) {
      window.open(`/api/file/view/${fileId}`, '_blank');
    },
    formatFileSize(row) {
      const size = row.fileSize;
      if (size < 1024) {
        return size + ' B';
      } else if (size < 1024 * 1024) {
        return (size / 1024).toFixed(2) + ' KB';
      } else {
        return (size / (1024 * 1024)).toFixed(2) + ' MB';
      }
    },
    formatDate(row) {
      return new Date(row.uploadTime).toLocaleString('zh-CN');
    }
  }
};
</script>
```

---

## 6. 注意事项

### 6.1 文件大小限制

- 单个文件最大：**10MB**
- 单次请求最大：**50MB**

### 6.2 支持的文件类型

- 文档：doc、docx、pdf、txt
- 图片：jpg、png、gif
- 表格：xls、xlsx

### 6.3 认证要求

所有文件上传、下载、删除接口都需要在请求头中携带JWT token：
```
Authorization: Bearer {token}
```

### 6.4 错误处理

| 错误码 | 说明 | 处理建议 |
|---------|------|----------|
| 0 | 操作失败 | 显示错误消息 |
| 1 | 操作成功 | 刷新数据 |
| 404 | 文件不存在 | 提示用户文件已被删除 |
| 500 | 服务器错误 | 联系管理员 |

### 6.5 逻辑删除说明

删除操作不会真正删除文件记录，只是标记为 `is_deleted = 1`。如果需要恢复已删除的文件，需要后端提供恢复接口。

---

## 7. 常见问题

### Q1：文件ID从UUID字符串变成了Long类型，如何处理？

**A：** 修改前端代码中所有使用文件ID的地方，将字符串类型改为数字类型。

```javascript
// 旧代码
const fileId = 'uuid-string';

// 新代码
const fileId = 1; // Long类型
```

### Q2：如何判断文件是否可以预览？

**A：** 根据 `fileExtension` 或 `mimeType` 判断。

```javascript
const canPreview = (file) => {
  const previewableExtensions = ['pdf', 'jpg', 'jpeg', 'png', 'gif'];
  return previewableExtensions.includes(file.fileExtension);
};
```

### Q3：文件哈希有什么用？

**A：** 文件哈希可以用于：
- 去重：相同哈希值的文件是重复文件
- 校验：下载后可以重新计算哈希值，验证文件完整性

### Q4：如何实现文件去重？

**A：** 上传前先检查文件哈希是否已存在。

```javascript
const checkDuplicate = async (fileHash) => {
  const response = await this.$http.get('/api/file/check', {
    params: { fileHash }
  });
  return response.data.data.exists;
};

const beforeUpload = async (file) => {
  const fileHash = await calculateFileHash(file);
  const exists = await checkDuplicate(fileHash);
  if (exists) {
    this.$message.warning('该文件已存在，无需重复上传');
    return false;
  }
  return true;
};
```

---

## 8. 迁移检查清单

在完成文件上传功能翻新后，请检查以下项目：

- [ ] 案件管理主页文件上传功能正常
- [ ] 流程管理任务编辑页面文件上传功能正常
- [ ] 公告管理文件上传功能正常
- [ ] 文件列表显示正常
- [ ] 文件下载功能正常
- [ ] 文件预览功能正常
- [ ] 文件删除功能正常
- [ ] 批量上传功能正常
- [ ] 错误提示正常
- [ ] 文件大小限制生效
- [ ] 文件类型限制生效

---

## 9. 技术支持

如果在迁移过程中遇到问题，请联系后端开发团队。

**后端API文档：** 参考 [文件上传最新处理方案.md](./文件上传最新处理方案.md)

**数据库表结构：** 参考 [T_FILE_RECORD.sql](./T_FILE_RECORD.sql)
