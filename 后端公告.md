# 案件管理系统 - 后端公告管理

## 1. 概述

本文档描述了案件管理系统中公告管理功能的后端实现方案，包括数据模型、API接口设计、业务流程和数据库表结构设计。

## 2. 前端功能分析

### 2.1 前端组件位置
- 文件路径: `apps/web-ele/src/views/law/case-detail/index.vue:1900-1970`

### 2.2 前端数据结构
```typescript
const announcementData = reactive({
  title: '',      // 公告标题
  content: '',    // 公告内容（富文本）
});
```

### 2.3 前端操作
- **发布公告**: 调用 `saveAnnouncement()` 方法，显示"公告已发布"提示
- **重置**: 调用 `resetAnnouncement()` 方法，清空标题和内容

### 2.4 前端UI组件
- 标题输入框: `ElInput` 组件
- 内容编辑器: `RichTextEditor` 富文本编辑器组件

## 3. 数据库表设计

### 3.1 公告表 (case_announcement)

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGINT | 20 | 是 | 自增 | 公告主键ID |
| sep_id | VARCHAR | 50 | 是 | - | 案件ID（关联案件表） |
| title | VARCHAR | 200 | 是 | - | 公告标题 |
| content | TEXT | - | 是 | - | 公告内容（HTML格式） |
| announcement_type | VARCHAR | 20 | 否 | 'NORMAL' | 公告类型：NORMAL-普通公告，URGENT-紧急公告，IMPORTANT-重要公告 |
| status | VARCHAR | 20 | 否 | 'PUBLISHED' | 公告状态：DRAFT-草稿，PUBLISHED-已发布，RETRACTED-已撤回 |
| publisher_id | BIGINT | 20 | 是 | - | 发布人ID（关联用户表） |
| publisher_name | VARCHAR | 100 | 是 | - | 发布人姓名（冗余字段，便于查询） |
| publish_time | DATETIME | - | 否 | - | 发布时间 |
| view_count | INT | 11 | 否 | 0 | 浏览次数 |
| is_top | TINYINT | 1 | 否 | 0 | 是否置顶：0-否，1-是 |
| top_expire_time | DATETIME | - | 否 | - | 置顶过期时间 |
| attachments | TEXT | - | 否 | - | 附件信息（JSON格式） |
| create_time | DATETIME | - | 是 | CURRENT_TIMESTAMP | 创建时间 |
| update_time | DATETIME | - | 是 | CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新时间 |
| delete_flag | TINYINT | 1 | 否 | 0 | 删除标记：0-未删除，1-已删除 |

### 3.2 公告浏览记录表 (case_announcement_view)

| 字段名 | 类型 | 长度 | 必填 | 默认值 | 说明 |
|--------|------|------|------|--------|------|
| id | BIGINT | 20 | 是 | 自增 | 记录主键ID |
| announcement_id | BIGINT | 20 | 是 | - | 公告ID（关联公告表） |
| sep_id | VARCHAR | 50 | 是 | - | 案件ID |
| viewer_id | BIGINT | 20 | 是 | - | 浏览人ID（关联用户表） |
| viewer_name | VARCHAR | 100 | 是 | - | 浏览人姓名 |
| view_time | DATETIME | - | 是 | CURRENT_TIMESTAMP | 浏览时间 |
| ip_address | VARCHAR | 50 | 否 | - | 浏览IP地址 |

### 3.3 索引设计

```sql
-- 公告表索引
CREATE INDEX idx_sep_id ON case_announcement(sep_id);
CREATE INDEX idx_publisher_id ON case_announcement(publisher_id);
CREATE INDEX idx_publish_time ON case_announcement(publish_time);
CREATE INDEX idx_status ON case_announcement(status);
CREATE INDEX idx_is_top ON case_announcement(is_top, top_expire_time);

-- 公告浏览记录表索引
CREATE INDEX idx_announcement_id ON case_announcement_view(announcement_id);
CREATE INDEX idx_sep_id ON case_announcement_view(sep_id);
CREATE INDEX idx_viewer_id ON case_announcement_view(viewer_id);
CREATE INDEX idx_view_time ON case_announcement_view(view_time);
```

## 4. API接口设计

### 4.1 发布公告

#### 请求信息
- **URL**: `/api/web/publishAnnouncement`
- **请求方式**: `POST`
- **Content-Type**: `application/json`

#### 请求参数
| 参数名 | 类型 | 位置 | 必填 | 描述 |
|--------|------|------|------|------|
| token | String | Query | 是 | 认证令牌 |
| sep_id | String | Body | 是 | 案件ID |
| title | String | Body | 是 | 公告标题 |
| content | String | Body | 是 | 公告内容（HTML格式） |
| announcement_type | String | Body | 否 | 公告类型，默认：NORMAL |
| is_top | Boolean | Body | 否 | 是否置顶，默认：false |
| top_expire_time | String | Body | 否 | 置顶过期时间，格式：yyyy-MM-dd HH:mm:ss |
| attachments | Array | Body | 否 | 附件列表 |

#### 请求示例
```json
{
  "sep_id": "2024001",
  "title": "关于第一次债权人会议的通知",
  "content": "<p>各位债权人：</p><p>兹定于2024年1月15日上午9:00在XX法院第一审判庭召开第一次债权人会议...</p>",
  "announcement_type": "IMPORTANT",
  "is_top": true,
  "top_expire_time": "2024-01-20 18:00:00",
  "attachments": [
    {
      "file_id": "file_001",
      "file_name": "会议议程.pdf",
      "file_url": "/api/web/downloadCaseFile/file_001"
    }
  ]
}
```

#### 成功响应
```json
{
  "status": "1",
  "error": "",
  "data": {
    "id": 1001,
    "title": "关于第一次债权人会议的通知",
    "publish_time": "2024-01-10 14:30:00"
  }
}
```

#### 失败响应
```json
{
  "status": "0",
  "error": "案件不存在或无权限",
  "data": null
}
```

### 4.2 获取案件公告列表

#### 请求信息
- **URL**: `/api/web/getCaseAnnouncements`
- **请求方式**: `GET`

#### 请求参数
| 参数名 | 类型 | 位置 | 必填 | 描述 |
|--------|------|------|------|------|
| token | String | Query | 是 | 认证令牌 |
| sep_id | String | Query | 是 | 案件ID |
| page | Integer | Query | 否 | 页码，默认：1 |
| size | Integer | Query | 否 | 每页数量，默认：10 |
| status | String | Query | 否 | 公告状态筛选，默认：PUBLISHED |

#### 成功响应
```json
{
  "status": "1",
  "error": "",
  "data": {
    "count": 25,
    "pages": 3,
    "records": [
      {
        "id": 1001,
        "sep_id": "2024001",
        "title": "关于第一次债权人会议的通知",
        "content": "<p>各位债权人...</p>",
        "announcement_type": "IMPORTANT",
        "status": "PUBLISHED",
        "publisher_name": "张三",
        "publish_time": "2024-01-10 14:30:00",
        "view_count": 156,
        "is_top": 1,
        "top_expire_time": "2024-01-20 18:00:00",
        "attachments": [
          {
            "file_id": "file_001",
            "file_name": "会议议程.pdf",
            "file_url": "/api/web/downloadCaseFile/file_001"
          }
        ],
        "create_time": "2024-01-10 14:30:00"
      }
    ]
  }
}
```

### 4.3 获取公告详情

#### 请求信息
- **URL**: `/api/web/getAnnouncementDetail`
- **请求方式**: `GET`

#### 请求参数
| 参数名 | 类型 | 位置 | 必填 | 描述 |
|--------|------|------|------|------|
| token | String | Query | 是 | 认证令牌 |
| announcement_id | String | Query | 是 | 公告ID |

#### 成功响应
```json
{
  "status": "1",
  "error": "",
  "data": {
    "id": 1001,
    "sep_id": "2024001",
    "title": "关于第一次债权人会议的通知",
    "content": "<p>各位债权人...</p>",
    "announcement_type": "IMPORTANT",
    "status": "PUBLISHED",
    "publisher_id": 1,
    "publisher_name": "张三",
    "publish_time": "2024-01-10 14:30:00",
    "view_count": 156,
    "is_top": 1,
    "top_expire_time": "2024-01-20 18:00:00",
    "attachments": [
      {
        "file_id": "file_001",
        "file_name": "会议议程.pdf",
        "file_url": "/api/web/downloadCaseFile/file_001"
      }
    ],
    "create_time": "2024-01-10 14:30:00",
    "update_time": "2024-01-10 14:30:00"
  }
}
```

### 4.4 更新公告

#### 请求信息
- **URL**: `/api/web/updateAnnouncement`
- **请求方式**: `PUT`

#### 请求参数
| 参数名 | 类型 | 位置 | 必填 | 描述 |
|--------|------|------|------|------|
| token | String | Query | 是 | 认证令牌 |
| announcement_id | String | Body | 是 | 公告ID |
| title | String | Body | 否 | 公告标题 |
| content | String | Body | 否 | 公告内容 |
| announcement_type | String | Body | 否 | 公告类型 |
| status | String | Body | 否 | 公告状态 |
| is_top | Boolean | Body | 否 | 是否置顶 |
| top_expire_time | String | Body | 否 | 置顶过期时间 |
| attachments | Array | Body | 否 | 附件列表 |

#### 成功响应
```json
{
  "status": "1",
  "error": "",
  "data": {
    "id": 1001,
    "update_time": "2024-01-11 10:00:00"
  }
}
```

### 4.5 删除公告

#### 请求信息
- **URL**: `/api/web/deleteAnnouncement/{announcement_id}`
- **请求方式**: `DELETE`

#### 请求参数
| 参数名 | 类型 | 位置 | 必填 | 描述 |
|--------|------|------|------|------|
| token | String | Query | 是 | 认证令牌 |
| announcement_id | String | Path | 是 | 公告ID |

#### 成功响应
```json
{
  "status": "1",
  "error": "",
  "data": "删除成功"
}
```

### 4.6 撤回公告

#### 请求信息
- **URL**: `/api/web/retractAnnouncement`
- **请求方式**: `PUT`

#### 请求参数
| 参数名 | 类型 | 位置 | 必填 | 描述 |
|--------|------|------|------|------|
| token | String | Query | 是 | 认证令牌 |
| announcement_id | String | Body | 是 | 公告ID |
| retract_reason | String | Body | 否 | 撤回原因 |

#### 成功响应
```json
{
  "status": "1",
  "error": "",
  "data": "撤回成功"
}
```

### 4.7 记录公告浏览

#### 请求信息
- **URL**: `/api/web/recordAnnouncementView`
- **请求方式**: `POST`

#### 请求参数
| 参数名 | 类型 | 位置 | 必填 | 描述 |
|--------|------|------|------|------|
| token | String | Query | 是 | 认证令牌 |
| announcement_id | String | Body | 是 | 公告ID |

#### 成功响应
```json
{
  "status": "1",
  "error": "",
  "data": "记录成功"
}
```

### 4.8 获取公告浏览记录

#### 请求信息
- **URL**: `/api/web/getAnnouncementViews`
- **请求方式**: `GET`

#### 请求参数
| 参数名 | 类型 | 位置 | 必填 | 描述 |
|--------|------|------|------|------|
| token | String | Query | 是 | 认证令牌 |
| announcement_id | String | Query | 是 | 公告ID |
| page | Integer | Query | 否 | 页码，默认：1 |
| size | Integer | Query | 否 | 每页数量，默认：10 |

#### 成功响应
```json
{
  "status": "1",
  "error": "",
  "data": {
    "count": 156,
    "pages": 16,
    "records": [
      {
        "id": 1,
        "announcement_id": 1001,
        "viewer_name": "李四",
        "view_time": "2024-01-10 15:30:00",
        "ip_address": "192.168.1.100"
      }
    ]
  }
}
```

## 5. 业务流程设计

### 5.1 发布公告流程
1. 前端用户填写公告标题和内容
2. 选择公告类型（普通/紧急/重要）
3. 可选择是否置顶及置顶过期时间
4. 可上传相关附件
5. 提交发布请求
6. 后端验证：
   - 验证token有效性
   - 验证案件ID是否存在
   - 验证用户是否有权限发布公告
7. 保存公告数据到数据库
8. 返回发布成功结果

### 5.2 浏览公告流程
1. 用户点击公告查看详情
2. 后端返回公告详情
3. 异步记录浏览信息
4. 更新公告浏览次数

### 5.3 更新公告流程
1. 用户编辑公告内容
2. 提交更新请求
3. 后端验证权限
4. 更新数据库记录
5. 记录操作日志

### 5.4 删除公告流程
1. 用户确认删除
2. 后端验证权限
3. 执行逻辑删除（设置delete_flag=1）
4. 记录操作日志

### 5.5 撤回公告流程
1. 用户选择撤回公告
2. 填写撤回原因（可选）
3. 后端验证权限
4. 更新公告状态为RETRACTED
5. 记录撤回原因和操作日志

## 6. 安全性设计

### 6.1 权限控制
- 只有案件关联的管理人可以发布公告
- 只有发布者本人或管理员可以编辑、删除公告
- 所有案件相关人员可以查看已发布的公告

### 6.2 内容安全
- 对公告内容进行XSS过滤
- 限制公告标题和内容长度
- 对富文本内容进行白名单过滤

### 6.3 操作审计
- 记录所有公告的创建、修改、删除操作
- 记录操作人、操作时间、操作内容
- 记录公告浏览日志

## 7. 性能优化

### 7.1 数据库优化
- 为常用查询字段添加索引
- 对公告内容使用TEXT类型存储
- 对已删除数据使用逻辑删除

### 7.2 缓存策略
- 缓存案件公告列表
- 缓存置顶公告
- 缓存公告浏览次数

### 7.3 分页查询
- 公告列表采用分页查询
- 默认每页10条记录
- 支持自定义每页数量

## 8. 异常处理

| 异常场景 | 错误码 | 错误信息 |
|---------|--------|---------|
| Token无效 | 401 | 认证失败，请重新登录 |
| 案件不存在 | 404 | 案件不存在或无权限访问 |
| 公告不存在 | 404 | 公告不存在或已被删除 |
| 无权限操作 | 403 | 无权限执行此操作 |
| 参数错误 | 400 | 请求参数错误 |
| 服务器错误 | 500 | 服务器内部错误 |

## 9. 数据库建表SQL

```sql
-- 公告表
CREATE TABLE `case_announcement` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '公告主键ID',
  `sep_id` VARCHAR(50) NOT NULL COMMENT '案件ID',
  `title` VARCHAR(200) NOT NULL COMMENT '公告标题',
  `content` TEXT NOT NULL COMMENT '公告内容（HTML格式）',
  `announcement_type` VARCHAR(20) NOT NULL DEFAULT 'NORMAL' COMMENT '公告类型：NORMAL-普通公告，URGENT-紧急公告，IMPORTANT-重要公告',
  `status` VARCHAR(20) NOT NULL DEFAULT 'PUBLISHED' COMMENT '公告状态：DRAFT-草稿，PUBLISHED-已发布，RETRACTED-已撤回',
  `publisher_id` BIGINT(20) NOT NULL COMMENT '发布人ID',
  `publisher_name` VARCHAR(100) NOT NULL COMMENT '发布人姓名',
  `publish_time` DATETIME DEFAULT NULL COMMENT '发布时间',
  `view_count` INT(11) NOT NULL DEFAULT '0' COMMENT '浏览次数',
  `is_top` TINYINT(1) NOT NULL DEFAULT '0' COMMENT '是否置顶：0-否，1-是',
  `top_expire_time` DATETIME DEFAULT NULL COMMENT '置顶过期时间',
  `attachments` TEXT DEFAULT NULL COMMENT '附件信息（JSON格式）',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  `delete_flag` TINYINT(1) NOT NULL DEFAULT '0' COMMENT '删除标记：0-未删除，1-已删除',
  PRIMARY KEY (`id`),
  KEY `idx_sep_id` (`sep_id`),
  KEY `idx_publisher_id` (`publisher_id`),
  KEY `idx_publish_time` (`publish_time`),
  KEY `idx_status` (`status`),
  KEY `idx_is_top` (`is_top`, `top_expire_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='案件公告表';

-- 公告浏览记录表
CREATE TABLE `case_announcement_view` (
  `id` BIGINT(20) NOT NULL AUTO_INCREMENT COMMENT '记录主键ID',
  `announcement_id` BIGINT(20) NOT NULL COMMENT '公告ID',
  `sep_id` VARCHAR(50) NOT NULL COMMENT '案件ID',
  `viewer_id` BIGINT(20) NOT NULL COMMENT '浏览人ID',
  `viewer_name` VARCHAR(100) NOT NULL COMMENT '浏览人姓名',
  `view_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '浏览时间',
  `ip_address` VARCHAR(50) DEFAULT NULL COMMENT '浏览IP地址',
  PRIMARY KEY (`id`),
  KEY `idx_announcement_id` (`announcement_id`),
  KEY `idx_sep_id` (`sep_id`),
  KEY `idx_viewer_id` (`viewer_id`),
  KEY `idx_view_time` (`view_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='公告浏览记录表';
```

## 10. 总结

本文档详细描述了案件管理系统中公告管理功能的后端实现方案，包括：

1. **数据模型设计**：公告表和公告浏览记录表
2. **API接口设计**：8个核心接口，涵盖发布、查询、更新、删除、撤回等功能
3. **业务流程设计**：发布公告、浏览公告、更新公告、删除公告、撤回公告
4. **安全性设计**：权限控制、内容安全、操作审计
5. **性能优化**：数据库索引、缓存策略、分页查询
6. **异常处理**：统一的错误码和错误信息

后端开发人员可以根据本文档实现完整的公告管理功能，满足前端的公告发布和管理需求。
