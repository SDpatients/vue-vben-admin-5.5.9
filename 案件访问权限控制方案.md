# 案件访问权限控制方案

## 目录
1. [方案概述](#1-方案概述)
2. [权限模型设计](#2-权限模型设计)
3. [数据库设计](#3-数据库设计)
4. [后端实现](#4-后端实现)
5. [前端实现](#5-前端实现)
6. [前后端交互流程](#6-前后端交互流程)
7. [测试用例](#7-测试用例)
8. [部署注意事项](#8-部署注意事项)

---

## 1. 方案概述

### 1.1 业务需求

1. **普通用户（律师）**：只能查看和操作自己创建的案件
2. **审核员**：可以查看所有案件，并对案件进行审核
3. **管理员**：拥有所有权限，包括案件管理和用户管理

### 1.2 技术架构

- **后端框架**：Spring Boot 2.6.13 + MyBatis
- **数据库**：SQL Server 2008
- **权限模型**：RBAC（基于角色的访问控制）
- **认证方式**：JWT Token

### 1.3 核心功能

- 基于角色的数据访问控制
- 案件审核流程
- 权限验证拦截器
- 前端权限指令

---

## 2. 权限模型设计

### 2.1 角色定义

| 角色编码 | 角色名称 | 权限描述 |
|---------|---------|---------|
| LAWYER | 律师 | 只能查看和操作自己的案件 |
| REVIEWER | 审核员 | 可以查看所有案件，审核案件 |
| ADMIN | 管理员 | 拥有所有权限 |

### 2.2 权限定义

| 权限编码 | 权限名称 | 适用角色 |
|---------|---------|---------|
| case:view | 查看案件 | LAWYER, REVIEWER, ADMIN |
| case:view:own | 查看自己的案件 | LAWYER |
| case:view:all | 查看所有案件 | REVIEWER, ADMIN |
| case:add | 创建案件 | LAWYER, ADMIN |
| case:edit | 编辑案件 | LAWYER, ADMIN |
| case:delete | 删除案件 | ADMIN |
| case:review | 审核案件 | REVIEWER, ADMIN |
| case:approve | 审核通过 | REVIEWER, ADMIN |
| case:reject | 审核驳回 | REVIEWER, ADMIN |

### 2.3 权限矩阵

| 操作 | LAWYER | REVIEWER | ADMIN |
|------|--------|----------|-------|
| 查看自己的案件 | ✓ | ✓ | ✓ |
| 查看所有案件 | ✗ | ✓ | ✓ |
| 创建案件 | ✓ | ✗ | ✓ |
| 编辑自己的案件 | ✓ | ✗ | ✓ |
| 编辑他人的案件 | ✗ | ✗ | ✓ |
| 删除案件 | ✗ | ✗ | ✓ |
| 审核案件 | ✗ | ✓ | ✓ |

---

## 3. 数据库设计

### 3.1 案件表扩展

在现有的 `TB_BANKRUPT_CASE` 表中添加字段：

```sql
ALTER TABLE TB_BANKRUPT_CASE
ADD creator_id INT NULL COMMENT '创建人ID',
    reviewer_id INT NULL COMMENT '审核人ID',
    review_status VARCHAR(20) DEFAULT 'PENDING' COMMENT '审核状态：PENDING-待审核, APPROVED-已通过, REJECTED-已驳回',
    review_time DATETIME NULL COMMENT '审核时间',
    review_opinion NVARCHAR(500) NULL COMMENT '审核意见',
    review_count INT DEFAULT 0 COMMENT '审核次数';

CREATE INDEX IDX_CASE_CREATOR ON TB_BANKRUPT_CASE(creator_id);
CREATE INDEX IDX_CASE_REVIEWER ON TB_BANKRUPT_CASE(reviewer_id);
CREATE INDEX IDX_CASE_STATUS ON TB_BANKRUPT_CASE(review_status);
```

### 3.2 案件审核历史表

```sql
CREATE TABLE TB_CASE_REVIEW_LOG (
    log_id INT IDENTITY(1,1) PRIMARY KEY,
    case_id INT NOT NULL COMMENT '案件ID',
    reviewer_id INT NOT NULL COMMENT '审核人ID',
    reviewer_name NVARCHAR(50) NOT NULL COMMENT '审核人姓名',
    action VARCHAR(20) NOT NULL COMMENT '操作类型：SUBMIT-提交, APPROVE-通过, REJECT-驳回, CANCEL-取消',
    opinion NVARCHAR(500) NULL COMMENT '审核意见',
    operate_time DATETIME DEFAULT GETDATE() COMMENT '操作时间',
    remark NVARCHAR(200) NULL COMMENT '备注'
);

CREATE INDEX IDX_REVIEW_LOG_CASE ON TB_CASE_REVIEW_LOG(case_id);
CREATE INDEX IDX_REVIEW_LOG_REVIEWER ON TB_CASE_REVIEW_LOG(reviewer_id);
CREATE INDEX IDX_REVIEW_LOG_TIME ON TB_CASE_REVIEW_LOG(operate_time DESC);
```

### 3.3 初始化角色和权限数据

```sql
-- 插入角色
INSERT INTO TB_ROLE (role_code, role_name, role_desc, is_system, sort_order) VALUES
('LAWYER', '律师', '普通律师用户，只能查看和操作自己的案件', '1', 3),
('REVIEWER', '审核员', '可以查看所有案件，审核案件', '1', 2),
('ADMIN', '管理员', '系统管理员，拥有所有权限', '1', 1);

-- 插入权限
INSERT INTO TB_PERMISSION (perm_code, perm_name, perm_type, parent_id, sort_order, status) VALUES
('case', '案件管理', '1', 0, 1, '1'),
('case:view', '查看案件', '2', 1, 1, '1'),
('case:view:own', '查看自己的案件', '2', 2, 1, '1'),
('case:view:all', '查看所有案件', '2', 2, 2, '1'),
('case:add', '创建案件', '2', 1, 2, '1'),
('case:edit', '编辑案件', '2', 1, 3, '1'),
('case:delete', '删除案件', '2', 1, 4, '1'),
('case:review', '审核案件', '2', 1, 5, '1'),
('case:approve', '审核通过', '2', 1, 6, '1'),
('case:reject', '审核驳回', '2', 1, 7, '1');

-- 分配权限给角色
-- 律师角色
INSERT INTO TB_ROLE_PERMISSION (role_id, perm_id)
SELECT r.role_id, p.perm_id
FROM TB_ROLE r, TB_PERMISSION p
WHERE r.role_code = 'LAWYER'
AND p.perm_code IN ('case', 'case:view', 'case:view:own', 'case:add', 'case:edit');

-- 审核员角色
INSERT INTO TB_ROLE_PERMISSION (role_id, perm_id)
SELECT r.role_id, p.perm_id
FROM TB_ROLE r, TB_PERMISSION p
WHERE r.role_code = 'REVIEWER'
AND p.perm_code IN ('case', 'case:view', 'case:view:all', 'case:review', 'case:approve', 'case:reject');

-- 管理员角色（拥有所有权限）
INSERT INTO TB_ROLE_PERMISSION (role_id, perm_id)
SELECT r.role_id, p.perm_id
FROM TB_ROLE r, TB_PERMISSION p
WHERE r.role_code = 'ADMIN';
```

---

## 4. 后端实现

### 4.1 实体类扩展

#### 4.1.1 BankruptCase.java（扩展）

```java
package com.ls.law.entity;

import java.util.Date;

public class BankruptCase {
    private Integer sepId;
    private Integer sepLd;
    private Integer sepMd;
    private String sepNd;
    private String sepAuser;
    private Date sepAdate;
    private String sepEuser;
    private Date sepEdate;
    private String ah;
    private String ajmc;
    private Date slrq;
    private String ajly;
    private String slfy;
    private String zdjg;
    private String glrfzr;
    private String sfjhs;
    private String ay;
    private String ajjd;
    private Date zqsbjzsj;
    private Date larq;
    private Date jarq;
    private Date pcsj;
    private Date zjsj;
    private Date zxsj;
    private Date gdsj;
    private String beizhu;
    private String wjsc;

    // 新增字段
    private Integer creatorId;
    private Integer reviewerId;
    private String reviewStatus;
    private Date reviewTime;
    private String reviewOpinion;
    private Integer reviewCount;

    // Getters and Setters
    public Integer getSepId() {
        return sepId;
    }

    public void setSepId(Integer sepId) {
        this.sepId = sepId;
    }

    // ... 其他getter和setter保持不变 ...

    public Integer getCreatorId() {
        return creatorId;
    }

    public void setCreatorId(Integer creatorId) {
        this.creatorId = creatorId;
    }

    public Integer getReviewerId() {
        return reviewerId;
    }

    public void setReviewerId(Integer reviewerId) {
        this.reviewerId = reviewerId;
    }

    public String getReviewStatus() {
        return reviewStatus;
    }

    public void setReviewStatus(String reviewStatus) {
        this.reviewStatus = reviewStatus;
    }

    public Date getReviewTime() {
        return reviewTime;
    }

    public void setReviewTime(Date reviewTime) {
        this.reviewTime = reviewTime;
    }

    public String getReviewOpinion() {
        return reviewOpinion;
    }

    public void setReviewOpinion(String reviewOpinion) {
        this.reviewOpinion = reviewOpinion;
    }

    public Integer getReviewCount() {
        return reviewCount;
    }

    public void setReviewCount(Integer reviewCount) {
        this.reviewCount = reviewCount;
    }
}
```

#### 4.1.2 CaseReviewLog.java（新增）

```java
package com.ls.law.entity;

import java.util.Date;

public class CaseReviewLog {
    private Integer logId;
    private Integer caseId;
    private Integer reviewerId;
    private String reviewerName;
    private String action;
    private String opinion;
    private Date operateTime;
    private String remark;

    public Integer getLogId() {
        return logId;
    }

    public void setLogId(Integer logId) {
        this.logId = logId;
    }

    public Integer getCaseId() {
        return caseId;
    }

    public void setCaseId(Integer caseId) {
        this.caseId = caseId;
    }

    public Integer getReviewerId() {
        return reviewerId;
    }

    public void setReviewerId(Integer reviewerId) {
        this.reviewerId = reviewerId;
    }

    public String getReviewerName() {
        return reviewerName;
    }

    public void setReviewerName(String reviewerName) {
        this.reviewerName = reviewerName;
    }

    public String getAction() {
        return action;
    }

    public void setAction(String action) {
        this.action = action;
    }

    public String getOpinion() {
        return opinion;
    }

    public void setOpinion(String opinion) {
        this.opinion = opinion;
    }

    public Date getOperateTime() {
        return operateTime;
    }

    public void setOperateTime(Date operateTime) {
        this.operateTime = operateTime;
    }

    public String getRemark() {
        return remark;
    }

    public void setRemark(String remark) {
        this.remark = remark;
    }
}
```

### 4.2 权限验证工具类

#### 4.2.1 CasePermissionUtils.java（新增）

```java
package com.ls.law.utils;

import com.ls.law.service.PermissionService;

import javax.servlet.http.HttpServletRequest;
import java.util.Set;

public class CasePermissionUtils {

    private static PermissionService permissionService;

    public static void setPermissionService(PermissionService service) {
        permissionService = service;
    }

    public static Integer getCurrentUserId(HttpServletRequest request) {
        Object userId = request.getAttribute("userId");
        return userId != null ? Integer.parseInt(userId.toString()) : null;
    }

    public static boolean hasPermission(Integer userId, String permCode) {
        if (permissionService == null) {
            return false;
        }
        return permissionService.hasPermission(userId, permCode);
    }

    public static boolean canViewAllCases(Integer userId) {
        return hasPermission(userId, "case:view:all");
    }

    public static boolean canReviewCase(Integer userId) {
        return hasPermission(userId, "case:review");
    }

    public static boolean canEditCase(Integer userId, Integer caseCreatorId) {
        if (hasPermission(userId, "case:edit")) {
            return true;
        }
        return userId.equals(caseCreatorId);
    }

    public static boolean canDeleteCase(Integer userId) {
        return hasPermission(userId, "case:delete");
    }
}
```

### 4.3 Mapper层实现

#### 4.3.1 BankruptCaseMapper.java（扩展）

```java
package com.ls.law.mapper;

import com.ls.law.entity.BankruptCase;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.util.List;
import java.util.Map;

@Mapper
public interface BankruptCaseMapper {

    List<BankruptCase> selectAllCase();

    List<BankruptCase> selectCaseByPage(Map<String, Object> params);

    List<BankruptCase> selectCaseByCreatorId(@Param("creatorId") Integer creatorId, @Param("offset") Integer offset, @Param("limit") Integer limit);

    BankruptCase selectCaseById(Integer sepId);

    int selectCaseCount();

    int selectCaseCountByCreatorId(@Param("creatorId") Integer creatorId);

    int insertCase(BankruptCase bankruptCase);

    int updateCase(BankruptCase bankruptCase);

    int deleteCase(Integer sepId);

    int updateReviewStatus(@Param("caseId") Integer caseId, @Param("reviewerId") Integer reviewerId,
                           @Param("reviewStatus") String reviewStatus, @Param("reviewOpinion") String reviewOpinion);
}
```

#### 4.3.2 BankruptCaseMapper.xml（扩展）

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ls.law.mapper.BankruptCaseMapper">

    <resultMap id="BaseResultMap" type="com.ls.law.entity.BankruptCase">
        <id column="sep_id" property="sepId"/>
        <result column="sep_ld" property="sepLd"/>
        <result column="sep_md" property="sepMd"/>
        <result column="sep_nd" property="sepNd"/>
        <result column="sep_auser" property="sepAuser"/>
        <result column="sep_adate" property="sepAdate"/>
        <result column="sep_euser" property="sepEuser"/>
        <result column="sep_edate" property="sepEdate"/>
        <result column="ah" property="ah"/>
        <result column="ajmc" property="ajmc"/>
        <result column="slrq" property="slrq"/>
        <result column="ajly" property="ajly"/>
        <result column="slfy" property="slfy"/>
        <result column="zdjg" property="zdjg"/>
        <result column="glrfzr" property="glrfzr"/>
        <result column="sfjhs" property="sfjhs"/>
        <result column="ay" property="ay"/>
        <result column="ajjd" property="ajjd"/>
        <result column="zqsbjzsj" property="zqsbjzsj"/>
        <result column="larq" property="larq"/>
        <result column="jarq" property="jarq"/>
        <result column="pcsj" property="pcsj"/>
        <result column="zjsj" property="zjsj"/>
        <result column="zxsj" property="zxsj"/>
        <result column="gdsj" property="gdsj"/>
        <result column="beizhu" property="beizhu"/>
        <result column="wjsc" property="wjsc"/>
        <result column="creator_id" property="creatorId"/>
        <result column="reviewer_id" property="reviewerId"/>
        <result column="review_status" property="reviewStatus"/>
        <result column="review_time" property="reviewTime"/>
        <result column="review_opinion" property="reviewOpinion"/>
        <result column="review_count" property="reviewCount"/>
    </resultMap>

    <sql id="Base_Column_List">
        sep_id, sep_ld, sep_md, sep_nd, sep_auser, sep_adate, sep_euser, sep_edate,
        ah, ajmc, slrq, ajly, slfy, zdjg, glrfzr, sfjhs, ay, ajjd, zqsbjzsj,
        larq, jarq, pcsj, zjsj, zxsj, gdsj, beizhu, wjsc,
        creator_id, reviewer_id, review_status, review_time, review_opinion, review_count
    </sql>

    <select id="selectAllCase" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM TB_BANKRUPT_CASE
        ORDER BY sep_adate DESC
    </select>

    <select id="selectCaseByPage" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM TB_BANKRUPT_CASE
        ORDER BY sep_adate DESC
        OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
    </select>

    <select id="selectCaseByCreatorId" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM TB_BANKRUPT_CASE
        WHERE creator_id = #{creatorId}
        ORDER BY sep_adate DESC
        OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
    </select>

    <select id="selectCaseById" resultMap="BaseResultMap">
        SELECT <include refid="Base_Column_List"/>
        FROM TB_BANKRUPT_CASE
        WHERE sep_id = #{sepId}
    </select>

    <select id="selectCaseCount" resultType="int">
        SELECT COUNT(*) FROM TB_BANKRUPT_CASE
    </select>

    <select id="selectCaseCountByCreatorId" resultType="int">
        SELECT COUNT(*) FROM TB_BANKRUPT_CASE WHERE creator_id = #{creatorId}
    </select>

    <insert id="insertCase" parameterType="com.ls.law.entity.BankruptCase" useGeneratedKeys="true" keyProperty="sepId">
        INSERT INTO TB_BANKRUPT_CASE (
            sep_ld, sep_md, sep_nd, sep_auser, sep_adate, sep_euser, sep_edate,
            ah, ajmc, slrq, ajly, slfy, zdjg, glrfzr, sfjhs, ay, ajjd,
            zqsbjzsj, larq, jarq, pcsj, zjsj, zxsj, gdsj, beizhu, wjsc,
            creator_id, review_status, review_count
        ) VALUES (
            #{sepLd}, #{sepMd}, #{sepNd}, #{sepAuser}, #{sepAdate}, #{sepEuser}, #{sepEdate},
            #{ah}, #{ajmc}, #{slrq}, #{ajly}, #{slfy}, #{zdjg}, #{glrfzr}, #{sfjhs}, #{ay}, #{ajjd},
            #{zqsbjzsj}, #{larq}, #{jarq}, #{pcsj}, #{zjsj}, #{zxsj}, #{gdsj}, #{beizhu}, #{wjsc},
            #{creatorId}, 'PENDING', 0
        )
    </insert>

    <update id="updateCase" parameterType="com.ls.law.entity.BankruptCase">
        UPDATE TB_BANKRUPT_CASE
        <set>
            <if test="sepLd != null">sep_ld = #{sepLd},</if>
            <if test="sepMd != null">sep_md = #{sepMd},</if>
            <if test="sepNd != null">sep_nd = #{sepNd},</if>
            <if test="sepEuser != null">sep_euser = #{sepEuser},</if>
            <if test="sepEdate != null">sep_edate = #{sepEdate},</if>
            <if test="ah != null">ah = #{ah},</if>
            <if test="ajmc != null">ajmc = #{ajmc},</if>
            <if test="slrq != null">slrq = #{slrq},</if>
            <if test="ajly != null">ajly = #{ajly},</if>
            <if test="slfy != null">slfy = #{slfy},</if>
            <if test="zdjg != null">zdjg = #{zdjg},</if>
            <if test="glrfzr != null">glrfzr = #{glrfzr},</if>
            <if test="sfjhs != null">sfjhs = #{sfjhs},</if>
            <if test="ay != null">ay = #{ay},</if>
            <if test="ajjd != null">ajjd = #{ajjd},</if>
            <if test="zqsbjzsj != null">zqsbjzsj = #{zqsbjzsj},</if>
            <if test="larq != null">larq = #{larq},</if>
            <if test="jarq != null">jarq = #{jarq},</if>
            <if test="pcsj != null">pcsj = #{pcsj},</if>
            <if test="zjsj != null">zjsj = #{zjsj},</if>
            <if test="zxsj != null">zxsj = #{zxsj},</if>
            <if test="gdsj != null">gdsj = #{gdsj},</if>
            <if test="beizhu != null">beizhu = #{beizhu},</if>
            <if test="wjsc != null">wjsc = #{wjsc},</if>
        </set>
        WHERE sep_id = #{sepId}
    </update>

    <update id="deleteCase">
        DELETE FROM TB_BANKRUPT_CASE WHERE sep_id = #{sepId}
    </update>

    <update id="updateReviewStatus">
        UPDATE TB_BANKRUPT_CASE
        SET reviewer_id = #{reviewerId},
            review_status = #{reviewStatus},
            review_time = GETDATE(),
            review_opinion = #{reviewOpinion},
            review_count = review_count + 1
        WHERE sep_id = #{caseId}
    </update>

</mapper>
```

#### 4.3.3 CaseReviewLogMapper.java（新增）

```java
package com.ls.law.mapper;

import com.ls.law.entity.CaseReviewLog;
import org.apache.ibatis.annotations.Mapper;
import org.apache.ibatis.annotations.Param;

import java.util.List;

@Mapper
public interface CaseReviewLogMapper {

    int insert(CaseReviewLog log);

    List<CaseReviewLog> selectByCaseId(@Param("caseId") Integer caseId);

    List<CaseReviewLog> selectByReviewerId(@Param("reviewerId") Integer reviewerId);
}
```

#### 4.3.4 CaseReviewLogMapper.xml（新增）

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ls.law.mapper.CaseReviewLogMapper">

    <resultMap id="BaseResultMap" type="com.ls.law.entity.CaseReviewLog">
        <id column="log_id" property="logId"/>
        <result column="case_id" property="caseId"/>
        <result column="reviewer_id" property="reviewerId"/>
        <result column="reviewer_name" property="reviewerName"/>
        <result column="action" property="action"/>
        <result column="opinion" property="opinion"/>
        <result column="operate_time" property="operateTime"/>
        <result column="remark" property="remark"/>
    </resultMap>

    <insert id="insert" parameterType="com.ls.law.entity.CaseReviewLog" useGeneratedKeys="true" keyProperty="logId">
        INSERT INTO TB_CASE_REVIEW_LOG (
            case_id, reviewer_id, reviewer_name, action, opinion, operate_time, remark
        ) VALUES (
            #{caseId}, #{reviewerId}, #{reviewerName}, #{action}, #{opinion}, GETDATE(), #{remark}
        )
    </insert>

    <select id="selectByCaseId" resultMap="BaseResultMap">
        SELECT * FROM TB_CASE_REVIEW_LOG
        WHERE case_id = #{caseId}
        ORDER BY operate_time DESC
    </select>

    <select id="selectByReviewerId" resultMap="BaseResultMap">
        SELECT * FROM TB_CASE_REVIEW_LOG
        WHERE reviewer_id = #{reviewerId}
        ORDER BY operate_time DESC
    </select>

</mapper>
```

### 4.4 Service层实现

#### 4.4.1 BankruptCaseService.java（扩展）

```java
package com.ls.law.service;

import com.ls.law.entity.BankruptCase;
import com.ls.law.entity.CaseReviewLog;

import java.util.List;
import java.util.Map;

public interface BankruptCaseService {

    List<BankruptCase> selectAllCase();

    Map<String, Object> selectCaseByPage(int page, int size);

    Map<String, Object> selectCaseByCreatorId(Integer creatorId, int page, int size);

    BankruptCase selectCaseById(Integer sepId);

    int addOneCase(BankruptCase bankruptCase);

    int updateCase(BankruptCase bankruptCase);

    int deleteCase(Integer sepId);

    void approveCase(Integer caseId, Integer reviewerId, String reviewerName, String opinion);

    void rejectCase(Integer caseId, Integer reviewerId, String reviewerName, String opinion);

    List<CaseReviewLog> getReviewLogs(Integer caseId);
}
```

#### 4.4.2 BankruptCaseServiceImpl.java（扩展）

```java
package com.ls.law.service.impl;

import com.ls.law.entity.BankruptCase;
import com.ls.law.entity.CaseReviewLog;
import com.ls.law.mapper.BankruptCaseMapper;
import com.ls.law.mapper.CaseReviewLogMapper;
import com.ls.law.service.BankruptCaseService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Service
public class BankruptCaseServiceImpl implements BankruptCaseService {

    @Autowired
    private BankruptCaseMapper bankruptCaseMapper;

    @Autowired
    private CaseReviewLogMapper caseReviewLogMapper;

    @Override
    public List<BankruptCase> selectAllCase() {
        return bankruptCaseMapper.selectAllCase();
    }

    @Override
    public Map<String, Object> selectCaseByPage(int page, int size) {
        Map<String, Object> result = new HashMap<>();
        Map<String, Object> params = new HashMap<>();

        int offset = (page - 1) * size;
        params.put("offset", offset);
        params.put("limit", size);

        List<BankruptCase> records = bankruptCaseMapper.selectCaseByPage(params);
        int count = bankruptCaseMapper.selectCaseCount();
        int pages = (int) Math.ceil((double) count / size);

        result.put("count", count);
        result.put("pages", pages);
        result.put("records", records);

        return result;
    }

    @Override
    public Map<String, Object> selectCaseByCreatorId(Integer creatorId, int page, int size) {
        Map<String, Object> result = new HashMap<>();

        int offset = (page - 1) * size;
        List<BankruptCase> records = bankruptCaseMapper.selectCaseByCreatorId(creatorId, offset, size);
        int count = bankruptCaseMapper.selectCaseCountByCreatorId(creatorId);
        int pages = (int) Math.ceil((double) count / size);

        result.put("count", count);
        result.put("pages", pages);
        result.put("records", records);

        return result;
    }

    @Override
    public BankruptCase selectCaseById(Integer sepId) {
        return bankruptCaseMapper.selectCaseById(sepId);
    }

    @Override
    public int addOneCase(BankruptCase bankruptCase) {
        return bankruptCaseMapper.insertCase(bankruptCase);
    }

    @Override
    public int updateCase(BankruptCase bankruptCase)) {
        return bankruptCaseMapper.updateCase(bankruptCase);
    }

    @Override
    public int deleteCase(Integer sepId) {
        return bankruptCaseMapper.deleteCase(sepId);
    }

    @Override
    @Transactional
    public void approveCase(Integer caseId, Integer reviewerId, String reviewerName, String opinion) {
        bankruptCaseMapper.updateReviewStatus(caseId, reviewerId, "APPROVED", opinion);

        CaseReviewLog log = new CaseReviewLog();
        log.setCaseId(caseId);
        log.setReviewerId(reviewerId);
        log.setReviewerName(reviewerName);
        log.setAction("APPROVE");
        log.setOpinion(opinion);
        caseReviewLogMapper.insert(log);
    }

    @Override
    @Transactional
    public void rejectCase(Integer caseId, Integer reviewerId, String reviewerName, String opinion) {
        bankruptCaseMapper.updateReviewStatus(caseId, reviewerId, "REJECTED", opinion);

        CaseReviewLog log = new CaseReviewLog();
        log.setCaseId(caseId);
        log.setReviewerId(reviewerId);
        log.setReviewerName(reviewerName);
        log.setAction("REJECT");
        log.setOpinion(opinion);
        caseReviewLogMapper.insert(log);
    }

    @Override
    public List<CaseReviewLog> getReviewLogs(Integer caseId) {
        return caseReviewLogMapper.selectByCaseId(caseId);
    }
}
```

### 4.5 Controller层实现

#### 4.5.1 BankruptCaseController.java（重构）

```java
package com.ls.law.controller;

import com.ls.law.entity.BankruptCase;
import com.ls.law.entity.CaseReviewLog;
import com.ls.law.entity.Creditor;
import com.ls.law.entity.DebtorEnterprise;
import com.ls.law.model.Result;
import com.ls.law.service.BankruptCaseService;
import com.ls.law.service.CreditorService;
import com.ls.law.service.DebtorEnterpriseService;
import com.ls.law.utils.CasePermissionUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import javax.servlet.http.HttpServletRequest;
import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/web")
public class BankruptCaseController {

    @Autowired
    private BankruptCaseService bankruptCaseService;

    @Autowired
    private DebtorEnterpriseService debtorEnterpriseService;

    @Autowired
    private CreditorService creditorService;

    @GetMapping("/selectOneCase")
    public Result selectOneCase(
            HttpServletRequest request,
            @RequestParam String AJID) {
        try {
            Integer sepId = Integer.parseInt(AJID);
            BankruptCase caseInfo = bankruptCaseService.selectCaseById(sepId);

            if (caseInfo == null) {
                return Result.error("案件不存在");
            }

            Integer userId = CasePermissionUtils.getCurrentUserId(request);

            if (!CasePermissionUtils.canViewAllCases(userId)) {
                if (!userId.equals(caseInfo.getCreatorId())) {
                    return Result.error("无权查看该案件");
                }
            }

            return Result.success(caseInfo);
        } catch (NumberFormatException e) {
            return Result.error("无效的案件ID");
        }
    }

    @GetMapping("/selectAllCase")
    public Result selectAllCase(
            HttpServletRequest request,
            @RequestParam(required = false, defaultValue = "1") Integer page,
            @RequestParam(required = false, defaultValue = "10") Integer size) {
        try {
            Integer userId = CasePermissionUtils.getCurrentUserId(request);

            Map<String, Object> result;
            if (CasePermissionUtils.canViewAllCases(userId)) {
                result = bankruptCaseService.selectCaseByPage(page, size);
            } else {
                result = bankruptCaseService.selectCaseByCreatorId(userId, page, size);
            }

            return Result.success(result);
        } catch (Exception e) {
            return Result.error("查询案件失败: " + e.getMessage());
        }
    }

    @PostMapping("/AddOneCase")
    public Result addOneCase(
            HttpServletRequest request,
            @RequestBody BankruptCase bankruptCase) {
        try {
            Integer userId = CasePermissionUtils.getCurrentUserId(request);

            if (!CasePermissionUtils.hasPermission(userId, "case:add")) {
                return Result.error("无权创建案件");
            }

            bankruptCase.setCreatorId(userId);
            bankruptCase.setSepAuser(userId.toString());
            bankruptCase.setSepEuser(userId.toString());

            int result = bankruptCaseService.addOneCase(bankruptCase);
            if (result > 0) {
                return Result.success("案件添加成功");
            } else {
                return Result.error("案件添加失败");
            }
        } catch (Exception e) {
            return Result.error("添加案件时发生错误: " + e.getMessage());
        }
    }

    @PostMapping("/updateCase")
    public Result updateCase(
            HttpServletRequest request,
            @RequestBody BankruptCase bankruptCase) {
        try {
            Integer userId = CasePermissionUtils.getCurrentUserId(request);

            BankruptCase existingCase = bankruptCaseService.selectCaseById(bankruptCase.getSepId());
            if (existingCase == null) {
                return Result.error("案件不存在");
            }

            if (!CasePermissionUtils.canEditCase(userId, existingCase.getCreatorId())) {
                return Result.error("无权编辑该案件");
            }

            bankruptCase.setSepEuser(userId.toString());
            int result = bankruptCaseService.updateCase(bankruptCase);
            if (result > 0) {
                return Result.success("案件更新成功");
            } else {
                return Result.error("案件更新失败");
            }
        } catch (Exception e) {
            return Result.error("更新案件时发生错误: " + e.getMessage());
        }
    }

    @PostMapping("/deleteCase")
    public Result deleteCase(
            HttpServletRequest request,
            @RequestParam Integer caseId) {
        try {
            Integer userId = CasePermissionUtils.getCurrentUserId(request);

            if (!CasePermissionUtils.canDeleteCase(userId)) {
                return Result.error("无权删除案件");
            }

            int result = bankruptCaseService.deleteCase(caseId);
            if (result > 0) {
                return Result.success("案件删除成功");
            } else {
                return Result.error("案件删除失败");
            }
        } catch (Exception e) {
            return Result.error("删除案件时发生错误: " + e.getMessage());
        }
    }

    @PostMapping("/approveCase")
    public Result approveCase(
            HttpServletRequest request,
            @RequestParam Integer caseId,
            @RequestParam String opinion) {
        try {
            Integer userId = CasePermissionUtils.getCurrentUserId(request);

            if (!CasePermissionUtils.canReviewCase(userId)) {
                return Result.error("无权审核案件");
            }

            String reviewerName = userId.toString();
            bankruptCaseService.approveCase(caseId, userId, reviewerName, opinion);

            return Result.success("案件审核通过");
        } catch (Exception e) {
            return Result.error("审核案件时发生错误: " + e.getMessage());
        }
    }

    @PostMapping("/rejectCase")
    public Result rejectCase(
            HttpServletRequest request,
            @RequestParam Integer caseId,
            @RequestParam String opinion) {
        try {
            Integer userId = CasePermissionUtils.getCurrentUserId(request);

            if (!CasePermissionUtils.canReviewCase(userId)) {
                return Result.error("无权审核案件");
            }

            String reviewerName = userId.toString();
            bankruptCaseService.rejectCase(caseId, userId, reviewerName, opinion);

            return Result.success("案件已驳回");
        } catch (Exception e) {
            return Result.error("驳回案件时发生错误: " + e.getMessage());
        }
    }

    @GetMapping("/getReviewLogs")
    public Result getReviewLogs(@RequestParam Integer caseId) {
        try {
            List<CaseReviewLog> logs = bankruptCaseService.getReviewLogs(caseId);
            return Result.success(logs);
        } catch (Exception e) {
            return Result.error("获取审核日志失败: " + e.getMessage());
        }
    }

    @PostMapping("/addDebtor")
    public Result addDebtor(
            @RequestParam String token,
            @RequestBody DebtorEnterprise debtorEnterprise) {
        try {
            debtorEnterprise.setSepAuser("system");
            debtorEnterprise.setSepEuser("system");

            int result = debtorEnterpriseService.addDebtor(debtorEnterprise);
            if (result > 0) {
                return Result.success("债务人添加成功");
            } else {
                return Result.error("债务人添加失败");
            }
        } catch (Exception e) {
            return Result.error("添加债务人时发生错误: " + e.getMessage());
        }
    }

    @PostMapping("/AddCreditor")
    public Result addCreditor(
            @RequestParam String token,
            @RequestBody Creditor creditor) {
        try {
            creditor.setSepAuser("system");
            creditor.setSepEuser("system");

            int result = creditorService.addCreditor(creditor);
            if (result > 0) {
                return Result.success("债权人添加成功");
            } else {
                return Result.error("债权人添加失败");
            }
        } catch (Exception e) {
            return Result.error("添加债权人时发生错误: " + e.getMessage());
        }
    }
}
```

### 4.6 配置类

#### 4.6.1 WebConfig.java（更新）

```java
package com.ls.law.config;

import com.ls.law.service.PermissionService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.servlet.config.annotation.InterceptorRegistry;
import org.springframework.web.servlet.config.annotation.WebMvcConfigurer;

@Configuration
public class WebConfig implements WebMvcConfigurer {

    @Autowired
    private JwtInterceptor jwtInterceptor;

    @Autowired
    private PermissionService permissionService;

    @Override
    public void addInterceptors(InterceptorRegistry registry) {
        registry.addInterceptor(jwtInterceptor)
                .addPathPatterns("/api/web/**")
                .excludePathPatterns(
                    "/api/web/login",
                    "/api/web/loginBySms",
                    "/api/web/sendLoginSms",
                    "/api/web/sendRegisterSms",
                    "/api/web/sendResetPwdSms",
                    "/api/web/refreshToken"
                );
    }

    @Override
    public void afterPropertiesSet() {
        com.ls.law.utils.CasePermissionUtils.setPermissionService(permissionService);
    }
}
```

---

## 5. 前端实现

### 5.1 API层实现

#### 5.1.1 api/case.ts

```typescript
import { requestClient } from '#/api/request';

export interface BankruptCase {
  sepId: number;
  sepLd?: number;
  sepMd?: number;
  sepNd?: string;
  sepAuser?: string;
  sepAdate?: string;
  sepEuser?: string;
  sepEdate?: string;
  ah?: string;
  ajmc?: string;
  slrq?: string;
  ajly?: string;
  slfy?: string;
  zdjg?: string;
  glrfzr?: string;
  sfjhs?: string;
  ay?: string;
  ajjd?: string;
  zqsbjzsj?: string;
  larq?: string;
  jarq?: string;
  pcsj?: string;
  zjsj?: string;
  zxsj?: string;
  gdsj?: string;
  beizhu?: string;
  wjsc?: string;
  creatorId?: number;
  reviewerId?: number;
  reviewStatus?: string;
  reviewTime?: string;
  reviewOpinion?: string;
  reviewCount?: number;
}

export interface CaseReviewLog {
  logId: number;
  caseId: number;
  reviewerId: number;
  reviewerName: string;
  action: string;
  opinion?: string;
  operateTime: string;
  remark?: string;
}

export const caseApi = {
  getCaseList: (page: number = 1, pageSize: number = 10) => {
    return requestClient.get('/api/web/selectAllCase', {
      params: { page, size: pageSize },
    });
  },

  getCaseById: (caseId: number) => {
    return requestClient.get('/api/web/selectOneCase', {
      params: { AJID: caseId },
    });
  },

  createCase: (data: Partial<BankruptCase>) => {
    return requestClient.post('/api/web/AddOneCase', data);
  },

  updateCase: (data: Partial<BankruptCase>) => {
    return requestClient.post('/api/web/updateCase', data);
  },

  deleteCase: (caseId: number) => {
    return requestClient.post('/api/web/deleteCase', null, {
      params: { caseId },
    });
  },

  approveCase: (caseId: number, opinion: string) => {
    return requestClient.post('/api/web/approveCase', null, {
      params: { caseId, opinion },
    });
  },

  rejectCase: (caseId: number, opinion: string) => {
    return requestClient.post('/api/web/rejectCase', null, {
      params: { caseId, opinion },
    });
  },

  getReviewLogs: (caseId: number) => {
    return requestClient.get('/api/web/getReviewLogs', {
      params: { caseId },
    });
  },
};
```

### 5.2 权限指令

#### 5.2.1 directives/permission.ts

```typescript
import { useUserStore } from '#/store/modules/user';
import type { Directive, DirectiveBinding } from 'vue';

export const permission: Directive = {
  mounted(el: HTMLElement, binding: DirectiveBinding) {
    const { value } = binding;
    const userStore = useUserStore();
    const permissions = userStore.getPermissions || [];

    if (value && value instanceof Array && value.length > 0) {
      const hasPermission = permissions.some((perm: string) => value.includes(perm));
      if (!hasPermission) {
        el.parentNode?.removeChild(el);
      }
    } else if (value && typeof value === 'string') {
      const hasPermission = permissions.includes(value);
      if (!hasPermission) {
        el.parentNode?.removeChild(el);
      }
    }
  },
};
```

### 5.3 页面组件

#### 5.3.1 views/case/List.vue

```vue
<template>
  <div class="case-list">
    <div class="page-header">
      <h2>案件管理</h2>
      <Button v-permission="['case:add']" type="primary" @click="showCreateModal">
        <Icon icon="lucide:plus" :size="16" />
        新建案件
      </Button>
    </div>

    <Table
      :columns="columns"
      :data-source="caseList"
      :loading="loading"
      :pagination="pagination"
      @change="handleTableChange"
      row-key="sepId"
    >
      <template #bodyCell="{ column, record }">
        <template v-if="column.key === 'action'">
          <Space>
            <Button type="link" size="small" @click="viewDetail(record)">
              查看
            </Button>
            <Button
              v-if="canEdit(record)"
              v-permission="['case:edit']"
              type="link"
              size="small"
              @click="editCase(record)"
            >
              编辑
            </Button>
            <Button
              v-if="canReview(record)"
              v-permission="['case:review']"
              type="link"
              size="small"
              @click="showReviewModal(record)"
            >
              审核
            </Button>
            <Button
              v-permission="['case:delete']"
              type="link"
              size="small"
              danger
              @click="deleteCase(record)"
            >
              删除
            </Button>
          </Space>
        </template>
        <template v-else-if="column.key === 'reviewStatus'">
          <Tag :color="getStatusColor(record.reviewStatus)">
            {{ getStatusText(record.reviewStatus) }}
          </Tag>
        </template>
      </template>
    </Table>

    <CreateCaseModal v-model:visible="createModalVisible" @success="loadCaseList" />
    <EditCaseModal
      v-model:visible="editModalVisible"
      :case-data="currentCase"
      @success="loadCaseList"
    />
    <ReviewModal
      v-model:visible="reviewModalVisible"
      :case-data="currentCase"
      @success="loadCaseList"
    />
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, computed } from 'vue';
import { Table, Button, Space, Tag, Icon, Modal, message } from 'ant-design-vue';
import { caseApi, BankruptCase } from '#/api/case';
import { useUserStore } from '#/store/modules/user';
import CreateCaseModal from './components/CreateCaseModal.vue';
import EditCaseModal from './components/EditCaseModal.vue';
import ReviewModal from './components/ReviewModal.vue';

const userStore = useUserStore();
const currentUser = computed(() => userStore.getUserInfo);
const permissions = computed(() => userStore.getPermissions);

const loading = ref(false);
const caseList = ref<BankruptCase[]>([]);
const createModalVisible = ref(false);
const editModalVisible = ref(false);
const reviewModalVisible = ref(false);
const currentCase = ref<BankruptCase | null>(null);

const pagination = ref({
  current: 1,
  pageSize: 10,
  total: 0,
  showSizeChanger: true,
  showTotal: (total: number) => `共 ${total} 条`,
});

const columns = [
  {
    title: '案件编号',
    dataIndex: 'sepId',
    key: 'sepId',
    width: 100,
  },
  {
    title: '案件名称',
    dataIndex: 'ajmc',
    key: 'ajmc',
  },
  {
    title: '案号',
    dataIndex: 'ah',
    key: 'ah',
  },
  {
    title: '受理法院',
    dataIndex: 'slfy',
    key: 'slfy',
  },
  {
    title: '审核状态',
    dataIndex: 'reviewStatus',
    key: 'reviewStatus',
    width: 100,
  },
  {
    title: '操作',
    key: 'action',
    width: 200,
    fixed: 'right',
  },
];

const loadCaseList = async () => {
  loading.value = true;
  try {
    const res = await caseApi.getCaseList(pagination.value.current, pagination.value.pageSize);
    caseList.value = res.data?.records || [];
    pagination.value.total = res.data?.count || 0;
  } catch (error) {
    message.error('加载案件列表失败');
  } finally {
    loading.value = false;
  }
};

const handleTableChange = (pag: any) => {
  pagination.value.current = pag.current;
  pagination.value.pageSize = pag.pageSize;
  loadCaseList();
};

const canEdit = (record: BankruptCase) => {
  if (permissions.value.includes('case:edit')) {
    return true;
  }
  return record.creatorId === currentUser.value?.uPid;
};

const canReview = (record: BankruptCase) => {
  return record.reviewStatus === 'PENDING';
};

const viewDetail = (record: BankruptCase) => {
  console.log('查看详情', record);
};

const editCase = (record: BankruptCase) => {
  currentCase.value = record;
  editModalVisible.value = true;
};

const showReviewModal = (record: BankruptCase) => {
  currentCase.value = record;
  reviewModalVisible.value = true;
};

const deleteCase = (record: BankruptCase) => {
  Modal.confirm({
    title: '确认删除',
    content: `确认删除案件"${record.ajmc}"吗？`,
    onOk: async () => {
      try {
        await caseApi.deleteCase(record.sepId);
        message.success('删除成功');
        loadCaseList();
      } catch (error) {
        message.error('删除失败');
      }
    },
  });
};

const getStatusColor = (status?: string) => {
  const colorMap: Record<string, string> = {
    PENDING: 'orange',
    APPROVED: 'green',
    REJECTED: 'red',
  };
  return colorMap[status || ''] || 'default';
};

const getStatusText = (status?: string) => {
  const textMap: Record<string, string> = {
    PENDING: '待审核',
    APPROVED: '已通过',
    REJECTED: '已驳回',
  };
  return textMap[status || ''] || status;
};

onMounted(() => {
  loadCaseList();
});
</script>

<style scoped lang="less">
.case-list {
  padding: 20px;
  background: #fff;
  border-radius: 8px;
}

.page-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;

  h2 {
    margin: 0;
    font-size: 20px;
    font-weight: 600;
  }
}
</style>
```

#### 5.3.2 views/case/components/ReviewModal.vue

```vue
<template>
  <Modal
    v-model:open="visible"
    title="案件审核"
    width="600px"
    @ok="handleReview"
    @cancel="handleCancel"
  >
    <div class="review-modal">
      <div class="case-info">
        <div class="info-item">
          <span class="label">案件名称：</span>
          <span class="value">{{ caseData?.ajmc }}</span>
        </div>
        <div class="info-item">
          <span class="label">案号：</span>
          <span class="value">{{ caseData?.ah }}</span>
        </div>
        <div class="info-item">
          <span class="label">当前状态：</span>
          <Tag :color="getStatusColor(caseData?.reviewStatus)">
            {{ getStatusText(caseData?.reviewStatus) }}
          </Tag>
        </div>
      </div>

      <Divider />

      <div class="review-history">
        <h4>审核历史</h4>
        <Timeline v-if="reviewLogs.length > 0">
          <Timeline.Item
            v-for="log in reviewLogs"
            :key="log.logId"
            :color="getLogColor(log.action)"
          >
            <div class="log-item">
              <div class="log-header">
                <span class="reviewer">{{ log.reviewerName }}</span>
                <Tag :color="getActionColor(log.action)">
                  {{ getActionText(log.action) }}
                </Tag>
                <span class="time">{{ formatTime(log.operateTime) }}</span>
              </div>
              <div v-if="log.opinion" class="log-opinion">
                {{ log.opinion }}
              </div>
            </div>
          </Timeline.Item>
        </Timeline>
        <Empty v-else description="暂无审核记录" />
      </div>

      <Divider />

      <Form :model="form" layout="vertical">
        <Form.Item label="审核意见">
          <Input.TextArea
            v-model:value="form.opinion"
            placeholder="请输入审核意见"
            :rows="4"
          />
        </Form.Item>
      </Form>
    </div>
  </Modal>
</template>

<script setup lang="ts">
import { ref, watch } from 'vue';
import { Modal, Form, Input, Timeline, Tag, Divider, Empty, message } from 'ant-design-vue';
import { caseApi, CaseReviewLog } from '#/api/case';
import { formatTime } from '#/utils/date';

interface Props {
  visible: boolean;
  caseData?: any;
}

interface Emits {
  (e: 'update:visible', value: boolean): void;
  (e: 'success'): void;
}

const props = defineProps<Props>();
const emit = defineEmits<Emits>();

const visible = ref(false);
const reviewLogs = ref<CaseReviewLog[]>([]);
const form = ref({
  opinion: '',
});

watch(() => props.visible, (newVal) => {
  visible.value = newVal;
  if (newVal && props.caseData) {
    loadReviewLogs();
  }
});

watch(visible, (newVal) => {
  emit('update:visible', newVal);
});

const loadReviewLogs = async () => {
  if (!props.caseData?.sepId) return;

  try {
    const res = await caseApi.getReviewLogs(props.caseData.sepId);
    reviewLogs.value = res.data || [];
  } catch (error) {
    console.error('加载审核日志失败', error);
  }
};

const handleReview = async () => {
  if (!form.value.opinion) {
    message.warning('请输入审核意见');
    return;
  }

  try {
    await caseApi.approveCase(props.caseData.sepId, form.value.opinion);
    message.success('审核通过');
    visible.value = false;
    emit('success');
  } catch (error) {
    message.error('审核失败');
  }
};

const handleCancel = () => {
  visible.value = false;
  form.value.opinion = '';
};

const getStatusColor = (status?: string) => {
  const colorMap: Record<string, string> = {
    PENDING: 'orange',
    APPROVED: 'green',
    REJECTED: 'red',
  };
  return colorMap[status || ''] || 'default';
};

const getStatusText = (status?: string) => {
  const textMap: Record<string, string> = {
    PENDING: '待审核',
    APPROVED: '已通过',
    REJECTED: '已驳回',
  };
  return textMap[status || ''] || status;
};

const getLogColor = (action: string) => {
  const colorMap: Record<string, string> = {
    APPROVE: 'green',
    REJECT: 'red',
  };
  return colorMap[action] || 'blue';
};

const getActionColor = (action: string) => {
  const colorMap: Record<string, string> = {
    APPROVE: 'green',
    REJECT: 'red',
  };
  return colorMap[action] || 'default';
};

const getActionText = (action: string) => {
  const textMap: Record<string, string> = {
    APPROVE: '通过',
    REJECT: '驳回',
  };
  return textMap[action] || action;
};
</script>

<style scoped lang="less">
.review-modal {
  .case-info {
    .info-item {
      display: flex;
      margin-bottom: 12px;

      .label {
        width: 80px;
        color: #999;
      }

      .value {
        flex: 1;
        color: #333;
      }
    }
  }

  .review-history {
    h4 {
      margin-bottom: 16px;
    }

    .log-item {
      .log-header {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;

        .reviewer {
          font-weight: 500;
          color: #1890ff;
        }

        .time {
          margin-left: auto;
          font-size: 12px;
          color: #999;
        }
      }

      .log-opinion {
        padding: 8px;
        background: #f5f5f5;
        border-radius: 4px;
        font-size: 13px;
        color: #666;
      }
    }
  }
}
</style>
```

---

## 6. 前后端交互流程

### 6.1 查看案件列表流程

```
用户登录
  ↓
前端获取用户权限信息
  ↓
用户访问案件列表页面
  ↓
前端调用 GET /api/web/selectAllCase
  ↓
后端JwtInterceptor验证Token，提取userId
  ↓
后端CasePermissionUtils检查用户权限
  ↓
  ├─ 有"case:view:all"权限 → 查询所有案件
  └─ 无该权限 → 只查询用户自己创建的案件
  ↓
返回案件列表数据
  ↓
前端根据权限显示/隐藏操作按钮
```

### 6.2 创建案件流程

```
用户点击"新建案件"按钮
  ↓
前端检查用户是否有"case:add"权限
  ↓
显示创建案件弹窗
  ↓
用户填写案件信息并提交
  ↓
前端调用 POST /api/web/AddOneCase
  ↓
后端验证用户权限
  ↓
设置creatorId为当前用户ID
  ↓
保存案件到数据库
  ↓
返回创建结果
  ↓
前端刷新案件列表
```

### 6.3 审核案件流程

```
审核员查看案件列表
  ↓
前端检查用户是否有"case:review"权限
  ↓
显示"审核"按钮（仅对待审核案件）
  ↓
审核员点击"审核"按钮
  ↓
前端显示审核弹窗，加载审核历史
  ↓
审核员填写审核意见并提交
  ↓
前端调用 POST /api/web/approveCase 或 /rejectCase
  ↓
后端验证用户权限
  ↓
更新案件审核状态
  ↓
创建审核日志记录
  ↓
返回审核结果
  ↓
前端刷新案件列表
```

---

## 7. 测试用例

### 7.1 权限测试用例

| 用例编号 | 测试场景 | 前置条件 | 操作步骤 | 预期结果 |
|---------|---------|---------|---------|---------|
| TC001 | 普通用户查看自己的案件 | 用户角色为LAWYER，已创建案件 | 访问案件列表页面 | 只显示自己创建的案件 |
| TC002 | 普通用户查看他人案件 | 用户角色为LAWYER | 尝试访问他人案件详情 | 返回"无权查看该案件"错误 |
| TC003 | 审核员查看所有案件 | 用户角色为REVIEWER | 访问案件列表页面 | 显示所有案件 |
| TC004 | 审核员审核案件 | 用户角色为REVIEWER，有待审核案件 | 点击审核按钮，填写意见并提交 | 案件状态更新为已通过/已驳回 |
| TC005 | 管理员删除案件 | 用户角色为ADMIN | 点击删除按钮 | 案件删除成功 |
| TC006 | 普通用户删除案件 | 用户角色为LAWYER | 尝试删除案件 | 返回"无权删除案件"错误 |

### 7.2 数据访问测试用例

| 用例编号 | 测试场景 | 测试数据 | 预期结果 |
|---------|---------|---------|---------|
| TC001 | 律师A创建案件 | 律师A登录，创建案件1 | 案件1的creatorId为律师A的ID |
| TC002 | 律师A查看案件列表 | 律师A登录，查询案件列表 | 只返回律师A创建的案件 |
| TC003 | 审核员B查看案件列表 | 审核员B登录，查询案件列表 | 返回所有案件 |
| TC004 | 审核员B审核案件1 | 审核员B登录，审核案件1 | 案件1的reviewStatus更新为APPROVED，reviewerId为审核员B的ID |
| TC005 | 律师A编辑案件1 | 律师A登录，编辑案件1 | 编辑成功 |
| TC006 | 律师A编辑案件2 | 律师A登录，尝试编辑案件2（案件2为律师C创建） | 返回"无权编辑该案件"错误 |

---

## 8. 部署注意事项

### 8.1 数据库初始化

1. 执行数据库表结构变更SQL
2. 初始化角色和权限数据
3. 为现有用户分配角色

### 8.2 权限配置

1. 在TB_USER_ROLE表中为用户分配角色
2. 在TB_ROLE_PERMISSION表中为角色分配权限
3. 验证权限配置是否正确

### 8.3 前端配置

1. 更新API请求拦截器，添加Token
2. 注册权限指令
3. 配置路由守卫，验证用户权限

### 8.4 测试验证

1. 功能测试：验证各角色的权限是否正确
2. 安全测试：验证越权访问是否被阻止
3. 性能测试：验证权限检查对性能的影响

---

## 总结

本文档详细介绍了案件访问权限控制的完整实现方案，包括：

1. **权限模型设计**：基于RBAC的角色权限模型
2. **数据库设计**：案件表扩展、审核日志表、权限表
3. **后端实现**：实体类、工具类、Mapper、Service、Controller
4. **前端实现**：API层、权限指令、页面组件
5. **交互流程**：查看、创建、审核等操作的完整流程
6. **测试用例**：权限测试和数据访问测试

通过本方案，可以实现：
- 普通用户只能查看和操作自己的案件
- 审核员可以查看所有案件并进行审核
- 管理员拥有所有权限
- 前后端权限验证双重保障

---

**文档版本**: v1.0
**更新时间**: 2025年12月29日
**适用技术栈**: Spring Boot 2.6.13 + Vue 3 + SQL Server 2008
