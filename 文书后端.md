# 文书发布模块后端设计文档

## 1. 模块概述

### 1.1 功能定位
文书发布模块用于管理法律文书的发布、送达和记录，支持多种送达方式，实时跟踪送达状态，并提供完整的送达记录查询和统计功能。

### 1.2 核心功能
- 文书信息管理：创建、编辑、查询文书基本信息
- 多方式送达：支持电子送达、邮寄送达、直接送达等多种方式
- 状态跟踪：实时跟踪文书送达状态，包括待发送、已发送、待签收、已签收、送达失败等
- 送达记录：详细记录每一次送达操作，包括时间、方式、结果、操作人等
- 附件管理：支持文书附件的上传、下载和预览
- 统计分析：提供送达数据统计和分析功能

## 2. 数据库设计

### 2.1 数据模型关系

```
┌─────────────────┐       ┌─────────────────┐
│  case_case      │       │  sys_user       │
└─────────────────┘       └─────────────────┘
        ▲                        ▲
        │                        │
        └──────────┬─────────────┘
                   │
           ┌─────────────────┐
           │  law_document   │
           └─────────────────┘
                   ▲
                   │
                   ├────────────────────────┐
                   │                        │
           ┌─────────────────┐       ┌─────────────────┐
           │  doc_attachment  │       │  service_record │
           └─────────────────┘       └─────────────────┘
```

### 2.2 表结构设计

#### 2.2.1 文书表（law_document）

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
| --- | --- | --- | --- | --- |
| SEP_ID | VARCHAR | 36 | PRIMARY KEY | 文书ID |
| case_id | VARCHAR | 36 | NOT NULL | 案件ID，关联case_case表 |
| case_name | VARCHAR | 255 | NOT NULL | 案件名称 |
| document_name | VARCHAR | 255 | NOT NULL | 文书名称 |
| document_type | VARCHAR | 50 | NOT NULL | 文书类型（起诉状、答辩状、判决书等） |
| recipient | VARCHAR | 100 | NOT NULL | 受送达人 |
| recipient_type | VARCHAR | 50 | NOT NULL | 受送达人类型（原告、被告、第三人等） |
| recipient_phone | VARCHAR | 20 | NOT NULL | 受送达人联系电话 |
| recipient_address | VARCHAR | 500 | NOT NULL | 受送达人地址 |
| service_method | VARCHAR | 50 | NOT NULL | 送达方式（电子送达、邮寄送达、直接送达等） |
| service_content | TEXT | - | NOT NULL | 送达内容 |
| service_date | DATETIME | - | NULL | 送达日期 |
| deliverer | VARCHAR | 100 | NULL | 送达人 |
| deliverer_phone | VARCHAR | 20 | NULL | 送达人联系电话 |
| status | VARCHAR | 50 | NOT NULL | 送达状态（待发送、已发送、待签收、已签收、送达失败） |
| send_status | VARCHAR | 50 | NOT NULL | 发送状态（已发送、暂存送达） |
| create_time | DATETIME | - | NOT NULL | 创建时间 |
| update_time | DATETIME | - | NOT NULL | 更新时间 |
| create_by | VARCHAR | 36 | NOT NULL | 创建人ID，关联sys_user表 |
| update_by | VARCHAR | 36 | NOT NULL | 更新人ID，关联sys_user表 |

#### 2.2.2 文书附件表（doc_attachment）

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
| --- | --- | --- | --- | --- |
| SEP_ID | VARCHAR | 36 | PRIMARY KEY | 附件ID |
| document_id | VARCHAR | 36 | NOT NULL | 文书ID，关联law_document表 |
| file_name | VARCHAR | 255 | NOT NULL | 文件名 |
| file_path | VARCHAR | 500 | NOT NULL | 文件存储路径 |
| file_size | BIGINT | - | NOT NULL | 文件大小（字节） |
| file_type | VARCHAR | 50 | NOT NULL | 文件类型（PDF、DOC、DOCX等） |
| upload_time | DATETIME | - | NOT NULL | 上传时间 |
| upload_by | VARCHAR | 36 | NOT NULL | 上传人ID，关联sys_user表 |
| is_delete | TINYINT | 1 | NOT NULL DEFAULT 0 | 是否删除（0：否，1：是） |

#### 2.2.3 送达记录表（service_record）

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
| --- | --- | --- | --- | --- |
| SEP_ID | VARCHAR | 36 | PRIMARY KEY | 记录ID |
| service_id | VARCHAR | 36 | NOT NULL | 文书ID，关联law_document表 |
| case_id | VARCHAR | 36 | NOT NULL | 案件ID，关联case_case表 |
| document_name | VARCHAR | 255 | NOT NULL | 文书名称 |
| recipient | VARCHAR | 100 | NOT NULL | 受送达人 |
| service_method | VARCHAR | 50 | NOT NULL | 送达方式 |
| service_date | DATETIME | - | NOT NULL | 送达时间 |
| service_result | VARCHAR | 50 | NOT NULL | 送达结果（成功、失败、已签收、待签收） |
| service_content | TEXT | - | NOT NULL | 送达内容 |
| operator | VARCHAR | 100 | NOT NULL | 操作人 |
| remark | TEXT | - | NULL | 备注 |
| create_time | DATETIME | - | NOT NULL | 创建时间 |

## 3. API设计

### 3.1 基础配置

| 配置项 | 值 | 说明 |
| --- | --- | --- |
| API基础路径 | /api/document | 所有文书相关API的基础路径 |
| 认证方式 | JWT | 使用JSON Web Token进行认证 |
| 响应格式 | JSON | 所有API响应均为JSON格式 |
| 分页参数 | page, size | 分页查询参数，默认page=1, size=10 |

### 3.2 文书管理API

#### 3.2.1 创建文书

- **请求方法**：POST
- **请求路径**：/api/document/create
- **请求参数**：
  ```json
  {
    "caseId": "案件ID",
    "documentName": "文书名称",
    "documentType": "文书类型",
    "recipient": "受送达人",
    "recipientType": "受送达人类型",
    "recipientPhone": "受送达人电话",
    "recipientAddress": "受送达人地址",
    "serviceMethod": "送达方式",
    "serviceContent": "送达内容",
    "sendStatus": "发送状态"
  }
  ```
- **响应参数**：
  ```json
  {
    "code": 200,
    "message": "操作成功",
    "data": {
      "SEP_ID": "文书ID",
      "createTime": "创建时间"
    }
  }
  ```

#### 3.2.2 获取文书列表

- **请求方法**：GET
- **请求路径**：/api/document/list
- **请求参数**：
  ```
  caseId: 案件ID（可选）
  documentName: 文书名称（可选）
  status: 送达状态（可选）
  senderType: 发送者类型（可选，我发起的/收到的送达）
  sendStatus: 发送状态（可选，已发送/暂存送达）
  page: 页码（可选，默认1）
  size: 每页大小（可选，默认10）
  ```
- **响应参数**：
  ```json
  {
    "code": 200,
    "message": "操作成功",
    "data": {
      "count": 100,
      "records": [
        {
          "SEP_ID": "文书ID",
          "caseId": "案件ID",
          "caseName": "案件名称",
          "documentName": "文书名称",
          "documentType": "文书类型",
          "recipient": "受送达人",
          "recipientType": "受送达人类型",
          "serviceMethod": "送达方式",
          "status": "送达状态",
          "serviceDate": "送达日期",
          "deliverer": "送达人",
          "createTime": "创建时间"
        }
        // 更多文书记录
      ]
    }
  }
  ```

#### 3.2.3 获取文书详情

- **请求方法**：GET
- **请求路径**：/api/document/{SEP_ID}
- **响应参数**：
  ```json
  {
    "code": 200,
    "message": "操作成功",
    "data": {
        "SEP_ID": "文书ID",
        "caseId": "案件ID",
        "caseName": "案件名称",
        "documentName": "文书名称",
        "documentType": "文书类型",
        "recipient": "受送达人",
        "recipientType": "受送达人类型",
        "recipientPhone": "受送达人电话",
        "recipientAddress": "受送达人地址",
        "serviceMethod": "送达方式",
        "serviceDate": "送达日期",
        "deliverer": "送达人",
        "delivererPhone": "送达人电话",
        "status": "送达状态",
        "serviceContent": "送达内容",
        "sendStatus": "发送状态",
        "createTime": "创建时间",
        "updateTime": "更新时间",
        "attachments": [
          {
            "SEP_ID": "附件ID",
            "fileName": "文件名",
            "fileSize": 1024000,
            "fileType": "PDF",
            "uploadTime": "上传时间"
          }
          // 更多附件
        ]
      }
  }
  ```

#### 3.2.4 更新文书状态

- **请求方法**：PUT
- **请求路径**：/api/document/{SEP_ID}/status
- **请求参数**：
  ```json
  {
    "status": "新状态",
    "remark": "状态变更说明"（可选）
  }
  ```
- **响应参数**：
  ```json
  {
    "code": 200,
    "message": "操作成功",
    "data": null
  }
  ```

### 3.3 附件管理API

#### 3.3.1 上传附件

- **请求方法**：POST
- **请求路径**：/api/document/attachment/upload
- **请求参数**：
  - FormData格式，包含file字段（文件）和documentId字段（文书ID）
- **响应参数**：
  ```json
  {
    "code": 200,
    "message": "操作成功",
    "data": {
      "SEP_ID": "附件ID",
      "fileName": "文件名",
      "fileSize": 1024000,
      "fileType": "PDF",
      "uploadTime": "上传时间"
    }
  }
  ```

#### 3.3.2 下载附件

- **请求方法**：GET
- **请求路径**：/api/document/attachment/download/{SEP_ID}
- **响应**：文件流

#### 3.3.3 删除附件

- **请求方法**：DELETE
- **请求路径**：/api/document/attachment/{SEP_ID}
- **响应参数**：
  ```json
  {
    "code": 200,
    "message": "操作成功",
    "data": null
  }
  ```

### 3.4 送达记录API

#### 3.4.1 获取送达记录列表

- **请求方法**：GET
- **请求路径**：/api/document/{SEP_ID}/records
- **请求参数**：
  ```
  page: 页码（可选，默认1）
  size: 每页大小（可选，默认10）
  ```
- **响应参数**：
  ```json
  {
    "code": 200,
    "message": "操作成功",
    "data": {
      "count": 10,
      "records": [
        {
          "SEP_ID": "记录ID",
          "serviceMethod": "送达方式",
          "serviceDate": "送达时间",
          "serviceResult": "送达结果",
          "serviceContent": "送达内容",
          "operator": "操作人",
          "remark": "备注"
        }
        // 更多记录
      ]
    }
  }
  ```

#### 3.4.2 添加送达记录

- **请求方法**：POST
- **请求路径**：/api/document/{SEP_ID}/record/add
- **请求参数**：
  ```json
  {
    "serviceMethod": "送达方式",
    "serviceResult": "送达结果",
    "serviceContent": "送达内容",
    "operator": "操作人",
    "remark": "备注"（可选）
  }
  ```
- **响应参数**：
  ```json
  {
    "code": 200,
    "message": "操作成功",
    "data": null
  }
  ```

### 3.5 统计分析API

#### 3.5.1 获取送达统计数据

- **请求方法**：GET
- **请求路径**：/api/document/statistics
- **请求参数**：
  ```
  startTime: 开始时间（可选，格式：YYYY-MM-DD）
  endTime: 结束时间（可选，格式：YYYY-MM-DD）
  caseId: 案件ID（可选）
  ```
- **响应参数**：
  ```json
  {
    "code": 200,
    "message": "操作成功",
    "data": {
      "totalCount": 100,
      "successCount": 85,
      "pendingCount": 10,
      "failedCount": 5,
      "methodDistribution": {
        "电子送达": 60,
        "邮寄送达": 25,
        "直接送达": 15
      }
    }
  }
  ```

## 4. 业务流程设计

### 4.1 文书发布流程

1. **创建文书**：用户填写文书基本信息、受送达人信息和送达信息
2. **上传附件**：根据需要上传文书附件
3. **选择送达方式**：选择电子送达、邮寄送达或直接送达等方式
4. **确认发送状态**：选择"已发送"或"暂存送达"
5. **提交文书**：系统生成文书记录，根据发送状态更新数据库
6. **执行送达**：根据送达方式执行具体送达操作
7. **更新状态**：实时更新送达状态，记录送达结果
8. **生成记录**：每一次送达操作生成一条送达记录

### 4.2 送达状态流转

```
待发送 → 已发送 → 待签收 → 已签收
          ↓
        送达失败
```

- **待发送**：文书已创建但尚未发送
- **已发送**：文书已通过选定的送达方式发送
- **待签收**：文书已发送，等待受送达人签收
- **已签收**：受送达人已签收文书
- **送达失败**：文书发送或签收失败

## 5. 持久化存储设计

### 5.1 数据库存储

- 使用MySQL数据库存储文书基本信息、送达状态和送达记录
- 采用InnoDB引擎，支持事务和外键约束
- 建立合理的索引，优化查询性能
  - law_document表：case_id, status, send_status, create_time
  - service_record表：service_id, service_date, service_result

### 5.2 文件存储

- 文书附件存储：使用文件服务器或对象存储服务（如MinIO、AWS S3、阿里云OSS等）
- 存储路径格式：`/document/{documentId}/{timestamp}_{fileName}`
- 支持文件大小限制：单文件不超过10MB
- 支持文件类型：PDF、DOC、DOCX、XLS、XLSX、JPG、PNG

### 5.3 缓存设计

- 使用Redis缓存常用查询数据，如文书列表、统计数据等
- 缓存过期时间：文书列表缓存5分钟，统计数据缓存30分钟
- 缓存更新策略：数据更新时主动失效相关缓存

## 6. 数据分析设计

### 6.1 数据统计维度

- **时间维度**：按日、周、月、季度、年统计送达数据
- **案件维度**：按案件统计文书数量和送达情况
- **送达方式维度**：按送达方式统计送达成功率和数量
- **状态维度**：统计不同送达状态的文书数量
- **操作人维度**：统计不同操作人的送达数量和成功率

### 6.2 统计指标

- **总文书数**：系统中所有文书的总数
- **送达成功率**：成功送达文书数/总送达文书数
- **平均送达时间**：从发送到签收的平均时间
- **各状态文书占比**：不同送达状态的文书数量占比
- **各送达方式使用频率**：不同送达方式的使用次数统计

### 6.3 数据报表

- **文书送达趋势图**：展示文书送达数量随时间的变化趋势
- **送达方式分布图**：展示不同送达方式的使用比例
- **送达状态饼图**：展示不同送达状态的文书占比
- **案件送达统计**：按案件统计文书数量和送达成功率

## 7. 系统集成设计

### 7.1 与案件管理系统集成

- 通过案件ID关联案件信息
- 支持从案件管理系统获取案件基本信息
- 文书状态变更时通知案件管理系统

### 7.2 与用户管理系统集成

- 通过用户ID关联用户信息
- 支持从用户管理系统获取操作人信息
- 实现基于角色的权限控制

### 7.3 与文件管理系统集成

- 支持与第三方文件管理系统集成
- 实现文件上传、下载、预览功能
- 支持文件版本控制和权限管理

## 8. 安全设计

### 8.1 数据安全

- 数据库数据加密存储：敏感字段（如受送达人电话、地址）加密存储
- 传输加密：所有API请求和响应采用HTTPS加密传输
- 访问控制：基于角色的权限控制，限制不同用户对文书的操作权限

### 8.2 文件安全

- 文件上传验证：验证文件类型、大小和完整性
- 文件访问控制：基于文书权限的文件访问控制
- 防止恶意文件：对上传文件进行病毒扫描和安全检查

### 8.3 日志安全

- 详细记录所有操作日志：包括创建、编辑、发送、状态变更等
- 日志加密存储：操作日志加密存储，防止篡改
- 日志审计：定期对操作日志进行审计，发现异常行为

## 9. 性能优化设计

### 9.1 数据库优化

- 合理设计索引：根据查询频率建立索引
- 分表分库：对于大数据量场景，考虑按案件ID或时间进行分表分库
- 读写分离：采用主从复制，实现读写分离，提高查询性能

### 9.2 API优化

- 分页查询：所有列表查询都支持分页，避免一次性返回大量数据
- 懒加载：附件信息和详细记录采用懒加载方式，提高初始加载速度
- 批量操作：支持批量发送、批量更新状态等批量操作

### 9.3 缓存优化

- 热点数据缓存：对常用查询数据进行缓存
- 缓存预热：系统启动时预热常用缓存数据
- 分布式缓存：采用Redis集群，提高缓存可靠性和性能

## 10. 部署与运维

### 10.1 部署架构

- 采用微服务架构，独立部署文书发布模块
- 支持容器化部署：使用Docker和Kubernetes进行容器化管理
- 高可用设计：采用多实例部署，负载均衡，故障自动切换

### 10.2 监控与告警

- 系统监控：监控API请求量、响应时间、错误率等
- 数据库监控：监控数据库连接数、查询性能、磁盘空间等
- 告警机制：设置阈值告警，如API响应时间超过1秒、数据库连接数超过阈值等

### 10.3 日志管理

- 集中日志管理：使用ELK或其他日志管理系统集中管理日志
- 日志分级：分为DEBUG、INFO、WARN、ERROR四个级别
- 日志分析：定期分析日志，发现系统问题和优化点

## 11. 总结

文书发布模块是法律案件管理系统的重要组成部分，实现了文书从创建到送达的全流程管理，支持多种送达方式，实时跟踪送达状态，并提供完整的送达记录和统计分析功能。本设计方案详细描述了系统的数据库设计、API设计、业务流程、持久化存储和数据分析等方面，为后端开发提供了完整的指导。

通过本设计方案的实施，可以提高文书发布和送达的效率，减少人工操作，提高数据的准确性和可靠性，为案件管理提供有力的支持。
