# 通知与审核功能模块全栈开发指南

## 目录
1. [功能模块概述](#1-功能模块概述)
2. [业务逻辑分析](#2-业务逻辑分析)
3. [数据库设计](#3-数据库设计)
4. [后端实现](#4-后端实现)
5. [前端实现](#5-前端实现)
6. [前后端交互流程](#6-前后端交互流程)
7. [开发注意事项](#7-开发注意事项)

---

## 1. 功能模块概述

### 1.1 四大功能模块
1. **通知模块** - 界面右上角的通知中心
2. **最新动态模块** - 工作台中的最新动态展示
3. **待办事项模块** - 工作台中的待办事项管理
4. **审核流程模块** - 用户提交、其他用户审核的审批流程

### 1.2 模块关系图
```
┌─────────────┐
│   通知中心   │ ←───────┐
│ (右上角)     │         │
└─────────────┘         │
                        │
┌─────────────┐         │
│   最新动态   │ ←───────┼───────┐
│ (工作台)     │         │       │
└─────────────┘         │       │
                        │       │
┌─────────────┐         │       │
│   待办事项   │ ←───────┼───────┼───────┐
│ (工作台)     │         │       │       │
└─────────────┘         │       │       │
                        │       │       │
┌─────────────┐         │       │       │
│   审核流程   │ ───────┘       │       │
│ (提交/审核)  │ ───────────────┘       │
└─────────────┘ ───────────────────────┘
```

---

## 2. 业务逻辑分析

### 2.1 通知模块

#### 业务场景
- 用户登录后，在界面右上角显示通知图标
- 图标上显示未读通知数量徽章
- 点击图标展开通知列表
- 支持标记已读/全部已读
- 支持删除通知
- 通知类型：系统通知、审核通知、待办提醒、动态通知

#### 数据流向
```
系统事件 → 通知服务 → 数据库存储 → WebSocket推送 → 前端展示
```

#### 核心功能点
- 实时推送新通知
- 未读数量统计
- 通知分类展示
- 通知跳转关联业务

### 2.2 最新动态模块

#### 业务场景
- 在工作台首页展示系统最新动态
- 记录用户的操作日志（如：创建案件、上传文件、完成审核等）
- 按时间倒序展示
- 支持分页加载
- 支持按类型筛选

#### 数据流向
```
用户操作 → 动态记录服务 → 数据库存储 → 前端查询展示
```

#### 核心功能点
- 动态类型定义
- 动态内容模板化
- 时间轴展示
- 关联业务跳转

### 2.3 待办事项模块

#### 业务场景
- 展示当前用户需要处理的任务
- 支持标记完成/取消完成
- 支持设置优先级（高、中、低）
- 支持设置截止时间
- 支持添加备注
- 待办来源：审核任务、系统分配、手动创建

#### 数据流向
```
任务创建 → 待办服务 → 数据库存储 → 前端展示 → 状态更新
```

#### 核心功能点
- 待办状态管理
- 优先级排序
- 截止时间提醒
- 任务关联业务

### 2.4 审核流程模块

#### 业务场景
- 用户A提交审核申请（如：案件信息、法律文书等）
- 系统自动分配给审核人员（用户B）
- 审核人员查看详情并进行审核（通过/驳回）
- 审核结果通知提交人
- 支持审核意见记录
- 支持审核历史追溯

#### 数据流向
```
提交申请 → 创建审核任务 → 分配审核人 → 审核处理 → 结果通知 → 流程结束
```

#### 核心功能点
- 审核流程定义
- 审核人员分配策略
- 审核状态流转
- 审核意见记录
- 审核历史追溯

---

## 3. 数据库设计

### 3.1 表结构概览

| 表名 | 用途 | 关键字段 |
|------|------|----------|
| sys_notification | 通知表 | id, user_id, type, title, content, is_read |
| sys_activity | 动态表 | id, user_id, type, content, related_id |
| sys_todo | 待办事项表 | id, user_id, title, priority, status, deadline |
| sys_approval | 审核主表 | id, applicant_id, approver_id, type, status |
| sys_approval_log | 审核日志表 | id, approval_id, operator_id, action, opinion |

### 3.2 详细表结构（SQL Server 2008）

#### 3.2.1 通知表 (sys_notification)

```sql
CREATE TABLE sys_notification (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT '接收用户ID',
    type VARCHAR(20) NOT NULL COMMENT '通知类型：SYSTEM-系统通知, APPROVAL-审核通知, TODO-待办提醒, ACTIVITY-动态通知',
    title NVARCHAR(100) NOT NULL COMMENT '通知标题',
    content NVARCHAR(500) NOT NULL COMMENT '通知内容',
    related_type VARCHAR(50) NULL COMMENT '关联类型：CASE-案件, DOCUMENT-文书, TODO-待办',
    related_id BIGINT NULL COMMENT '关联ID',
    is_read BIT DEFAULT 0 COMMENT '是否已读：0-未读, 1-已读',
    create_time DATETIME DEFAULT GETDATE() COMMENT '创建时间',
    read_time DATETIME NULL COMMENT '阅读时间',
    is_deleted BIT DEFAULT 0 COMMENT '是否删除：0-正常, 1-已删除'
);

CREATE INDEX idx_notification_user ON sys_notification(user_id, is_read, is_deleted);
CREATE INDEX idx_notification_type ON sys_notification(type);
CREATE INDEX idx_notification_related ON sys_notification(related_type, related_id);
```

#### 3.2.2 动态表 (sys_activity)

```sql
CREATE TABLE sys_activity (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT '操作用户ID',
    user_name NVARCHAR(50) NOT NULL COMMENT '用户姓名',
    type VARCHAR(30) NOT NULL COMMENT '动态类型：CREATE_CASE-创建案件, UPLOAD_FILE-上传文件, APPROVE_PASS-审核通过, APPROVE_REJECT-审核驳回, COMPLETE_TODO-完成待办',
    content NVARCHAR(500) NOT NULL COMMENT '动态内容',
    related_type VARCHAR(50) NULL COMMENT '关联类型',
    related_id BIGINT NULL COMMENT '关联ID',
    create_time DATETIME DEFAULT GETDATE() COMMENT '创建时间'
);

CREATE INDEX idx_activity_user ON sys_activity(user_id);
CREATE INDEX idx_activity_time ON sys_activity(create_time DESC);
CREATE INDEX idx_activity_type ON sys_activity(type);
CREATE INDEX idx_activity_related ON sys_activity(related_type, related_id);
```

#### 3.2.3 待办事项表 (sys_todo)

```sql
CREATE TABLE sys_todo (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    user_id BIGINT NOT NULL COMMENT '负责人ID',
    title NVARCHAR(100) NOT NULL COMMENT '待办标题',
    description NVARCHAR(500) NULL COMMENT '待办描述',
    priority VARCHAR(10) DEFAULT 'MEDIUM' COMMENT '优先级：HIGH-高, MEDIUM-中, LOW-低',
    status VARCHAR(20) DEFAULT 'PENDING' COMMENT '状态：PENDING-待处理, IN_PROGRESS-进行中, COMPLETED-已完成, CANCELLED-已取消',
    deadline DATETIME NULL COMMENT '截止时间',
    source_type VARCHAR(30) NULL COMMENT '来源类型：MANUAL-手动创建, APPROVAL-审核任务, SYSTEM-系统分配',
    source_id BIGINT NULL COMMENT '来源ID',
    related_type VARCHAR(50) NULL COMMENT '关联类型',
    related_id BIGINT NULL COMMENT '关联ID',
    completed_time DATETIME NULL COMMENT '完成时间',
    create_time DATETIME DEFAULT GETDATE() COMMENT '创建时间',
    update_time DATETIME DEFAULT GETDATE() COMMENT '更新时间',
    is_deleted BIT DEFAULT 0 COMMENT '是否删除：0-正常, 1-已删除'
);

CREATE INDEX idx_todo_user ON sys_todo(user_id, status, is_deleted);
CREATE INDEX idx_todo_priority ON sys_todo(priority, status);
CREATE INDEX idx_todo_deadline ON sys_todo(deadline);
CREATE INDEX idx_todo_source ON sys_todo(source_type, source_id);
```

#### 3.2.4 审核主表 (sys_approval)

```sql
CREATE TABLE sys_approval (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    approval_no VARCHAR(32) NOT NULL UNIQUE COMMENT '审核编号',
    type VARCHAR(30) NOT NULL COMMENT '审核类型：CASE-案件审核, DOCUMENT-文书审核, INFO-信息审核',
    applicant_id BIGINT NOT NULL COMMENT '申请人ID',
    applicant_name NVARCHAR(50) NOT NULL COMMENT '申请人姓名',
    approver_id BIGINT NULL COMMENT '审核人ID',
    approver_name NVARCHAR(50) NULL COMMENT '审核人姓名',
    status VARCHAR(20) DEFAULT 'PENDING' COMMENT '状态：PENDING-待审核, APPROVED-已通过, REJECTED-已驳回, CANCELLED-已取消',
    title NVARCHAR(100) NOT NULL COMMENT '审核标题',
    description NVARCHAR(500) NULL COMMENT '审核描述',
    business_data NVARCHAR(MAX) NULL COMMENT '业务数据JSON',
    apply_time DATETIME DEFAULT GETDATE() COMMENT '申请时间',
    approve_time DATETIME NULL COMMENT '审核时间',
    create_time DATETIME DEFAULT GETDATE() COMMENT '创建时间',
    update_time DATETIME DEFAULT GETDATE() COMMENT '更新时间'
);

CREATE INDEX idx_approval_no ON sys_approval(approval_no);
CREATE INDEX idx_approval_applicant ON sys_approval(applicant_id, status);
CREATE INDEX idx_approval_approver ON sys_approval(approver_id, status);
CREATE INDEX idx_approval_type ON sys_approval(type);
CREATE INDEX idx_approval_time ON sys_approval(create_time DESC);
```

#### 3.2.5 审核日志表 (sys_approval_log)

```sql
CREATE TABLE sys_approval_log (
    id BIGINT IDENTITY(1,1) PRIMARY KEY,
    approval_id BIGINT NOT NULL COMMENT '审核ID',
    operator_id BIGINT NOT NULL COMMENT '操作人ID',
    operator_name NVARCHAR(50) NOT NULL COMMENT '操作人姓名',
    action VARCHAR(20) NOT NULL COMMENT '操作类型：SUBMIT-提交, APPROVE-通过, REJECT-驳回, CANCEL-取消',
    opinion NVARCHAR(500) NULL COMMENT '审核意见',
    operate_time DATETIME DEFAULT GETDATE() COMMENT '操作时间',
    remark NVARCHAR(200) NULL COMMENT '备注'
);

CREATE INDEX idx_approval_log_approval ON sys_approval_log(approval_id);
CREATE INDEX idx_approval_log_time ON sys_approval_log(operate_time DESC);
```

### 3.3 表关系图

```
sys_user (用户表)
    │
    ├── 1:N ── sys_notification (通知表)
    │
    ├── 1:N ── sys_activity (动态表)
    │
    ├── 1:N ── sys_todo (待办事项表)
    │
    ├── 1:N ── sys_approval (审核主表) [作为申请人]
    │
    └── 1:N ── sys_approval (审核主表) [作为审核人]
              │
              └── 1:N ── sys_approval_log (审核日志表)
```

---

## 4. 后端实现

### 4.1 项目结构

```
com.ls.law
├── controller
│   ├── NotificationController.java      # 通知控制器
│   ├── ActivityController.java          # 动态控制器
│   ├── TodoController.java              # 待办事项控制器
│   └── ApprovalController.java          # 审核控制器
├── entity
│   ├── Notification.java                # 通知实体
│   ├── Activity.java                    # 动态实体
│   ├── Todo.java                        # 待办实体
│   ├── Approval.java                    # 审核实体
│   └── ApprovalLog.java                 # 审核日志实体
├── mapper
│   ├── NotificationMapper.java          # 通知Mapper
│   ├── ActivityMapper.java              # 动态Mapper
│   ├── TodoMapper.java                  # 待办Mapper
│   ├── ApprovalMapper.java              # 审核Mapper
│   └── ApprovalLogMapper.java           # 审核日志Mapper
├── service
│   ├── NotificationService.java         # 通知服务接口
│   ├── NotificationServiceImpl.java     # 通知服务实现
│   ├── ActivityService.java             # 动态服务接口
│   ├── ActivityServiceImpl.java         # 动态服务实现
│   ├── TodoService.java                 # 待办服务接口
│   ├── TodoServiceImpl.java             # 待办服务实现
│   ├── ApprovalService.java             # 审核服务接口
│   ├── ApprovalServiceImpl.java         # 审核服务实现
│   └── NotificationPushService.java     # 通知推送服务
├── model
│   ├── dto
│   │   ├── NotificationDTO.java         # 通知DTO
│   │   ├── ActivityDTO.java             # 动态DTO
│   │   ├── TodoDTO.java                 # 待办DTO
│   │   ├── ApprovalDTO.java             # 审核DTO
│   │   └── ApprovalSubmitDTO.java       # 审核提交DTO
│   └── vo
│       ├── NotificationVO.java          # 通知VO
│       ├── ActivityVO.java              # 动态VO
│       ├── TodoVO.java                  # 待办VO
│       └── ApprovalVO.java              # 审核VO
└── enums
    ├── NotificationTypeEnum.java        # 通知类型枚举
    ├── ActivityTypeEnum.java            # 动态类型枚举
    ├── TodoStatusEnum.java              # 待办状态枚举
    ├── TodoPriorityEnum.java            # 待办优先级枚举
    ├── ApprovalStatusEnum.java          # 审核状态枚举
    └── ApprovalTypeEnum.java            # 审核类型枚举
```

### 4.2 实体类定义

#### 4.2.1 Notification.java

```java
package com.ls.law.entity;

import lombok.Data;
import java.util.Date;

@Data
public class Notification {
    private Long id;
    private Long userId;
    private String type;
    private String title;
    private String content;
    private String relatedType;
    private Long relatedId;
    private Boolean isRead;
    private Date createTime;
    private Date readTime;
    private Boolean isDeleted;
}
```

#### 4.2.2 Activity.java

```java
package com.ls.law.entity;

import lombok.Data;
import java.util.Date;

@Data
public class Activity {
    private Long id;
    private Long userId;
    private String userName;
    private String type;
    private String content;
    private String relatedType;
    private Long relatedId;
    private Date createTime;
}
```

#### 4.2.3 Todo.java

```java
package com.ls.law.entity;

import lombok.Data;
import java.util.Date;

@Data
public class Todo {
    private Long id;
    private Long userId;
    private String title;
    private String description;
    private String priority;
    private String status;
    private Date deadline;
    private String sourceType;
    private Long sourceId;
    private String relatedType;
    private Long relatedId;
    private Date completedTime;
    private Date createTime;
    private Date updateTime;
    private Boolean isDeleted;
}
```

#### 4.2.4 Approval.java

```java
package com.ls.law.entity;

import lombok.Data;
import java.util.Date;

@Data
public class Approval {
    private Long id;
    private String approvalNo;
    private String type;
    private Long applicantId;
    private String applicantName;
    private Long approverId;
    private String approverName;
    private String status;
    private String title;
    private String description;
    private String businessData;
    private Date applyTime;
    private Date approveTime;
    private Date createTime;
    private Date updateTime;
}
```

#### 4.2.5 ApprovalLog.java

```java
package com.ls.law.entity;

import lombok.Data;
import java.util.Date;

@Data
public class ApprovalLog {
    private Long id;
    private Long approvalId;
    private Long operatorId;
    private String operatorName;
    private String action;
    private String opinion;
    private Date operateTime;
    private String remark;
}
```

### 4.3 枚举类定义

#### 4.3.1 NotificationTypeEnum.java

```java
package com.ls.law.enums;

public enum NotificationTypeEnum {
    SYSTEM("SYSTEM", "系统通知"),
    APPROVAL("APPROVAL", "审核通知"),
    TODO("TODO", "待办提醒"),
    ACTIVITY("ACTIVITY", "动态通知");

    private String code;
    private String desc;

    NotificationTypeEnum(String code, String desc) {
        this.code = code;
        this.desc = desc;
    }

    public String getCode() {
        return code;
    }

    public String getDesc() {
        return desc;
    }
}
```

#### 4.3.2 ApprovalStatusEnum.java

```java
package com.ls.law.enums;

public enum ApprovalStatusEnum {
    PENDING("PENDING", "待审核"),
    APPROVED("APPROVED", "已通过"),
    REJECTED("REJECTED", "已驳回"),
    CANCELLED("CANCELLED", "已取消");

    private String code;
    private String desc;

    ApprovalStatusEnum(String code, String desc) {
        this.code = code;
        this.desc = desc;
    }

    public String getCode() {
        return code;
    }

    public String getDesc() {
        return desc;
    }
}
```

### 4.4 Controller层实现

#### 4.4.1 NotificationController.java

```java
package com.ls.law.controller;

import com.ls.law.model.vo.NotificationVO;
import com.ls.law.service.NotificationService;
import com.ls.law.utils.Result;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/notification")
public class NotificationController {

    @Autowired
    private NotificationService notificationService;

    @GetMapping("/list")
    public Result<List<NotificationVO>> getNotificationList(
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "20") Integer pageSize) {
        Long userId = getCurrentUserId();
        return Result.success(notificationService.getNotificationList(userId, page, pageSize));
    }

    @GetMapping("/unread/count")
    public Result<Long> getUnreadCount() {
        Long userId = getCurrentUserId();
        return Result.success(notificationService.getUnreadCount(userId));
    }

    @PutMapping("/{id}/read")
    public Result<Void> markAsRead(@PathVariable Long id) {
        Long userId = getCurrentUserId();
        notificationService.markAsRead(id, userId);
        return Result.success();
    }

    @PutMapping("/read/all")
    public Result<Void> markAllAsRead() {
        Long userId = getCurrentUserId();
        notificationService.markAllAsRead(userId);
        return Result.success();
    }

    @DeleteMapping("/{id}")
    public Result<Void> deleteNotification(@PathVariable Long id) {
        Long userId = getCurrentUserId();
        notificationService.deleteNotification(id, userId);
        return Result.success();
    }

    private Long getCurrentUserId() {
        return 1L;
    }
}
```

#### 4.4.2 ActivityController.java

```java
package com.ls.law.controller;

import com.ls.law.model.vo.ActivityVO;
import com.ls.law.service.ActivityService;
import com.ls.law.utils.Result;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/activity")
public class ActivityController {

    @Autowired
    private ActivityService activityService;

    @GetMapping("/list")
    public Result<List<ActivityVO>> getActivityList(
            @RequestParam(required = false) String type,
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "20") Integer pageSize) {
        return Result.success(activityService.getActivityList(type, page, pageSize));
    }

    @GetMapping("/my")
    public Result<List<ActivityVO>> getMyActivityList(
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "20") Integer pageSize) {
        Long userId = getCurrentUserId();
        return Result.success(activityService.getActivityByUserId(userId, page, pageSize));
    }

    private Long getCurrentUserId() {
        return 1L;
    }
}
```

#### 4.4.3 TodoController.java

```java
package com.ls.law.controller;

import com.ls.law.model.dto.TodoDTO;
import com.ls.law.model.vo.TodoVO;
import com.ls.law.service.TodoService;
import com.ls.law.utils.Result;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;

@RestController
@RequestMapping("/api/todo")
public class TodoController {

    @Autowired
    private TodoService todoService;

    @GetMapping("/list")
    public Result<List<TodoVO>> getTodoList(
            @RequestParam(required = false) String status,
            @RequestParam(required = false) String priority,
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "20") Integer pageSize) {
        Long userId = getCurrentUserId();
        return Result.success(todoService.getTodoList(userId, status, priority, page, pageSize));
    }

    @PostMapping
    public Result<Long> createTodo(@RequestBody TodoDTO todoDTO) {
        Long userId = getCurrentUserId();
        todoDTO.setUserId(userId);
        Long todoId = todoService.createTodo(todoDTO);
        return Result.success(todoId);
    }

    @PutMapping("/{id}")
    public Result<Void> updateTodo(@PathVariable Long id, @RequestBody TodoDTO todoDTO) {
        Long userId = getCurrentUserId();
        todoService.updateTodo(id, userId, todoDTO);
        return Result.success();
    }

    @PutMapping("/{id}/complete")
    public Result<Void> completeTodo(@PathVariable Long id) {
        Long userId = getCurrentUserId();
        todoService.completeTodo(id, userId);
        return Result.success();
    }

    @PutMapping("/{id}/cancel")
    public Result<Void> cancelTodo(@PathVariable Long id) {
        Long userId = getCurrentUserId();
        todoService.cancelTodo(id, userId);
        return Result.success();
    }

    @DeleteMapping("/{id}")
    public Result<Void> deleteTodo(@PathVariable Long id) {
        Long userId = getCurrentUserId();
        todoService.deleteTodo(id, userId);
        return Result.success();
    }

    private Long getCurrentUserId() {
        return 1L;
    }
}
```

#### 4.4.4 ApprovalController.java

```java
package com.ls.law.controller;

import com.ls.law.model.dto.ApprovalDTO;
import com.ls.law.model.dto.ApprovalSubmitDTO;
import com.ls.law.model.vo.ApprovalVO;
import com.ls.law.service.ApprovalService;
import com.ls.law.utils.Result;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.web.bind.annotation.*;

import java.util.List;
import java.util.Map;

@RestController
@RequestMapping("/api/approval")
public class ApprovalController {

    @Autowired
    private ApprovalService approvalService;

    @GetMapping("/list")
    public Result<List<ApprovalVO>> getApprovalList(
            @RequestParam(required = false) String status,
            @RequestParam(required = false) String type,
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "20") Integer pageSize) {
        Long userId = getCurrentUserId();
        return Result.success(approvalService.getApprovalList(userId, status, type, page, pageSize));
    }

    @GetMapping("/pending")
    public Result<List<ApprovalVO>> getPendingApprovals(
            @RequestParam(defaultValue = "1") Integer page,
            @RequestParam(defaultValue = "20") Integer pageSize) {
        Long userId = getCurrentUserId();
        return Result.success(approvalService.getPendingApprovals(userId, page, pageSize));
    }

    @GetMapping("/{id}")
    public Result<ApprovalVO> getApprovalDetail(@PathVariable Long id) {
        Long userId = getCurrentUserId();
        return Result.success(approvalService.getApprovalDetail(id, userId));
    }

    @PostMapping
    public Result<Long> submitApproval(@RequestBody ApprovalSubmitDTO submitDTO) {
        Long userId = getCurrentUserId();
        Long approvalId = approvalService.submitApproval(submitDTO, userId);
        return Result.success(approvalId);
    }

    @PutMapping("/{id}/approve")
    public Result<Void> approve(@PathVariable Long id, @RequestBody Map<String, String> params) {
        Long userId = getCurrentUserId();
        String opinion = params.get("opinion");
        approvalService.approve(id, userId, opinion);
        return Result.success();
    }

    @PutMapping("/{id}/reject")
    public Result<Void> reject(@PathVariable Long id, @RequestBody Map<String, String> params) {
        Long userId = getCurrentUserId();
        String opinion = params.get("opinion");
        approvalService.reject(id, userId, opinion);
        return Result.success();
    }

    @PutMapping("/{id}/cancel")
    public Result<Void> cancel(@PathVariable Long id) {
        Long userId = getCurrentUserId();
        approvalService.cancel(id, userId);
        return Result.success();
    }

    @GetMapping("/{id}/logs")
    public Result<List> getApprovalLogs(@PathVariable Long id) {
        return Result.success(approvalService.getApprovalLogs(id));
    }

    private Long getCurrentUserId() {
        return 1L;
    }
}
```

### 4.5 Service层实现

#### 4.5.1 NotificationService.java

```java
package com.ls.law.service;

import com.ls.law.model.vo.NotificationVO;
import java.util.List;

public interface NotificationService {
    List<NotificationVO> getNotificationList(Long userId, Integer page, Integer pageSize);
    Long getUnreadCount(Long userId);
    void markAsRead(Long id, Long userId);
    void markAllAsRead(Long userId);
    void deleteNotification(Long id, Long userId);
    void sendNotification(Long userId, String type, String title, String content, String relatedType, Long relatedId);
}
```

#### 4.5.2 NotificationServiceImpl.java

```java
package com.ls.law.service;

import com.ls.law.entity.Notification;
import com.ls.law.mapper.NotificationMapper;
import com.ls.law.model.vo.NotificationVO;
import com.ls.law.service.websocket.NotificationPushService;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.ArrayList;
import java.util.Date;
import java.util.List;

@Service
public class NotificationServiceImpl implements NotificationService {

    @Autowired
    private NotificationMapper notificationMapper;

    @Autowired
    private NotificationPushService notificationPushService;

    @Override
    public List<NotificationVO> getNotificationList(Long userId, Integer page, Integer pageSize) {
        Integer offset = (page - 1) * pageSize;
        List<Notification> notifications = notificationMapper.selectByUserId(userId, offset, pageSize);
        List<NotificationVO> result = new ArrayList<>();
        for (Notification notification : notifications) {
            NotificationVO vo = new NotificationVO();
            BeanUtils.copyProperties(notification, vo);
            result.add(vo);
        }
        return result;
    }

    @Override
    public Long getUnreadCount(Long userId) {
        return notificationMapper.countUnread(userId);
    }

    @Override
    @Transactional
    public void markAsRead(Long id, Long userId) {
        Notification notification = notificationMapper.selectById(id);
        if (notification != null && notification.getUserId().equals(userId)) {
            notification.setIsRead(true);
            notification.setReadTime(new Date());
            notificationMapper.updateById(notification);
        }
    }

    @Override
    @Transactional
    public void markAllAsRead(Long userId) {
        notificationMapper.markAllAsRead(userId);
    }

    @Override
    @Transactional
    public void deleteNotification(Long id, Long userId) {
        Notification notification = notificationMapper.selectById(id);
        if (notification != null && notification.getUserId().equals(userId)) {
            notification.setIsDeleted(true);
            notificationMapper.updateById(notification);
        }
    }

    @Override
    @Transactional
    public void sendNotification(Long userId, String type, String title, String content, String relatedType, Long relatedId) {
        Notification notification = new Notification();
        notification.setUserId(userId);
        notification.setType(type);
        notification.setTitle(title);
        notification.setContent(content);
        notification.setRelatedType(relatedType);
        notification.setRelatedId(relatedId);
        notification.setIsRead(false);
        notification.setCreateTime(new Date());
        notification.setIsDeleted(false);
        notificationMapper.insert(notification);

        notificationPushService.pushNotification(userId, notification);
    }
}
```

#### 4.5.3 ApprovalService.java

```java
package com.ls.law.service;

import com.ls.law.model.dto.ApprovalSubmitDTO;
import com.ls.law.model.vo.ApprovalVO;
import java.util.List;

public interface ApprovalService {
    List<ApprovalVO> getApprovalList(Long userId, String status, String type, Integer page, Integer pageSize);
    List<ApprovalVO> getPendingApprovals(Long userId, Integer page, Integer pageSize);
    ApprovalVO getApprovalDetail(Long id, Long userId);
    Long submitApproval(ApprovalSubmitDTO submitDTO, Long userId);
    void approve(Long id, Long userId, String opinion);
    void reject(Long id, Long userId, String opinion);
    void cancel(Long id, Long userId);
    List getApprovalLogs(Long id);
}
```

#### 4.5.4 ApprovalServiceImpl.java

```java
package com.ls.law.service;

import com.alibaba.fastjson.JSON;
import com.ls.law.entity.Approval;
import com.ls.law.entity.ApprovalLog;
import com.ls.law.enums.ApprovalStatusEnum;
import com.ls.law.mapper.ApprovalLogMapper;
import com.ls.law.mapper.ApprovalMapper;
import com.ls.law.model.dto.ApprovalSubmitDTO;
import com.ls.law.model.vo.ApprovalVO;
import com.ls.law.service.websocket.NotificationPushService;
import org.springframework.beans.BeanUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.text.SimpleDateFormat;
import java.util.*;

@Service
public class ApprovalServiceImpl implements ApprovalService {

    @Autowired
    private ApprovalMapper approvalMapper;

    @Autowired
    private ApprovalLogMapper approvalLogMapper;

    @Autowired
    private NotificationPushService notificationPushService;

    @Autowired
    private ActivityService activityService;

    @Autowired
    private TodoService todoService;

    @Override
    public List<ApprovalVO> getApprovalList(Long userId, String status, String type, Integer page, Integer pageSize) {
        Integer offset = (page - 1) * pageSize;
        List<Approval> approvals = approvalMapper.selectByUserId(userId, status, type, offset, pageSize);
        List<ApprovalVO> result = new ArrayList<>();
        for (Approval approval : approvals) {
            ApprovalVO vo = new ApprovalVO();
            BeanUtils.copyProperties(approval, vo);
            result.add(vo);
        }
        return result;
    }

    @Override
    public List<ApprovalVO> getPendingApprovals(Long userId, Integer page, Integer pageSize) {
        Integer offset = (page - 1) * pageSize;
        List<Approval> approvals = approvalMapper.selectByApproverIdAndStatus(userId, ApprovalStatusEnum.PENDING.getCode(), offset, pageSize);
        List<ApprovalVO> result = new ArrayList<>();
        for (Approval approval : approvals) {
            ApprovalVO vo = new ApprovalVO();
            BeanUtils.copyProperties(approval, vo);
            result.add(vo);
        }
        return result;
    }

    @Override
    public ApprovalVO getApprovalDetail(Long id, Long userId) {
        Approval approval = approvalMapper.selectById(id);
        if (approval == null) {
            return null;
        }
        ApprovalVO vo = new ApprovalVO();
        BeanUtils.copyProperties(approval, vo);
        return vo;
    }

    @Override
    @Transactional
    public Long submitApproval(ApprovalSubmitDTO submitDTO, Long userId) {
        Approval approval = new Approval();
        approval.setApprovalNo(generateApprovalNo());
        approval.setType(submitDTO.getType());
        approval.setApplicantId(userId);
        approval.setApplicantName(submitDTO.getApplicantName());
        approval.setApproverId(submitDTO.getApproverId());
        approval.setApproverName(submitDTO.getApproverName());
        approval.setStatus(ApprovalStatusEnum.PENDING.getCode());
        approval.setTitle(submitDTO.getTitle());
        approval.setDescription(submitDTO.getDescription());
        approval.setBusinessData(JSON.toJSONString(submitDTO.getBusinessData()));
        approval.setApplyTime(new Date());
        approval.setCreateTime(new Date());
        approval.setUpdateTime(new Date());
        approvalMapper.insert(approval);

        ApprovalLog log = new ApprovalLog();
        log.setApprovalId(approval.getId());
        log.setOperatorId(userId);
        log.setOperatorName(submitDTO.getApplicantName());
        log.setAction("SUBMIT");
        log.setOpinion("提交审核申请");
        log.setOperateTime(new Date());
        approvalLogMapper.insert(log);

        notificationPushService.pushApprovalNotification(approval.getApproverId(), approval);

        todoService.createApprovalTodo(approval);

        activityService.recordActivity(userId, "提交审核申请", approval.getType(), approval.getId());

        return approval.getId();
    }

    @Override
    @Transactional
    public void approve(Long id, Long userId, String opinion) {
        Approval approval = approvalMapper.selectById(id);
        if (approval == null || !approval.getApproverId().equals(userId)) {
            throw new RuntimeException("无权操作");
        }
        if (!ApprovalStatusEnum.PENDING.getCode().equals(approval.getStatus())) {
            throw new RuntimeException("当前状态不允许审核");
        }

        approval.setStatus(ApprovalStatusEnum.APPROVED.getCode());
        approval.setApproveTime(new Date());
        approval.setUpdateTime(new Date());
        approvalMapper.updateById(approval);

        ApprovalLog log = new ApprovalLog();
        log.setApprovalId(id);
        log.setOperatorId(userId);
        log.setOperatorName(approval.getApproverName());
        log.setAction("APPROVE");
        log.setOpinion(opinion);
        log.setOperateTime(new Date());
        approvalLogMapper.insert(log);

        notificationPushService.pushApprovalResultNotification(approval.getApplicantId(), approval, true);

        todoService.completeApprovalTodo(approval.getId());

        activityService.recordActivity(userId, "审核通过", approval.getType(), approval.getId());
    }

    @Override
    @Transactional
    public void reject(Long id, Long userId, String opinion) {
        Approval approval = approvalMapper.selectById(id);
        if (approval == null || !approval.getApproverId().equals(userId)) {
            throw new RuntimeException("无权操作");
        }
        if (!ApprovalStatusEnum.PENDING.getCode().equals(approval.getStatus())) {
            throw new RuntimeException("当前状态不允许审核");
        }

        approval.setStatus(ApprovalStatusEnum.REJECTED.getCode());
        approval.setApproveTime(new Date());
        approval.setUpdateTime(new Date());
        approvalMapper.updateById(approval);

        ApprovalLog log = new ApprovalLog();
        log.setApprovalId(id);
        log.setOperatorId(userId);
        log.setOperatorName(approval.getApproverName());
        log.setAction("REJECT");
        log.setOpinion(opinion);
        log.setOperateTime(new Date());
        approvalLogMapper.insert(log);

        notificationPushService.pushApprovalResultNotification(approval.getApplicantId(), approval, false);

        todoService.completeApprovalTodo(approval.getId());

        activityService.recordActivity(userId, "审核驳回", approval.getType(), approval.getId());
    }

    @Override
    @Transactional
    public void cancel(Long id, Long userId) {
        Approval approval = approvalMapper.selectById(id);
        if (approval == null || !approval.getApplicantId().equals(userId)) {
            throw new RuntimeException("无权操作");
        }
        if (!ApprovalStatusEnum.PENDING.getCode().equals(approval.getStatus())) {
            throw new RuntimeException("当前状态不允许取消");
        }

        approval.setStatus(ApprovalStatusEnum.CANCELLED.getCode());
        approval.setUpdateTime(new Date());
        approvalMapper.updateById(approval);

        ApprovalLog log = new ApprovalLog();
        log.setApprovalId(id);
        log.setOperatorId(userId);
        log.setOperatorName(approval.getApplicantName());
        log.setAction("CANCEL");
        log.setOpinion("取消审核申请");
        log.setOperateTime(new Date());
        approvalLogMapper.insert(log);

        todoService.completeApprovalTodo(approval.getId());
    }

    @Override
    public List getApprovalLogs(Long id) {
        return approvalLogMapper.selectByApprovalId(id);
    }

    private String generateApprovalNo() {
        SimpleDateFormat sdf = new SimpleDateFormat("yyyyMMddHHmmss");
        return "AP" + sdf.format(new Date()) + (int)(Math.random() * 1000);
    }
}
```

### 4.6 WebSocket推送服务

#### 4.6.1 NotificationPushService.java

```java
package com.ls.law.service.websocket;

import com.ls.law.entity.Approval;
import com.ls.law.entity.Notification;
import com.ls.law.service.ActivityService;
import com.ls.law.service.NotificationService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

@Service
public class NotificationPushService {

    @Autowired
    private WebSocketHandler webSocketHandler;

    @Autowired
    private NotificationService notificationService;

    @Autowired
    private ActivityService activityService;

    public void pushNotification(Long userId, Notification notification) {
        webSocketHandler.sendToUser(userId, notification);
    }

    public void pushApprovalNotification(Long approverId, Approval approval) {
        notificationService.sendNotification(
            approverId,
            "APPROVAL",
            "新的审核任务",
            "您有一条新的" + approval.getTitle() + "需要审核",
            "APPROVAL",
            approval.getId()
        );
    }

    public void pushApprovalResultNotification(Long applicantId, Approval approval, boolean isApproved) {
        String title = isApproved ? "审核通过" : "审核驳回";
        String content = "您的" + approval.getTitle() + (isApproved ? "已通过审核" : "已被驳回");
        notificationService.sendNotification(
            applicantId,
            "APPROVAL",
            title,
            content,
            "APPROVAL",
            approval.getId()
        );
    }
}
```

### 4.7 Mapper层实现

#### 4.7.1 NotificationMapper.java

```java
package com.ls.law.mapper;

import com.ls.law.entity.Notification;
import org.apache.ibatis.annotations.*;
import java.util.List;

@Mapper
public interface NotificationMapper {
    @Select("SELECT * FROM sys_notification WHERE user_id = #{userId} AND is_deleted = 0 ORDER BY create_time DESC OFFSET #{offset} ROWS FETCH NEXT #{pageSize} ROWS ONLY")
    List<Notification> selectByUserId(@Param("userId") Long userId, @Param("offset") Integer offset, @Param("pageSize") Integer pageSize);

    @Select("SELECT COUNT(*) FROM sys_notification WHERE user_id = #{userId} AND is_read = 0 AND is_deleted = 0")
    Long countUnread(@Param("userId") Long userId);

    @Select("SELECT * FROM sys_notification WHERE id = #{id}")
    Notification selectById(@Param("id") Long id);

    @Insert("INSERT INTO sys_notification (user_id, type, title, content, related_type, related_id, is_read, create_time, is_deleted) VALUES (#{userId}, #{type}, #{title}, #{content}, #{relatedType}, #{relatedId}, #{isRead}, #{createTime}, #{isDeleted})")
    @Options(useGeneratedKeys = true, keyProperty = "id")
    void insert(Notification notification);

    @Update("UPDATE sys_notification SET is_read = #{isRead}, read_time = #{readTime} WHERE id = #{id}")
    void updateById(Notification notification);

    @Update("UPDATE sys_notification SET is_read = 1, read_time = GETDATE() WHERE user_id = #{userId} AND is_read = 0 AND is_deleted = 0")
    void markAllAsRead(@Param("userId") Long userId);
}
```

---

## 5. 前端实现

### 5.1 项目结构

```
src
├── api
│   ├── notification.ts          # 通知API
│   ├── activity.ts              # 动态API
│   ├── todo.ts                  # 待办API
│   └── approval.ts              # 审核API
├── views
│   ├── dashboard
│   │   └── index.vue            # 工作台（包含最新动态、待办事项）
│   ├── notification
│   │   └── index.vue            # 通知中心
│   └── approval
│       ├── list.vue             # 审核列表
│       ├── detail.vue           # 审核详情
│       └── submit.vue           # 提交审核
├── components
│   ├── NotificationBadge.vue    # 通知徽章组件
│   ├── NotificationDropdown.vue # 通知下拉组件
│   ├── ActivityTimeline.vue     # 动态时间轴组件
│   ├── TodoList.vue             # 待办列表组件
│   └── ApprovalCard.vue         # 审核卡片组件
├── hooks
│   ├── useNotification.ts       # 通知Hook
│   ├── useActivity.ts          # 动态Hook
│   ├── useTodo.ts               # 待办Hook
│   └── useApproval.ts           # 审核Hook
├── stores
│   ├── notification.ts          # 通知Store
│   ├── activity.ts              # 动态Store
│   ├── todo.ts                  # 待办Store
│   └── approval.ts              # 审核Store
└── websocket
    └── notification.ts          # WebSocket通知连接
```

### 5.2 API层实现

#### 5.2.1 api/notification.ts

```typescript
import { requestClient } from '#/api/request';

export interface Notification {
  id: number;
  userId: number;
  type: string;
  title: string;
  content: string;
  relatedType?: string;
  relatedId?: number;
  isRead: boolean;
  createTime: string;
  readTime?: string;
}

export interface NotificationListResponse {
  code: number;
  message: string;
  data: Notification[];
}

export const notificationApi = {
  getNotificationList: (page: number = 1, pageSize: number = 20) => {
    return requestClient.get<NotificationListResponse>('/api/notification/list', {
      params: { page, pageSize },
    });
  },

  getUnreadCount: () => {
    return requestClient.get<{ code: number; message: string; data: number }>(
      '/api/notification/unread/count',
    );
  },

  markAsRead: (id: number) => {
    return requestClient.put(`/api/notification/${id}/read`);
  },

  markAllAsRead: () => {
    return requestClient.put('/api/notification/read/all');
  },

  deleteNotification: (id: number) => {
    return requestClient.delete(`/api/notification/${id}`);
  },
};
```

#### 5.2.2 api/activity.ts

```typescript
import { requestClient } from '#/api/request';

export interface Activity {
  id: number;
  userId: number;
  userName: string;
  type: string;
  content: string;
  relatedType?: string;
  relatedId?: number;
  createTime: string;
}

export const activityApi = {
  getActivityList: (type?: string, page: number = 1, pageSize: number = 20) => {
    return requestClient.get('/api/activity/list', {
      params: { type, page, pageSize },
    });
  },

  getMyActivityList: (page: number = 1, pageSize: number = 20) => {
    return requestClient.get('/api/activity/my', {
      params: { page, pageSize },
    });
  },
};
```

#### 5.2.3 api/todo.ts

```typescript
import { requestClient } from '#/api/request';

export interface Todo {
  id: number;
  userId: number;
  title: string;
  description?: string;
  priority: string;
  status: string;
  deadline?: string;
  sourceType?: string;
  sourceId?: number;
  relatedType?: string;
  relatedId?: number;
  completedTime?: string;
  createTime: string;
  updateTime: string;
}

export interface TodoDTO {
  title: string;
  description?: string;
  priority?: string;
  deadline?: string;
  relatedType?: string;
  relatedId?: number;
}

export const todoApi = {
  getTodoList: (status?: string, priority?: string, page: number = 1, pageSize: number = 20) => {
    return requestClient.get('/api/todo/list', {
      params: { status, priority, page, pageSize },
    });
  },

  createTodo: (data: TodoDTO) => {
    return requestClient.post('/api/todo', data);
  },

  updateTodo: (id: number, data: Partial<TodoDTO>) => {
    return requestClient.put(`/api/todo/${id}`, data);
  },

  completeTodo: (id: number) => {
    return requestClient.put(`/api/todo/${id}/complete`);
  },

  cancelTodo: (id: number) => {
    return requestClient.put(`/api/todo/${id}/cancel`);
  },

  deleteTodo: (id: number) => {
    return requestClient.delete(`/api/todo/${id}`);
  },
};
```

#### 5.2.4 api/approval.ts

```typescript
import { requestClient } from '#/api/request';

export interface Approval {
  id: number;
  approvalNo: string;
  type: string;
  applicantId: number;
  applicantName: string;
  approverId?: number;
  approverName?: string;
  status: string;
  title: string;
  description?: string;
  businessData?: string;
  applyTime: string;
  approveTime?: string;
  createTime: string;
  updateTime: string;
}

export interface ApprovalSubmitDTO {
  type: string;
  applicantName: string;
  approverId: number;
  approverName: string;
  title: string;
  description?: string;
  businessData?: Record<string, any>;
}

export const approvalApi = {
  getApprovalList: (status?: string, type?: string, page: number = 1, pageSize: number = 20) => {
    return requestClient.get('/api/approval/list', {
      params: { status, type, page, pageSize },
    });
  },

  getPendingApprovals: (page: number = 1, pageSize: number = 20) => {
    return requestClient.get('/api/approval/pending', {
      params: { page, pageSize },
    });
  },

  getApprovalDetail: (id: number) => {
    return requestClient.get(`/api/approval/${id}`);
  },

  submitApproval: (data: ApprovalSubmitDTO) => {
    return requestClient.post('/api/approval', data);
  },

  approve: (id: number, opinion?: string) => {
    return requestClient.put(`/api/approval/${id}/approve`, { opinion });
  },

  reject: (id: number, opinion?: string) => {
    return requestClient.put(`/api/approval/${id}/reject`, { opinion });
  },

  cancel: (id: number) => {
    return requestClient.put(`/api/approval/${id}/cancel`);
  },

  getApprovalLogs: (id: number) => {
    return requestClient.get(`/api/approval/${id}/logs`);
  },
};
```

### 5.3 组件实现

#### 5.3.1 components/NotificationBadge.vue

```vue
<template>
  <div class="notification-badge">
    <Badge :count="unreadCount" :offset="[10, 0]">
      <Button type="text" @click="toggleDropdown">
        <Icon icon="lucide:bell" :size="20" />
      </Button>
    </Badge>

    <Dropdown v-model:open="dropdownVisible" :trigger="['click']" placement="bottomRight">
      <template #overlay>
        <div class="notification-dropdown">
          <div class="notification-header">
            <span class="title">通知中心</span>
            <Button type="link" size="small" @click="markAllAsRead">
              全部已读
            </Button>
          </div>
          <div class="notification-list" v-loading="loading">
            <div
              v-for="item in notifications"
              :key="item.id"
              class="notification-item"
              :class="{ unread: !item.isRead }"
              @click="handleNotificationClick(item)"
            >
              <div class="notification-content">
                <div class="notification-title">{{ item.title }}</div>
                <div class="notification-text">{{ item.content }}</div>
                <div class="notification-time">{{ formatTime(item.createTime) }}</div>
              </div>
              <div class="notification-actions">
                <Button type="text" size="small" @click.stop="deleteNotification(item.id)">
                  <Icon icon="lucide:trash-2" :size="14" />
                </Button>
              </div>
            </div>
            <div v-if="notifications.length === 0" class="notification-empty">
              暂无通知
            </div>
          </div>
          <div class="notification-footer">
            <Button type="link" block @click="goToNotificationCenter">
              查看全部通知
            </Button>
          </div>
        </div>
      </template>
    </Dropdown>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, onUnmounted } from 'vue';
import { useRouter } from 'vue-router';
import { notificationApi } from '#/api/notification';
import { useWebSocket } from '#/websocket/notification';
import { Badge, Button, Dropdown, Icon } from 'ant-design-vue';
import { formatTime } from '#/utils/date';

const router = useRouter();
const dropdownVisible = ref(false);
const loading = ref(false);
const notifications = ref<any[]>([]);
const unreadCount = ref(0);

const { connect, disconnect, onMessage } = useWebSocket();

const loadNotifications = async () => {
  loading.value = true;
  try {
    const res = await notificationApi.getNotificationList(1, 10);
    notifications.value = res.data || [];
  } catch (error) {
    console.error('加载通知失败:', error);
  } finally {
    loading.value = false;
  }
};

const loadUnreadCount = async () => {
  try {
    const res = await notificationApi.getUnreadCount();
    unreadCount.value = res.data || 0;
  } catch (error) {
    console.error('加载未读数量失败:', error);
  }
};

const toggleDropdown = () => {
  dropdownVisible.value = !dropdownVisible.value;
  if (dropdownVisible.value) {
    loadNotifications();
  }
};

const handleNotificationClick = async (item: any) => {
  if (!item.isRead) {
    await notificationApi.markAsRead(item.id);
    item.isRead = true;
    loadUnreadCount();
  }
  if (item.relatedType && item.relatedId) {
    router.push(`/${item.relatedType.toLowerCase()}/${item.relatedId}`);
  }
  dropdownVisible.value = false;
};

const markAllAsRead = async () => {
  await notificationApi.markAllAsRead();
  notifications.value.forEach((item) => {
    item.isRead = true;
  });
  loadUnreadCount();
};

const deleteNotification = async (id: number) => {
  await notificationApi.deleteNotification(id);
  notifications.value = notifications.value.filter((item) => item.id !== id);
  loadUnreadCount();
};

const goToNotificationCenter = () => {
  router.push('/notification');
  dropdownVisible.value = false;
};

const handleWebSocketMessage = (data: any) => {
  notifications.value.unshift(data);
  if (!data.isRead) {
    unreadCount.value++;
  }
};

onMounted(() => {
  loadUnreadCount();
  connect();
  onMessage(handleWebSocketMessage);
});

onUnmounted(() => {
  disconnect();
});
</script>

<style scoped lang="less">
.notification-badge {
  position: relative;
}

.notification-dropdown {
  width: 380px;
  max-height: 500px;
  background: #fff;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.notification-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  border-bottom: 1px solid #f0f0f0;

  .title {
    font-weight: 600;
    font-size: 16px;
  }
}

.notification-list {
  max-height: 350px;
  overflow-y: auto;
}

.notification-item {
  display: flex;
  justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 1px solid #f0f0f0;
  cursor: pointer;
  transition: background-color 0.2s;

  &:hover {
    background-color: #f5f5f5;
  }

  &.unread {
    background-color: #e6f7ff;
  }
}

.notification-content {
  flex: 1;
}

.notification-title {
  font-weight: 500;
  margin-bottom: 4px;
}

.notification-text {
  font-size: 13px;
  color: #666;
  margin-bottom: 4px;
}

.notification-time {
  font-size: 12px;
  color: #999;
}

.notification-empty {
  padding: 40px;
  text-align: center;
  color: #999;
}

.notification-footer {
  padding: 8px 16px;
  border-top: 1px solid #f0f0f0;
}
</style>
```

#### 5.3.2 components/ActivityTimeline.vue

```vue
<template>
  <div class="activity-timeline">
    <div class="activity-header">
      <h3>最新动态</h3>
      <Select
        v-model:value="selectedType"
        style="width: 120px"
        @change="loadActivities"
      >
        <Select.Option value="">全部</Select.Option>
        <Select.Option value="CREATE_CASE">创建案件</Select.Option>
        <Select.Option value="UPLOAD_FILE">上传文件</Select.Option>
        <Select.Option value="APPROVE_PASS">审核通过</Select.Option>
        <Select.Option value="APPROVE_REJECT">审核驳回</Select.Option>
      </Select>
    </div>
    <div class="activity-list" v-loading="loading">
      <Timeline>
        <Timeline.Item
          v-for="item in activities"
          :key="item.id"
          :color="getActivityColor(item.type)"
        >
          <div class="activity-item">
            <div class="activity-user">{{ item.userName }}</div>
            <div class="activity-content">{{ item.content }}</div>
            <div class="activity-time">{{ formatTime(item.createTime) }}</div>
          </div>
        </Timeline.Item>
      </Timeline>
      <div v-if="activities.length === 0" class="activity-empty">
        暂无动态
      </div>
    </div>
    <div class="activity-footer" v-if="hasMore">
      <Button type="link" @click="loadMore">加载更多</Button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { activityApi } from '#/api/activity';
import { Timeline, Select, Button } from 'ant-design-vue';
import { formatTime } from '#/utils/date';

const loading = ref(false);
const activities = ref<any[]>([]);
const selectedType = ref('');
const currentPage = ref(1);
const pageSize = ref(10);
const hasMore = ref(false);

const loadActivities = async () => {
  loading.value = true;
  currentPage.value = 1;
  try {
    const res = await activityApi.getActivityList(
      selectedType.value || undefined,
      currentPage.value,
      pageSize.value,
    );
    activities.value = res.data || [];
    hasMore.value = res.data.length >= pageSize.value;
  } catch (error) {
    console.error('加载动态失败:', error);
  } finally {
    loading.value = false;
  }
};

const loadMore = async () => {
  loading.value = true;
  currentPage.value++;
  try {
    const res = await activityApi.getActivityList(
      selectedType.value || undefined,
      currentPage.value,
      pageSize.value,
    );
    activities.value = [...activities.value, ...(res.data || [])];
    hasMore.value = res.data.length >= pageSize.value;
  } catch (error) {
    console.error('加载更多失败:', error);
  } finally {
    loading.value = false;
  }
};

const getActivityColor = (type: string) => {
  const colorMap: Record<string, string> = {
    CREATE_CASE: 'blue',
    UPLOAD_FILE: 'green',
    APPROVE_PASS: 'green',
    APPROVE_REJECT: 'red',
    COMPLETE_TODO: 'blue',
  };
  return colorMap[type] || 'gray';
};

onMounted(() => {
  loadActivities();
});
</script>

<style scoped lang="less">
.activity-timeline {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
}

.activity-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;

  h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
  }
}

.activity-list {
  max-height: 400px;
  overflow-y: auto;
}

.activity-item {
  padding: 8px 0;
}

.activity-user {
  font-weight: 500;
  color: #1890ff;
  margin-bottom: 4px;
}

.activity-content {
  color: #333;
  margin-bottom: 4px;
}

.activity-time {
  font-size: 12px;
  color: #999;
}

.activity-empty {
  padding: 40px;
  text-align: center;
  color: #999;
}

.activity-footer {
  text-align: center;
  margin-top: 16px;
}
</style>
```

#### 5.3.3 components/TodoList.vue

```vue
<template>
  <div class="todo-list">
    <div class="todo-header">
      <h3>待办事项</h3>
      <Button type="primary" size="small" @click="showCreateModal">
        <Icon icon="lucide:plus" :size="14" />
        新建
      </Button>
    </div>
    <div class="todo-filters">
      <Radio.Group v-model:value="selectedStatus" @change="loadTodos">
        <Radio.Button value="">全部</Radio.Button>
        <Radio.Button value="PENDING">待处理</Radio.Button>
        <Radio.Button value="IN_PROGRESS">进行中</Radio.Button>
        <Radio.Button value="COMPLETED">已完成</Radio.Button>
      </Radio.Group>
      <Select
        v-model:value="selectedPriority"
        style="width: 100px; margin-left: 12px"
        @change="loadTodos"
      >
        <Select.Option value="">全部优先级</Select.Option>
        <Select.Option value="HIGH">高</Select.Option>
        <Select.Option value="MEDIUM">中</Select.Option>
        <Select.Option value="LOW">低</Select.Option>
      </Select>
    </div>
    <div class="todo-items" v-loading="loading">
      <div
        v-for="item in todos"
        :key="item.id"
        class="todo-item"
        :class="{
          completed: item.status === 'COMPLETED',
          high: item.priority === 'HIGH',
          medium: item.priority === 'MEDIUM',
          low: item.priority === 'LOW',
        }"
      >
        <div class="todo-checkbox">
          <Checkbox
            :checked="item.status === 'COMPLETED'"
            @change="toggleTodoStatus(item)"
          />
        </div>
        <div class="todo-content">
          <div class="todo-title">{{ item.title }}</div>
          <div v-if="item.description" class="todo-description">
            {{ item.description }}
          </div>
          <div class="todo-meta">
            <Tag :color="getPriorityColor(item.priority)">
              {{ getPriorityText(item.priority) }}
            </Tag>
            <span v-if="item.deadline" class="todo-deadline">
              <Icon icon="lucide:clock" :size="12" />
              {{ formatTime(item.deadline) }}
            </span>
          </div>
        </div>
        <div class="todo-actions">
          <Button type="text" size="small" @click="editTodo(item)">
            <Icon icon="lucide:edit-2" :size="14" />
          </Button>
          <Button type="text" size="small" danger @click="deleteTodo(item.id)">
            <Icon icon="lucide:trash-2" :size="14" />
          </Button>
        </div>
      </div>
      <div v-if="todos.length === 0" class="todo-empty">
        暂无待办事项
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { todoApi, TodoDTO } from '#/api/todo';
import { Button, Checkbox, Tag, Select, Radio, Icon } from 'ant-design-vue';
import { formatTime } from '#/utils/date';

const loading = ref(false);
const todos = ref<any[]>([]);
const selectedStatus = ref('');
const selectedPriority = ref('');

const loadTodos = async () => {
  loading.value = true;
  try {
    const res = await todoApi.getTodoList(
      selectedStatus.value || undefined,
      selectedPriority.value || undefined,
      1,
      20,
    );
    todos.value = res.data || [];
  } catch (error) {
    console.error('加载待办失败:', error);
  } finally {
    loading.value = false;
  }
};

const toggleTodoStatus = async (item: any) => {
  if (item.status === 'COMPLETED') {
    await todoApi.updateTodo(item.id, { status: 'PENDING' });
  } else {
    await todoApi.completeTodo(item.id);
  }
  item.status = item.status === 'COMPLETED' ? 'PENDING' : 'COMPLETED';
};

const editTodo = (item: any) => {
  console.log('编辑待办:', item);
};

const deleteTodo = async (id: number) => {
  await todoApi.deleteTodo(id);
  todos.value = todos.value.filter((item) => item.id !== id);
};

const showCreateModal = () => {
  console.log('显示创建待办弹窗');
};

const getPriorityColor = (priority: string) => {
  const colorMap: Record<string, string> = {
    HIGH: 'red',
    MEDIUM: 'orange',
    LOW: 'green',
  };
  return colorMap[priority] || 'default';
};

const getPriorityText = (priority: string) => {
  const textMap: Record<string, string> = {
    HIGH: '高',
    MEDIUM: '中',
    LOW: '低',
  };
  return textMap[priority] || priority;
};

onMounted(() => {
  loadTodos();
});
</script>

<style scoped lang="less">
.todo-list {
  background: #fff;
  border-radius: 8px;
  padding: 20px;
}

.todo-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;

  h3 {
    margin: 0;
    font-size: 16px;
    font-weight: 600;
  }
}

.todo-filters {
  display: flex;
  align-items: center;
  margin-bottom: 16px;
}

.todo-items {
  max-height: 400px;
  overflow-y: auto;
}

.todo-item {
  display: flex;
  align-items: flex-start;
  padding: 12px;
  border: 1px solid #f0f0f0;
  border-radius: 6px;
  margin-bottom: 8px;
  transition: all 0.2s;

  &:hover {
    border-color: #1890ff;
    box-shadow: 0 2px 8px rgba(24, 144, 255, 0.1);
  }

  &.completed {
    opacity: 0.6;

    .todo-title {
      text-decoration: line-through;
    }
  }

  &.high {
    border-left: 3px solid #ff4d4f;
  }

  &.medium {
    border-left: 3px solid #faad14;
  }

  &.low {
    border-left: 3px solid #52c41a;
  }
}

.todo-checkbox {
  margin-right: 12px;
  margin-top: 2px;
}

.todo-content {
  flex: 1;
}

.todo-title {
  font-weight: 500;
  margin-bottom: 4px;
}

.todo-description {
  font-size: 13px;
  color: #666;
  margin-bottom: 8px;
}

.todo-meta {
  display: flex;
  align-items: center;
  gap: 8px;
}

.todo-deadline {
  font-size: 12px;
  color: #999;
  display: flex;
  align-items: center;
  gap: 4px;
}

.todo-actions {
  display: flex;
  gap: 4px;
}

.todo-empty {
  padding: 40px;
  text-align: center;
  color: #999;
}
</style>
```

#### 5.3.4 components/ApprovalCard.vue

```vue
<template>
  <div class="approval-card">
    <div class="approval-header">
      <div class="approval-title">{{ approval.title }}</div>
      <Tag :color="getStatusColor(approval.status)">
        {{ getStatusText(approval.status) }}
      </Tag>
    </div>
    <div class="approval-info">
      <div class="info-row">
        <span class="label">审核编号:</span>
        <span class="value">{{ approval.approvalNo }}</span>
      </div>
      <div class="info-row">
        <span class="label">申请人:</span>
        <span class="value">{{ approval.applicantName }}</span>
      </div>
      <div class="info-row">
        <span class="label">申请时间:</span>
        <span class="value">{{ formatTime(approval.applyTime) }}</span>
      </div>
      <div v-if="approval.description" class="info-row">
        <span class="label">描述:</span>
        <span class="value">{{ approval.description }}</span>
      </div>
    </div>
    <div class="approval-actions" v-if="approval.status === 'PENDING'">
      <Button type="primary" size="small" @click="handleApprove">
        通过
      </Button>
      <Button danger size="small" @click="handleReject">
        驳回
      </Button>
    </div>
  </div>
</template>

<script setup lang="ts">
import { approvalApi } from '#/api/approval';
import { Button, Tag, Modal, Input } from 'ant-design-vue';
import { formatTime } from '#/utils/date';

interface Props {
  approval: any;
}

const props = defineProps<Props>();

const emit = defineEmits(['refresh']);

const handleApprove = () => {
  Modal.confirm({
    title: '确认通过',
    content: '确认通过该审核申请吗？',
    onOk: async () => {
      await approvalApi.approve(props.approval.id, '审核通过');
      emit('refresh');
    },
  });
};

const handleReject = () => {
  let opinion = '';
  Modal.confirm({
    title: '确认驳回',
    content: () => (
      <div>
        <p>确认驳回该审核申请吗？</p>
        <Input.TextArea
          v-model:value={opinion}
          placeholder="请输入驳回原因"
          rows={3}
        />
      </div>
    ),
    onOk: async () => {
      await approvalApi.reject(props.approval.id, opinion || '审核驳回');
      emit('refresh');
    },
  });
};

const getStatusColor = (status: string) => {
  const colorMap: Record<string, string> = {
    PENDING: 'orange',
    APPROVED: 'green',
    REJECTED: 'red',
    CANCELLED: 'default',
  };
  return colorMap[status] || 'default';
};

const getStatusText = (status: string) => {
  const textMap: Record<string, string> = {
    PENDING: '待审核',
    APPROVED: '已通过',
    REJECTED: '已驳回',
    CANCELLED: '已取消',
  };
  return textMap[status] || status;
};
</script>

<style scoped lang="less">
.approval-card {
  background: #fff;
  border: 1px solid #f0f0f0;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 12px;
  transition: all 0.2s;

  &:hover {
    border-color: #1890ff;
    box-shadow: 0 2px 8px rgba(24, 144, 255, 0.1);
  }
}

.approval-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.approval-title {
  font-weight: 500;
  font-size: 15px;
}

.approval-info {
  margin-bottom: 12px;
}

.info-row {
  display: flex;
  margin-bottom: 8px;
  font-size: 13px;

  .label {
    color: #999;
    width: 80px;
    flex-shrink: 0;
  }

  .value {
    color: #333;
    flex: 1;
  }
}

.approval-actions {
  display: flex;
  gap: 8px;
}
</style>
```

### 5.4 WebSocket实现

#### 5.4.1 websocket/notification.ts

```typescript
import { ref, onUnmounted } from 'vue';

let ws: WebSocket | null = null;
const messageHandlers: Array<(data: any) => void> = [];

export function useWebSocket() {
  const connected = ref(false);

  const connect = () => {
    if (ws && ws.readyState === WebSocket.OPEN) {
      return;
    }

    const token = localStorage.getItem('token');
    ws = new WebSocket(`ws://localhost:8080/ws?token=${token}`);

    ws.onopen = () => {
      console.log('WebSocket连接成功');
      connected.value = true;
    };

    ws.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        messageHandlers.forEach((handler) => handler(data));
      } catch (error) {
        console.error('解析WebSocket消息失败:', error);
      }
    };

    ws.onerror = (error) => {
      console.error('WebSocket错误:', error);
      connected.value = false;
    };

    ws.onclose = () => {
      console.log('WebSocket连接关闭');
      connected.value = false;
      setTimeout(() => {
        connect();
      }, 5000);
    };
  };

  const disconnect = () => {
    if (ws) {
      ws.close();
      ws = null;
      connected.value = false;
    }
  };

  const onMessage = (handler: (data: any) => void) => {
    messageHandlers.push(handler);
  };

  const offMessage = (handler: (data: any) => void) => {
    const index = messageHandlers.indexOf(handler);
    if (index > -1) {
      messageHandlers.splice(index, 1);
    }
  };

  onUnmounted(() => {
    disconnect();
  });

  return {
    connected,
    connect,
    disconnect,
    onMessage,
    offMessage,
  };
}
```

### 5.5 工作台页面集成

#### 5.5.1 views/dashboard/index.vue

```vue
<template>
  <div class="dashboard">
    <div class="dashboard-header">
      <h2>工作台</h2>
      <div class="header-actions">
        <NotificationBadge />
      </div>
    </div>
    <div class="dashboard-content">
      <Row :gutter="16">
        <Col :span="12">
          <Card title="最新动态" :bordered="false">
            <ActivityTimeline />
          </Card>
        </Col>
        <Col :span="12">
          <Card title="待办事项" :bordered="false">
            <TodoList />
          </Card>
        </Col>
      </Row>
      <Row :gutter="16" style="margin-top: 16px">
        <Col :span="24">
          <Card title="待审核" :bordered="false">
            <div class="pending-approvals">
              <ApprovalCard
                v-for="approval in pendingApprovals"
                :key="approval.id"
                :approval="approval"
                @refresh="loadPendingApprovals"
              />
              <div v-if="pendingApprovals.length === 0" class="empty">
                暂无待审核任务
              </div>
            </div>
          </Card>
        </Col>
      </Row>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted } from 'vue';
import { approvalApi } from '#/api/approval';
import { Card, Row, Col } from 'ant-design-vue';
import NotificationBadge from '#/components/NotificationBadge.vue';
import ActivityTimeline from '#/components/ActivityTimeline.vue';
import TodoList from '#/components/TodoList.vue';
import ApprovalCard from '#/components/ApprovalCard.vue';

const pendingApprovals = ref<any[]>([]);

const loadPendingApprovals = async () => {
  try {
    const res = await approvalApi.getPendingApprovals(1, 10);
    pendingApprovals.value = res.data || [];
  } catch (error) {
    console.error('加载待审核失败:', error);
  }
};

onMounted(() => {
  loadPendingApprovals();
});
</script>

<style scoped lang="less">
.dashboard {
  padding: 20px;
}

.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;

  h2 {
    margin: 0;
  }
}

.pending-approvals {
  max-height: 400px;
  overflow-y: auto;
}

.empty {
  padding: 40px;
  text-align: center;
  color: #999;
}
</style>
```

---

## 6. 前后端交互流程

### 6.1 通知流程

```
用户登录
  ↓
前端连接WebSocket
  ↓
后端WebSocketHandler建立连接
  ↓
系统事件触发（如：审核提交）
  ↓
后端NotificationService创建通知记录
  ↓
后端NotificationPushService通过WebSocket推送
  ↓
前端NotificationBadge接收消息
  ↓
更新未读数量徽章
  ↓
用户点击通知图标
  ↓
前端调用GET /api/notification/list获取通知列表
  ↓
用户点击通知项
  ↓
前端调用PUT /api/notification/{id}/read标记已读
  ↓
跳转到关联业务页面
```

### 6.2 最新动态流程

```
用户操作（如：创建案件）
  ↓
前端调用业务API（POST /api/case）
  ↓
后端CaseService处理业务逻辑
  ↓
后端ActivityService记录动态
  ↓
前端工作台页面加载
  ↓
前端调用GET /api/activity/list获取动态列表
  ↓
前端ActivityTimeline组件展示
```

### 6.3 待办事项流程

```
用户创建待办
  ↓
前端调用POST /api/todo
  ↓
后端TodoService创建待办记录
  ↓
前端TodoList组件刷新列表
  ↓
用户标记完成
  ↓
前端调用PUT /api/todo/{id}/complete
  ↓
后端TodoService更新状态
  ↓
前端更新UI显示
```

### 6.4 审核流程

```
用户A提交审核
  ↓
前端调用POST /api/approval
  ↓
后端ApprovalService创建审核记录
  ↓
后端创建审核日志
  ↓
后端向用户B发送通知
  ↓
后端为用户B创建待办任务
  ↓
后端记录动态
  ↓
用户B工作台显示待审核
  ↓
用户B查看详情
  ↓
前端调用GET /api/approval/{id}
  ↓
用户B审核通过/驳回
  ↓
前端调用PUT /api/approval/{id}/approve 或 /reject
  ↓
后端更新审核状态
  ↓
后端创建审核日志
  ↓
后端向用户A发送审核结果通知
  ↓
后端完成用户B的待办任务
  ↓
后端记录动态
  ↓
用户A收到通知并查看结果
```

---

## 7. 开发注意事项

### 7.1 后端注意事项

1. **事务管理**
   - 审核流程涉及多表操作，必须使用@Transactional保证数据一致性
   - 通知创建、待办创建、动态记录应在同一事务中

2. **权限控制**
   - 审核操作必须验证操作人身份
   - 只有审核人才能进行审核操作
   - 只有申请人才能取消审核

3. **WebSocket连接管理**
   - 维护用户ID与WebSocket Session的映射关系
   - 处理连接断开重连逻辑
   - 避免重复连接

4. **性能优化**
   - 通知列表查询使用索引优化
   - 动态列表支持分页加载
   - 待办列表按优先级和截止时间排序

5. **异常处理**
   - 统一异常处理机制
   - 友好的错误提示信息
   - 记录操作日志

### 7.2 前端注意事项

1. **状态管理**
   - 使用Pinia管理通知、待办等状态
   - 实现状态持久化
   - 避免重复请求

2. **WebSocket重连**
   - 实现断线重连机制
   - 处理连接超时
   - 避免频繁重连

3. **用户体验**
   - 通知徽章实时更新
   - 加载状态提示
   - 空状态友好展示

4. **路由跳转**
   - 通知点击跳转到关联业务
   - 审核详情支持返回列表
   - 保持页面状态

5. **权限控制**
   - 根据用户角色显示不同操作按钮
   - 审核按钮仅对审核人显示
   - 取消按钮仅对申请人显示

### 7.3 数据库注意事项

1. **索引设计**
   - 为常用查询字段创建索引
   - 复合索引注意字段顺序
   - 定期维护索引统计信息

2. **数据清理**
   - 定期清理已删除的通知
   - 归档历史动态数据
   - 清理已完成待办

3. **数据一致性**
   - 使用外键约束保证关联数据完整性
   - 软删除保留数据历史
   - 审核日志不可修改

### 7.4 测试要点

1. **单元测试**
   - Service层业务逻辑测试
   - Mapper层SQL测试
   - WebSocket推送测试

2. **集成测试**
   - 完整审核流程测试
   - 通知推送测试
   - 并发操作测试

3. **前端测试**
   - 组件单元测试
   - 页面交互测试
   - WebSocket连接测试

---

## 8. 总结

本文档详细介绍了通知与审核功能模块的全栈实现方案，包括：

1. **四大功能模块**：通知中心、最新动态、待办事项、审核流程
2. **数据库设计**：5张核心表的完整SQL Server 2008建表语句
3. **后端实现**：Controller、Service、Mapper层完整代码示例
4. **前端实现**：API、组件、Hook、WebSocket完整代码示例
5. **交互流程**：四大模块的前后端交互时序图
6. **开发注意事项**：后端、前端、数据库、测试各方面的注意事项

通过本文档，开发团队可以快速理解并实现这四个功能模块，确保前后端协作顺畅，系统功能完整可靠。

---

**文档版本**: v1.0
**更新时间**: 2025年12月29日
**适用技术栈**: Spring Boot 2.6.13 + Vue 3 + SQL Server 2008
