# 案件流程详细总结

## 1. 整体架构

### 1.1 页面结构
案件详情页面包含三个主要标签页：
- **案件基本信息**：展示和编辑案件的基本信息
- **流程处理**：展示案件的七个阶段流程（本文重点）
- **公告管理**：管理案件相关公告

### 1.2 流程阶段划分
案件流程分为七个阶段，每个阶段对应一个独立组件：
1. 阶段一：法院指定管理人至管理人接管破产企业前的工作
2. 阶段二：管理人接管破产企业至调查审查破产企业前的工作
3. 阶段三：管理人调查审查破产企业至第一次债权人会议前工作
4. 阶段四：第一次债权人会议至第二次债权人会议前工作
5. 阶段五：第二次债权人会议至破产程序终结工作
6. 阶段六：破产财产分配方案等相关工作
7. 阶段七：债权人会议决议等相关工作

## 2. 流程处理界面呈现

### 2.1 阶段导航
- **阶段指示器**：顶部显示七个阶段的圆点指示器，当前阶段高亮
- **阶段标题**：显示当前阶段的描述和标题
- **进度信息**：显示当前阶段进度（任务完成数/总任务数）
- **导航按钮**：提供"上一阶段"和"下一阶段"按钮，边界阶段时禁用

### 2.2 阶段内容
- **阶段卡片**：每个阶段使用独立的卡片组件，包含阶段标题和进度条
- **进度条**：显示当前阶段的完成百分比
- **任务列表**：展示当前阶段的所有任务
- **任务项**：每个任务显示名称、状态、描述和操作按钮

### 2.3 任务状态
任务有三种状态：
- **未确认**：任务尚未处理
- **完成**：任务已完成
- **跳过**：任务已跳过

### 2.4 任务操作
根据任务状态和数据情况，显示不同的操作按钮：
- **新增**：添加新任务记录
- **编辑**：编辑现有任务
- **完成**：标记任务为已完成
- **跳过**：标记任务为已跳过
- **撤回**：取消之前的完成或跳过操作

## 3. API调用

### 3.1 核心API

#### 案件详情
```typescript
import { getCaseDetailApi } from '#/api/core/case';
const response = await getCaseDetailApi(caseId);
```

#### 阶段一任务API
```typescript
import {
  getLegalProcedureApi,
  getManagementApi,
  getSealManagementApi,
  getWorkPlanApi,
  getWorkTeamApi,
  unifiedTaskOperationApi,
} from '#/api/core/case-process';
```

### 3.2 任务操作API

#### 统一任务操作
```typescript
const params = {
  SEP_LD: caseId, // 案件ID
  ZT: '1', // 状态：1-完成，2-跳过，0-未确认
  OperateType: taskTypeToOperateType[taskId], // 操作类型
  SEP_EDATE, // 操作日期
  SEP_EUSER, // 操作人
};
const result = await unifiedTaskOperationApi(params);
```

#### 新增任务API（以法律程序为例）
```typescript
const { addLegalProcedureApi } = await import('#/api/core/case-process');
const addResponse = await addLegalProcedureApi(legalProcedureData);
```

### 3.3 阶段任务同步API
- **阶段一**：syncTaskStatusFromStageOne()
- **阶段二**：syncTaskStatusFromStageTwo()
- **阶段三**：syncTaskStatusFromStageThree()
- **阶段六**：syncTaskStatusFromStageSix()
- **阶段七**：syncTaskStatusFromStageSeven()

## 4. 核心组件

### 4.1 案件详情主组件（index.vue）
- 管理标签页切换
- 加载案件基本信息
- 管理七个阶段的切换和状态同步
- 处理任务状态变更事件

### 4.2 阶段组件（StageOneProcess.vue 等）
- 每个阶段对应一个独立组件
- 加载和展示该阶段的所有任务
- 处理任务的各种操作（新增、编辑、完成、跳过、撤回）
- 计算和显示阶段进度

### 4.3 任务编辑组件（TaskEdit.vue）
- 处理不同类型任务的编辑表单
- 调用相应的API保存任务数据
- 支持确认和暂存两种保存方式

## 5. 数据流程

### 5.1 初始化流程
1. 页面加载时调用getCaseDetailApi获取案件基本信息
2. 切换到"流程处理"标签页时，默认显示第一个阶段
3. 调用当前阶段的任务同步方法（如syncTaskStatusFromStageOne）
4. 加载阶段任务数据，更新任务状态

### 5.2 任务操作流程
1. 用户点击任务操作按钮（新增、编辑、完成、跳过、撤回）
2. 组件调用相应的API处理请求
3. API返回结果后，更新本地任务状态
4. 触发taskStatusChanged事件，通知父组件更新阶段进度
5. 更新进度条和完成状态显示

### 5.3 阶段切换流程
1. 用户点击阶段指示器或导航按钮
2. 调用switchStage方法，更新currentStageIndex
3. 根据新的阶段索引，调用相应的任务同步方法
4. 加载新阶段的任务数据，更新界面

## 6. 状态管理

### 6.1 本地状态
- **activeTab**：当前激活的标签页
- **currentStageIndex**：当前阶段索引
- **processStages**：所有阶段的配置数据
- **caseDetail**：案件基本信息

### 6.2 任务状态同步
- **阶段一至三、六至七**：通过API同步任务状态
- **阶段四至五**：使用localStorage同步状态

### 6.3 操作人信息
从localStorage获取操作人信息：
```typescript
const chatUserInfo = localStorage.getItem('chat_user_info');
const SEP_EUSER = chatUserInfo ? JSON.parse(chatUserInfo).U_USER : 'admin';
```

## 7. 样式设计

### 7.1 整体风格
- 采用Element Plus组件库的设计风格
- 使用卡片、进度条、标签等组件
- 响应式设计，适配不同屏幕尺寸

### 7.2 状态样式
- **未确认**：蓝色边框，浅蓝色背景渐变
- **完成**：绿色边框，浅绿色背景渐变
- **跳过**：黄色边框，浅黄色背景渐变

### 7.3 交互效果
- 悬停效果：任务项和按钮有悬停反馈
- 过渡动画：状态变更时有平滑过渡
- 加载状态：数据加载时显示加载指示器

## 8. 关联页面和数据

### 8.1 关联页面
- **案件列表**：从案件列表页面进入案件详情
- **任务编辑页面**：点击编辑按钮进入，路径格式：`/case-detail/${caseId}/task/${taskId}/edit`
- **公告管理页面**：同一案件详情页面的其他标签页

### 8.2 关联数据
- **案件基本信息**：所有阶段共享同一个案件的基本信息
- **操作人信息**：从localStorage获取，用于任务操作记录
- **任务状态数据**：各阶段任务状态相互独立，但都属于同一案件

## 9. 代码结构

### 9.1 核心文件
```
src/views/law/case-detail/
├── index.vue                 # 案件详情主页面
├── TaskEdit.vue              # 任务编辑页面
└── components/
    ├── StageOneProcess.vue   # 阶段一组件
    ├── StageTwoProcess.vue   # 阶段二组件
    ├── StageThreeProcess.vue # 阶段三组件
    ├── StageFourProcess.vue  # 阶段四组件
    ├── StageFiveProcess.vue  # 阶段五组件
    ├── StageSixProcess.vue   # 阶段六组件
    └── StageSevenProcess.vue # 阶段七组件
```

### 9.2 API文件
```
src/api/core/
├── case.ts                   # 案件基本信息API
├── case-process.ts           # 案件流程API
└── work-team.ts              # 工作团队API
```

## 10. 关键实现细节

### 10.1 任务类型映射
每个任务类型对应一个OperateType：
```typescript
const taskTypeToOperateType: Record<string, string> = {
  workTeam: '0',          // 工作团队
  workPlan: '1',          // 工作计划
  management: '2',        // 管理制度
  sealManagement: '3',    // 印章管理
  legalProcedure: '4',    // 法律程序
  // 其他任务类型...
};
```

### 10.2 进度计算
```typescript
const progress = computed(() => {
  const completedTasks = tasks.value.filter(
    (task) => task.status === '完成' || task.status === '跳过',
  ).length;
  return Math.round((completedTasks / tasks.value.length) * 100);
});
```

### 10.3 任务状态判断
```typescript
status: 
  workTeamRes.status === 'fulfilled' &&
  workTeamRes.value.status === '1' &&
  workTeamRes.value.data &&
  Number.parseInt(workTeamRes.value.data.paras?.zt2_count || '0') > 0
    ? '跳过'
    : '未确认',
```

## 11. 扩展性设计

### 11.1 阶段扩展
可以通过修改processStages数组轻松添加新的阶段：
```typescript
processStages.value.push({
  id: 8,
  title: '新阶段标题',
  description: '阶段八',
  component: 'StageEightProcess',
  tasks: [/* 任务列表 */],
});
```

### 11.2 任务扩展
在各阶段组件中添加新任务类型，并在taskTypeToOperateType中添加对应的映射关系。

### 11.3 API扩展
遵循现有的API调用模式，添加新的API函数和类型定义。

## 12. 优化建议

### 12.1 性能优化
- **批量API调用**：使用Promise.allSettled批量获取任务数据，减少HTTP请求次数
- **缓存机制**：对已加载的阶段数据进行缓存，避免重复请求
- **懒加载组件**：使用动态导入懒加载阶段组件，减少初始加载时间

### 12.2 用户体验优化
- **操作反馈**：所有操作都应有明确的成功或失败反馈
- **进度提示**：阶段完成时显示明显的完成提示
- **批量操作**：支持批量标记任务状态
- **搜索过滤**：添加任务搜索和过滤功能

### 12.3 代码优化
- **类型安全**：加强TypeScript类型定义，减少any类型的使用
- **组件复用**：提取通用的任务项组件，减少代码重复
- **API封装**：进一步封装API调用，统一错误处理和响应格式

## 13. 总结

案件流程处理模块采用了清晰的分层架构，将不同阶段的任务处理逻辑分离到独立组件中，便于维护和扩展。通过统一的API调用模式和状态管理，实现了任务的全生命周期管理。界面设计简洁直观，操作流程顺畅，为用户提供了良好的案件流程管理体验。

该实现可以作为其他类似流程管理系统的参考，具有良好的扩展性和可维护性。