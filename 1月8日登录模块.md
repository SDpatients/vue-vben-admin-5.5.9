# 前端登录模块API文档

## 一、API列表

### 1. 用户登录API

**功能说明**：用于用户登录，验证用户名密码，返回访问令牌和刷新令牌

**请求方法**：POST

**请求URL**：`/api/v1/auth/login`

**请求参数**：

| 参数名 | 数据类型 | 是否必填 | 描述 |
|--------|----------|----------|------|
| username | String | 是 | 用户名 |
| password | String | 是 | 密码 |
| smsCode | String | 否 | 短信验证码（4-6位数字，可选） |

**请求头**：

| 头名 | 值 | 描述 |
|------|-----|------|
| Content-Type | application/json | 请求体类型 |
| User-Agent | 浏览器标识 | 设备信息 |

**响应数据格式**：

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "userId": 1,
    "username": "admin",
    "realName": "管理员",
    "accessToken": "eyJhbGciOiJIUzUxMiJ9...",
    "refreshToken": "eyJhbGciOiJIUzUxMiJ9...",
    "permissions": ["user:read", "user:write"]
  }
}
```

**错误码及错误信息**：

| 错误码 | 错误信息 | 描述 |
|--------|----------|------|
| 401 | 用户名或密码错误 | 用户名不存在或密码不正确 |
| 401 | 短信验证码错误或已过期 | 短信验证码验证失败 |
| 401 | 账号已被禁用或锁定 | 用户账号状态异常 |
| 401 | 账号已被锁定，请30分钟后再试 | 登录失败次数过多，账号被锁定 |
| 400 | 用户名不能为空 | 请求参数验证失败 |
| 400 | 密码不能为空 | 请求参数验证失败 |

### 2. 刷新令牌API

**功能说明**：使用刷新令牌获取新的访问令牌和刷新令牌

**请求方法**：POST

**请求URL**：`/api/v1/auth/refresh-token`

**请求参数**：

| 参数名 | 数据类型 | 是否必填 | 描述 |
|--------|----------|----------|------|
| refreshToken | String | 是 | 刷新令牌 |

**请求头**：

| 头名 | 值 | 描述 |
|------|-----|------|
| Content-Type | application/json | 请求体类型 |

**响应数据格式**：

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "userId": 1,
    "username": "admin",
    "realName": "管理员",
    "accessToken": "eyJhbGciOiJIUzUxMiJ9...",
    "refreshToken": "eyJhbGciOiJIUzUxMiJ9...",
    "permissions": ["user:read", "user:write"]
  }
}
```

**错误码及错误信息**：

| 错误码 | 错误信息 | 描述 |
|--------|----------|------|
| 401 | 刷新令牌无效或已过期 | 刷新令牌验证失败 |
| 401 | 令牌类型错误，需要刷新令牌 | 传入的不是刷新令牌 |
| 401 | 用户不存在 | 令牌对应的用户不存在 |
| 401 | 账号已被禁用或锁定 | 用户账号状态异常 |
| 401 | 刷新令牌已失效 | 刷新令牌已被吊销 |
| 400 | 刷新令牌不能为空 | 请求参数验证失败 |

### 3. 登出API

**功能说明**：用户登出，使当前令牌失效

**请求方法**：POST

**请求URL**：`/api/v1/auth/logout`

**请求头**：

| 头名 | 值 | 描述 |
|------|-----|------|
| Authorization | Bearer {accessToken} | 访问令牌 |

**响应数据格式**：

```json
{
  "code": 200,
  "message": "成功",
  "data": null
}
```

**错误码及错误信息**：

| 错误码 | 错误信息 | 描述 |
|--------|----------|------|
| 401 | 未授权 | 令牌无效或已过期 |

### 4. 发送短信验证码API

**功能说明**：用于发送短信验证码，支持登录和注册场景

**请求方法**：POST

**请求URL**：`/api/v1/sms/send`

**请求参数**：

| 参数名 | 数据类型 | 是否必填 | 描述 |
|--------|----------|----------|------|
| mobile | String | 是 | 手机号 |
| type | String | 是 | 验证码类型：1-登录，2-注册，3-密码重置 |

**请求头**：

| 头名 | 值 | 描述 |
|------|-----|------|
| Content-Type | application/json | 请求体类型 |

**响应数据格式**：

```json
{
  "code": 200,
  "message": "短信发送成功",
  "data": null
}
```

**错误码及错误信息**：

| 错误码 | 错误信息 | 描述 |
|--------|----------|------|
| 400 | 手机号格式不正确 | 手机号验证失败 |
| 400 | 验证码类型错误 | 类型参数无效 |
| 429 | 发送频率过高，请稍后再试 | 短信发送过于频繁 |
| 500 | 短信发送失败 | 短信服务异常 |

### 5. 获取用户信息API

**功能说明**：获取当前登录用户的详细信息

**请求方法**：GET

**请求URL**：`/api/v1/user/info`

**请求头**：

| 头名 | 值 | 描述 |
|------|-----|------|
| Authorization | Bearer {accessToken} | 访问令牌 |

**响应数据格式**：

```json
{
  "code": 200,
  "message": "成功",
  "data": {
    "userId": 1,
    "username": "admin",
    "realName": "管理员",
    "mobile": "13800138000",
    "email": "admin@example.com",
    "status": "ACTIVE",
    "lastLoginTime": "2024-01-08T10:00:00",
    "lastLoginIp": "127.0.0.1"
  }
}
```

**错误码及错误信息**：

| 错误码 | 错误信息 | 描述 |
|--------|----------|------|
| 401 | 未授权 | 令牌无效或已过期 |
| 404 | 用户不存在 | 用户已被删除 |

### 6. 密码重置请求API

**功能说明**：请求重置密码，发送验证码到手机

**请求方法**：POST

**请求URL**：`/api/v1/user/reset-password/request`

**请求参数**：

| 参数名 | 数据类型 | 是否必填 | 描述 |
|--------|----------|----------|------|
| mobile | String | 是 | 手机号 |

**请求头**：

| 头名 | 值 | 描述 |
|------|-----|------|
| Content-Type | application/json | 请求体类型 |

**响应数据格式**：

```json
{
  "code": 200,
  "message": "验证码发送成功",
  "data": null
}
```

**错误码及错误信息**：

| 错误码 | 错误信息 | 描述 |
|--------|----------|------|
| 400 | 手机号格式不正确 | 手机号验证失败 |
| 404 | 手机号未注册 | 该手机号未注册 |

### 7. 密码重置确认API

**功能说明**：验证短信验证码，重置密码

**请求方法**：POST

**请求URL**：`/api/v1/user/reset-password/confirm`

**请求参数**：

| 参数名 | 数据类型 | 是否必填 | 描述 |
|--------|----------|----------|------|
| mobile | String | 是 | 手机号 |
| smsCode | String | 是 | 短信验证码 |
| newPassword | String | 是 | 新密码 |

**请求头**：

| 头名 | 值 | 描述 |
|------|-----|------|
| Content-Type | application/json | 请求体类型 |

**响应数据格式**：

```json
{
  "code": 200,
  "message": "密码重置成功",
  "data": null
}
```

**错误码及错误信息**：

| 错误码 | 错误信息 | 描述 |
|--------|----------|------|
| 400 | 验证码错误或已过期 | 短信验证码验证失败 |
| 400 | 密码格式不正确 | 新密码不符合要求 |
| 404 | 手机号未注册 | 该手机号未注册 |

## 二、API调用顺序与依赖关系

### 1. 首次登录流程

```
1. 用户输入用户名和密码
2. （可选）调用发送短信验证码API获取验证码
3. 调用用户登录API
4. 登录成功后，存储accessToken和refreshToken
5. 调用获取用户信息API获取用户详细信息
6. 进入应用主页
```

### 2. 令牌过期流程

```
1. 发送请求时，服务器返回401错误
2. 检查本地是否有有效的refreshToken
3. 如果有refreshToken，调用刷新令牌API
4. 刷新成功后，更新本地存储的accessToken和refreshToken
5. 使用新的accessToken重新发送原请求
6. 如果刷新令牌也过期，跳转到登录页面
```

### 3. 登出流程

```
1. 用户点击登出按钮
2. 调用登出API
3. 清除本地存储的accessToken和refreshToken
4. 跳转到登录页面
```

### 4. 密码重置流程

```
1. 用户点击"忘记密码"
2. 输入手机号，调用密码重置请求API
3. 输入收到的验证码和新密码
4. 调用密码重置确认API
5. 重置成功后，跳转到登录页面
```

## 三、不同场景下的API调用

### 1. 首次登录场景

**调用顺序**：
1. （可选）`发送短信验证码API` → 2. `用户登录API` → 3. `获取用户信息API`

**注意事项**：
- 存储返回的accessToken和refreshToken
- accessToken有效期为30分钟，refreshToken有效期为30天

### 2. 访问令牌过期场景

**调用顺序**：
1. 原请求返回401 → 2. `刷新令牌API` → 3. 重新发送原请求

**注意事项**：
- 实现令牌自动刷新机制，避免用户感知
- 处理并发请求场景，避免多次调用刷新令牌API

### 3. 刷新令牌过期场景

**调用顺序**：
1. `刷新令牌API`返回401 → 2. 清除本地令牌 → 3. 跳转到登录页面

**注意事项**：
- 给用户友好提示，引导重新登录
- 保存当前页面，登录成功后跳转回原页面

### 4. 密码错误场景

**调用顺序**：
1. `用户登录API`返回401（用户名或密码错误） → 2. 提示用户密码错误 → 3. 允许用户重新输入

**注意事项**：
- 记录失败次数，超过5次锁定账号
- 提供"忘记密码"入口

### 5. 账号锁定场景

**调用顺序**：
1. `用户登录API`返回401（账号已被锁定） → 2. 提示用户账号锁定 → 3. 提供解锁建议

**注意事项**：
- 显示锁定剩余时间
- 提供联系管理员入口

### 6. 短信验证码错误场景

**调用顺序**：
1. `用户登录API`返回401（短信验证码错误） → 2. 提示用户验证码错误 → 3. 允许重新获取验证码

**注意事项**：
- 验证码有效期为5分钟
- 限制获取频率，避免滥用

## 四、前端实现建议

### 1. 令牌管理

- 使用localStorage或sessionStorage存储令牌
- 建议对令牌进行加密存储
- 实现令牌自动刷新机制
- 监听401响应，统一处理令牌过期

### 2. 错误处理

- 统一处理API错误响应
- 对不同错误码显示不同的用户提示
- 记录错误日志，便于调试

### 3. 安全性

- 不在前端存储密码
- 使用HTTPS协议传输数据
- 实现防止CSRF攻击的措施
- 定期检查令牌有效性

### 4. 用户体验

- 提供加载状态指示
- 实现表单验证
- 提供友好的错误提示
- 记住用户选择，如"记住我"功能

### 5. 测试场景

- 测试正常登录流程
- 测试令牌过期自动刷新
- 测试密码错误场景
- 测试账号锁定场景
- 测试登出功能
- 测试密码重置流程

## 五、响应状态码说明

| 状态码 | 描述 |
|--------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误 |
| 401 | 未授权，令牌无效或已过期 |
| 404 | 请求资源不存在 |
| 429 | 请求频率过高 |
| 500 | 服务器内部错误 |

## 六、常见错误排查

1. **登录失败，返回401**：
   - 检查用户名和密码是否正确
   - 检查短信验证码是否有效
   - 检查账号是否被禁用或锁定

2. **令牌刷新失败，返回401**：
   - 检查refreshToken是否过期
   - 检查用户账号状态
   - 检查refreshToken是否被吊销

3. **短信发送失败**：
   - 检查手机号格式是否正确
   - 检查发送频率是否过高
   - 检查短信服务是否正常

4. **请求返回429**：
   - 减少请求频率
   - 实现请求节流

5. **请求返回500**：
   - 检查服务器状态
   - 查看服务器日志
   - 联系后端开发人员

## 七、版本说明

| 版本 | 日期 | 说明 |
|------|------|------|
| 1.0 | 2024-01-08 | 初始版本，包含登录、刷新令牌、登出等核心功能 |

## 八、联系方式

如有疑问或问题，请联系后端开发团队。