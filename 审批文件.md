# 审批模块数据库设计

本文档包含案件审批和文书审批模块的MySQL数据表设计。

## 数据表设计

### 1. 案件审批表 (case_approval)

存储案件审批相关信息。

```sql
-- 创建案件审批表
CREATE TABLE `case_approval` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '案件审批ID',
  `case_number` VARCHAR(100) NOT NULL COMMENT '案号',
  `case_title` VARCHAR(200) NOT NULL COMMENT '案件标题',
  `case_type` VARCHAR(50) NOT NULL COMMENT '案件类型：contract-合同纠纷，labor-劳动争议，property-房产纠纷，tort-侵权纠纷，family-婚姻家庭，other-其他',
  `submitter` VARCHAR(100) NOT NULL COMMENT '提交人',
  `submit_time` DATETIME NOT NULL COMMENT '提交时间',
  `approval_time` DATETIME DEFAULT NULL COMMENT '审批时间',
  `status` VARCHAR(20) NOT NULL DEFAULT 'pending' COMMENT '审批状态：pending-待审批，approved-已通过，rejected-已驳回',
  `priority` VARCHAR(20) NOT NULL DEFAULT 'medium' COMMENT '优先级：high-高，medium-中，low-低',
  `description` TEXT COMMENT '案件描述',
  `remark` TEXT COMMENT '审批意见',
  `approver` VARCHAR(100) DEFAULT NULL COMMENT '审批人',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_case_number` (`case_number`),
  KEY `idx_status` (`status`),
  KEY `idx_case_type` (`case_type`),
  KEY `idx_priority` (`priority`),
  KEY `idx_submit_time` (`submit_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='案件审批表';
```

### 2. 文书审批表 (document_approval)

存储文书审批相关信息。

```sql
-- 创建文书审批表
CREATE TABLE `document_approval` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '文书审批ID',
  `document_title` VARCHAR(200) NOT NULL COMMENT '文书标题',
  `document_type` VARCHAR(50) NOT NULL COMMENT '文书类型：complaint-起诉状，defense-答辩状，evidence-证据清单，legal_opinion-法律意见书，other-其他',
  `content` TEXT NOT NULL COMMENT '文书内容',
  `submitter` VARCHAR(100) NOT NULL COMMENT '提交人',
  `submit_time` DATETIME NOT NULL COMMENT '提交时间',
  `approval_time` DATETIME DEFAULT NULL COMMENT '审批时间',
  `status` VARCHAR(20) NOT NULL DEFAULT 'pending' COMMENT '审批状态：pending-待审批，approved-已通过，rejected-已驳回',
  `remark` TEXT COMMENT '审批意见',
  `approver` VARCHAR(100) DEFAULT NULL COMMENT '审批人',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  `update_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  PRIMARY KEY (`id`),
  KEY `idx_status` (`status`),
  KEY `idx_document_type` (`document_type`),
  KEY `idx_submit_time` (`submit_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='文书审批表';
```

### 3. 附件表 (attachment)

存储案件审批和文书审批相关的附件信息。

```sql
-- 创建附件表
CREATE TABLE `attachment` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '附件ID',
  `approval_id` BIGINT NOT NULL COMMENT '审批ID（关联案件审批表或文书审批表）',
  `approval_type` VARCHAR(20) NOT NULL COMMENT '审批类型：case-案件审批，document-文书审批',
  `file_name` VARCHAR(255) NOT NULL COMMENT '文件名',
  `file_size` BIGINT NOT NULL COMMENT '文件大小（字节）',
  `file_type` VARCHAR(50) NOT NULL COMMENT '文件类型：pdf，doc，docx，xls，xlsx，jpg，jpeg，png，txt等',
  `file_path` VARCHAR(500) NOT NULL COMMENT '文件存储路径',
  `upload_time` DATETIME NOT NULL COMMENT '上传时间',
  `uploader` VARCHAR(100) NOT NULL COMMENT '上传人',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_approval_id` (`approval_id`),
  KEY `idx_approval_type` (`approval_type`),
  KEY `idx_upload_time` (`upload_time`),
  KEY `idx_uploader` (`uploader`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='附件表';
```

### 4. 审批记录表 (approval_record)

存储审批历史记录，用于追踪审批流程。

```sql
-- 创建审批记录表
CREATE TABLE `approval_record` (
  `id` BIGINT NOT NULL AUTO_INCREMENT COMMENT '审批记录ID',
  `approval_type` VARCHAR(20) NOT NULL COMMENT '审批类型：case-案件审批，document-文书审批',
  `approval_id` BIGINT NOT NULL COMMENT '审批ID（关联案件审批表或文书审批表）',
  `approver` VARCHAR(100) NOT NULL COMMENT '审批人',
  `approval_status` VARCHAR(20) NOT NULL COMMENT '审批状态：approved-通过，rejected-驳回',
  `approval_opinion` TEXT COMMENT '审批意见',
  `approval_time` DATETIME NOT NULL COMMENT '审批时间',
  `create_time` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  PRIMARY KEY (`id`),
  KEY `idx_approval_type` (`approval_type`),
  KEY `idx_approval_id` (`approval_id`),
  KEY `idx_approver` (`approver`),
  KEY `idx_approval_time` (`approval_time`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='审批记录表';
```

## 索引说明

### 案件审批表索引
- `uk_case_number`: 案号唯一索引，确保案号不重复
- `idx_status`: 审批状态索引，用于按状态查询
- `idx_case_type`: 案件类型索引，用于按类型筛选
- `idx_priority`: 优先级索引，用于按优先级排序
- `idx_submit_time`: 提交时间索引，用于按时间排序

### 文书审批表索引
- `idx_status`: 审批状态索引，用于按状态查询
- `idx_document_type`: 文书类型索引，用于按类型筛选
- `idx_submit_time`: 提交时间索引，用于按时间排序

### 附件表索引
- `idx_approval_id`: 审批ID索引，用于关联查询
- `idx_approval_type`: 审批类型索引，用于按类型筛选
- `idx_upload_time`: 上传时间索引，用于按时间排序
- `idx_uploader`: 上传人索引，用于按上传人查询

**注意**：附件表通过`approval_id`和`approval_type`字段关联到案件审批表或文书审批表，采用软关联方式，不使用外键约束以提高系统灵活性和性能。

### 审批记录表索引
- `idx_approval_type`: 审批类型索引，用于按类型筛选
- `idx_approval_id`: 审批ID索引，用于关联查询
- `idx_approver`: 审批人索引，用于按审批人查询
- `idx_approval_time`: 审批时间索引，用于按时间排序

## 字段说明

### 案件审批表字段说明
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键ID |
| case_number | VARCHAR(100) | 案号，唯一标识 |
| case_title | VARCHAR(200) | 案件标题 |
| case_type | VARCHAR(50) | 案件类型枚举值 |
| submitter | VARCHAR(100) | 提交人姓名 |
| submit_time | DATETIME | 提交时间 |
| approval_time | DATETIME | 审批时间，未审批时为NULL |
| status | VARCHAR(20) | 审批状态：pending/approved/rejected |
| priority | VARCHAR(20) | 优先级：high/medium/low |
| description | TEXT | 案件描述 |
| remark | TEXT | 审批意见 |
| approver | VARCHAR(100) | 审批人姓名 |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |

### 文书审批表字段说明
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键ID |
| document_title | VARCHAR(200) | 文书标题 |
| document_type | VARCHAR(50) | 文书类型枚举值 |
| content | TEXT | 文书内容 |
| submitter | VARCHAR(100) | 提交人姓名 |
| submit_time | DATETIME | 提交时间 |
| approval_time | DATETIME | 审批时间，未审批时为NULL |
| status | VARCHAR(20) | 审批状态：pending/approved/rejected |
| remark | TEXT | 审批意见 |
| approver | VARCHAR(100) | 审批人姓名 |
| create_time | DATETIME | 创建时间 |
| update_time | DATETIME | 更新时间 |

### 附件表字段说明
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键ID |
| approval_id | BIGINT | 关联的审批ID，根据approval_type确定关联的是案件审批表还是文书审批表 |
| approval_type | VARCHAR(20) | 审批类型：case-案件审批，document-文书审批 |
| file_name | VARCHAR(255) | 文件名 |
| file_size | BIGINT | 文件大小（字节） |
| file_type | VARCHAR(50) | 文件类型扩展名 |
| file_path | VARCHAR(500) | 文件存储路径 |
| upload_time | DATETIME | 上传时间 |
| uploader | VARCHAR(100) | 上传人姓名 |
| create_time | DATETIME | 创建时间 |

### 审批记录表字段说明
| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | BIGINT | 主键ID |
| approval_type | VARCHAR(20) | 审批类型：case/document |
| approval_id | BIGINT | 关联的审批ID |
| approver | VARCHAR(100) | 审批人姓名 |
| approval_status | VARCHAR(20) | 审批状态：approved/rejected |
| approval_opinion | TEXT | 审批意见 |
| approval_time | DATETIME | 审批时间 |
| create_time | DATETIME | 创建时间 |

## 使用示例

### 插入案件审批数据
```sql
INSERT INTO `case_approval` (
  `case_number`, 
  `case_title`, 
  `case_type`, 
  `submitter`, 
  `submit_time`, 
  `status`, 
  `priority`, 
  `description`
) VALUES (
  'CASE-2026-0001',
  '张三诉李四合同纠纷案',
  'contract',
  '王律师',
  '2026-01-07 14:30:00',
  'pending',
  'high',
  '张三与李四签订的买卖合同存在违约行为，要求赔偿损失...'
);
```

### 插入文书审批数据
```sql
INSERT INTO `document_approval` (
  `document_title`, 
  `document_type`, 
  `content`, 
  `submitter`, 
  `submit_time`, 
  `status`
) VALUES (
  '张三起诉状',
  'complaint',
  '张三因合同纠纷起诉李四，要求赔偿损失...',
  '李四',
  '2026-01-07 14:30:00',
  'pending'
);
```

### 插入附件数据
```sql
INSERT INTO `attachment` (
  `approval_id`,
  `approval_type`,
  `file_name`,
  `file_size`,
  `file_type`,
  `file_path`,
  `upload_time`,
  `uploader`
) VALUES (
  1,
  'document',
  '合同原件.pdf',
  1234567,
  'pdf',
  '/uploads/contract.pdf',
  '2026-01-07 14:25:00',
  '李四'
);
```

### 更新案件审批状态
```sql
UPDATE `case_approval` 
SET 
  `status` = 'approved',
  `approval_time` = '2026-01-07 18:30:00',
  `approver` = '张法官',
  `remark` = '材料齐全，符合审批条件'
WHERE `id` = 1;
```

### 查询待审批的案件
```sql
SELECT 
  `id`,
  `case_number`,
  `case_title`,
  `case_type`,
  `submitter`,
  `submit_time`,
  `priority`,
  `description`
FROM `case_approval`
WHERE `status` = 'pending'
ORDER BY `priority` DESC, `submit_time` ASC;
```

### 查询待审批的文书
```sql
SELECT 
  `id`,
  `document_title`,
  `document_type`,
  `content`,
  `submitter`,
  `submit_time`
FROM `document_approval`
WHERE `status` = 'pending'
ORDER BY `submit_time` ASC;
```

### 附件相关查询

#### 查询某个案件审批的所有附件
```sql
SELECT 
  `id`,
  `file_name`,
  `file_size`,
  `file_type`,
  `file_path`,
  `upload_time`,
  `uploader`
FROM `attachment`
WHERE `approval_id` = 1 AND `approval_type` = 'case'
ORDER BY `upload_time` DESC;
```

#### 查询某个文书审批的所有附件
```sql
SELECT 
  `id`,
  `file_name`,
  `file_size`,
  `file_type`,
  `file_path`,
  `upload_time`,
  `uploader`
FROM `attachment`
WHERE `approval_id` = 2 AND `approval_type` = 'document'
ORDER BY `upload_time` DESC;
```

#### 查询最近上传的附件
```sql
SELECT 
  `a`.`id`,
  `a`.`file_name`,
  `a`.`file_size`,
  `a`.`file_type`,
  `a`.`upload_time`,
  `a`.`uploader`,
  `a`.`approval_type`,
  CASE 
    WHEN `a`.`approval_type` = 'case' THEN `c`.`case_title`
    WHEN `a`.`approval_type` = 'document' THEN `d`.`document_title`
  END AS `approval_title`
FROM `attachment` `a`
LEFT JOIN `case_approval` `c` ON `a`.`approval_id` = `c`.`id` AND `a`.`approval_type` = 'case'
LEFT JOIN `document_approval` `d` ON `a`.`approval_id` = `d`.`id` AND `a`.`approval_type` = 'document'
ORDER BY `a`.`upload_time` DESC
LIMIT 10;
```

### 统计审批数据
```sql
-- 案件审批统计
SELECT 
  `status`,
  COUNT(*) as count
FROM `case_approval`
GROUP BY `status`;

-- 文书审批统计
SELECT 
  `status`,
  COUNT(*) as count
FROM `document_approval`
GROUP BY `status`;

-- 附件类型统计
SELECT 
  `file_type`,
  COUNT(*) as count
FROM `attachment`
GROUP BY `file_type`
ORDER BY `count` DESC;
```
