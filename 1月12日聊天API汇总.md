# 聊天功能API汇总

> 文档版本: v1.0
> 更新日期: 2026-01-12
> 适用对象: 前端开发人员

---

## 目录

1. [获取或创建会话](#1-获取或创建会话)
2. [获取用户会话列表](#2-获取用户会话列表)
3. [获取置顶会话](#3-获取置顶会话)
4. [获取未置顶会话](#4-获取未置顶会话)
5. [获取会话消息](#5-获取会话消息)
6. [发送消息](#6-发送消息)
7. [标记消息已读](#7-标记消息已读)
8. [标记会话已读](#8-标记会话已读)
9. [撤回消息](#9-撤回消息)
10. [删除消息](#10-删除消息)
11. [删除会话](#11-删除会话)
12. [置顶/取消置顶会话](#12-置顶取消置顶会话)
13. [获取未读消息数](#13-获取未读消息数)
14. [获取会话未读消息数](#14-获取会话未读消息数)
15. [WebSocket连接说明](#15-websocket连接说明)
16. [文件上传说明](#16-文件上传说明)

---

## 通用说明

### 基础URL

```
http://your-domain/api/v1
```

### 请求头

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| Content-Type | String | 是 | application/json |
| Authorization | String | 是 | Bearer {token} |

### 通用响应格式

所有接口返回统一的JSON格式：

```json
{
  "code": 200,
  "message": "success",
  "data": {}
}
```

### 状态码说明

| 状态码 | 说明 |
|--------|------|
| 200 | 请求成功 |
| 400 | 请求参数错误 |
| 401 | 未授权 |
| 403 | 禁止访问 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

### 业务错误码

| 错误码 | 说明 |
|--------|------|
| 10001 | 用户不存在 |
| 10002 | 消息不存在 |
| 10003 | 会话不存在 |
| 10004 | 不能与自己创建会话 |
| 10005 | 不能给自己发送消息 |
| 10006 | 消息已被撤回 |
| 10007 | 超过2分钟，无法撤回消息 |
| 10008 | 无权操作此消息 |
| 10009 | 无权操作此会话 |

---

## 1. 获取或创建会话

### 接口信息

- **请求路径**: `/chat/conversation`
- **请求方法**: `GET`
- **接口描述**: 根据两个用户ID获取或创建会话

### 请求参数

#### Query参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId1 | Long | 是 | 用户1 ID |
| userId2 | Long | 是 | 用户2 ID |

#### 请求示例

```http
GET /api/v1/chat/conversation?userId1=1&userId2=2
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 1,
    "userId1": 1,
    "userId2": 2,
    "lastMessageId": 123,
    "lastMessageContent": "你好，请问案件进展如何？",
    "lastMessageType": "TEXT",
    "lastMessageTime": "2026-01-12T10:30:00",
    "user1UnreadCount": 0,
    "user2UnreadCount": 1,
    "user1Deleted": false,
    "user2Deleted": false,
    "user1Pinned": false,
    "user2Pinned": false,
    "status": "ACTIVE",
    "createTime": "2026-01-12T09:00:00"
  }
}
```

### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | Long | 会话ID |
| userId1 | Long | 用户1 ID |
| userId2 | Long | 用户2 ID |
| lastMessageId | Long | 最后一条消息ID |
| lastMessageContent | String | 最后一条消息内容预览 |
| lastMessageType | String | 最后一条消息类型: TEXT, IMAGE, FILE, VOICE, VIDEO |
| lastMessageTime | DateTime | 最后消息时间 |
| user1UnreadCount | Integer | 用户1未读消息数 |
| user2UnreadCount | Integer | 用户2未读消息数 |
| user1Deleted | Boolean | 用户1是否删除会话 |
| user2Deleted | Boolean | 用户2是否删除会话 |
| user1Pinned | Boolean | 用户1是否置顶 |
| user2Pinned | Boolean | 用户2是否置顶 |
| status | String | 会话状态: ACTIVE, ARCHIVED, DELETED |
| createTime | DateTime | 创建时间 |

---

## 2. 获取用户会话列表

### 接口信息

- **请求路径**: `/chat/conversations`
- **请求方法**: `GET`
- **接口描述**: 获取用户的所有会话列表（包含已删除的会话会被过滤）

### 请求参数

#### Query参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | 是 | 用户ID |

#### 请求示例

```http
GET /api/v1/chat/conversations?userId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "userId1": 1,
      "userId1Name": "张三",
      "userId2": 2,
      "userId2Name": "李四",
      "lastMessageId": 123,
      "lastMessageContent": "你好，请问案件进展如何？",
      "lastMessageType": "TEXT",
      "lastMessageTime": "2026-01-12T10:30:00",
      "user1UnreadCount": 0,
      "user2UnreadCount": 1,
      "user1Deleted": false,
      "user2Deleted": false,
      "user1Pinned": false,
      "user2Pinned": false,
      "status": "ACTIVE",
      "createTime": "2026-01-12T09:00:00"
    },
    {
      "id": 2,
      "userId1": 1,
      "userId1Name": "张三",
      "userId2": 3,
      "userId2Name": "王五",
      "lastMessageId": 456,
      "lastMessageContent": "文件已发送，请查收",
      "lastMessageType": "FILE",
      "lastMessageTime": "2026-01-12T11:15:00",
      "user1UnreadCount": 1,
      "user2UnreadCount": 0,
      "user1Deleted": false,
      "user2Deleted": false,
      "user1Pinned": true,
      "user2Pinned": false,
      "status": "ACTIVE",
      "createTime": "2026-01-12T08:30:00"
    }
  ]
}
```

### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| userId1Name | String | 用户1的用户名 |
| userId2Name | String | 用户2的用户名 |
| 其他字段 | - | 同获取或创建会话接口 |

---

## 3. 获取置顶会话

### 接口信息

- **请求路径**: `/chat/conversations/pinned`
- **请求方法**: `GET`
- **接口描述**: 获取用户的置顶会话列表

### 请求参数

#### Query参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | 是 | 用户ID |

#### 请求示例

```http
GET /api/v1/chat/conversations/pinned?userId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 2,
      "userId1": 1,
      "userId1Name": "张三",
      "userId2": 3,
      "userId2Name": "王五",
      "lastMessageId": 456,
      "lastMessageContent": "文件已发送，请查收",
      "lastMessageType": "FILE",
      "lastMessageTime": "2026-01-12T11:15:00",
      "user1UnreadCount": 1,
      "user2UnreadCount": 0,
      "user1Deleted": false,
      "user2Deleted": false,
      "user1Pinned": true,
      "user2Pinned": false,
      "status": "ACTIVE",
      "createTime": "2026-01-12T08:30:00"
    }
  ]
}
```

---

## 4. 获取未置顶会话

### 接口信息

- **请求路径**: `/chat/conversations/unpinned`
- **请求方法**: `GET`
- **接口描述**: 获取用户的未置顶会话列表

### 请求参数

#### Query参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | 是 | 用户ID |

#### 请求示例

```http
GET /api/v1/chat/conversations/unpinned?userId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": [
    {
      "id": 1,
      "userId1": 1,
      "userId1Name": "张三",
      "userId2": 2,
      "userId2Name": "李四",
      "lastMessageId": 123,
      "lastMessageContent": "你好，请问案件进展如何？",
      "lastMessageType": "TEXT",
      "lastMessageTime": "2026-01-12T10:30:00",
      "user1UnreadCount": 0,
      "user2UnreadCount": 1,
      "user1Deleted": false,
      "user2Deleted": false,
      "user1Pinned": false,
      "user2Pinned": false,
      "status": "ACTIVE",
      "createTime": "2026-01-12T09:00:00"
    }
  ]
}
```

---

## 5. 获取会话消息

### 接口信息

- **请求路径**: `/chat/messages`
- **请求方法**: `GET`
- **接口描述**: 分页获取指定会话的消息列表（按时间倒序）

### 请求参数

#### Query参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| conversationId | Long | 是 | 会话ID |
| pageNum | Integer | 否 | 页码，默认1 |
| pageSize | Integer | 否 | 每页大小，默认20 |

#### 请求示例

```http
GET /api/v1/chat/messages?conversationId=1&pageNum=1&pageSize=20
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "records": [
      {
        "id": 123,
        "conversationId": 1,
        "senderId": 1,
        "senderName": "张三",
        "receiverId": 2,
        "receiverName": "李四",
        "messageType": "TEXT",
        "content": "你好，请问案件进展如何？",
        "fileId": null,
        "fileName": null,
        "fileSize": null,
        "fileUrl": null,
        "messageStatus": "READ",
        "readTime": "2026-01-12T10:35:00",
        "isDeleted": false,
        "isRecalled": false,
        "createTime": "2026-01-12T10:30:00"
      },
      {
        "id": 122,
        "conversationId": 1,
        "senderId": 2,
        "senderName": "李四",
        "receiverId": 1,
        "receiverName": "张三",
        "messageType": "IMAGE",
        "content": null,
        "fileId": 456,
        "fileName": "photo.jpg",
        "fileSize": 1024000,
        "fileUrl": "/file/download/456",
        "messageStatus": "DELIVERED",
        "readTime": null,
        "isDeleted": false,
        "isRecalled": false,
        "createTime": "2026-01-12T10:25:00"
      }
    ],
    "total": 50,
    "pageNum": 1,
    "pageSize": 20
  }
}
```

### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| id | Long | 消息ID |
| conversationId | Long | 会话ID |
| senderId | Long | 发送者ID |
| senderName | String | 发送者用户名 |
| receiverId | Long | 接收者ID |
| receiverName | String | 接收者用户名 |
| messageType | String | 消息类型: TEXT, IMAGE, FILE, VOICE, VIDEO |
| content | String | 文本内容（仅TEXT类型有值） |
| fileId | Long | 文件ID（仅FILE/IMAGE/VOICE/VIDEO类型有值） |
| fileName | String | 文件名 |
| fileSize | Long | 文件大小（字节） |
| fileUrl | String | 文件URL |
| messageStatus | String | 消息状态: SENT, DELIVERED, READ, FAILED |
| readTime | DateTime | 阅读时间 |
| isDeleted | Boolean | 是否删除 |
| isRecalled | Boolean | 是否撤回 |
| createTime | DateTime | 创建时间 |

---

## 6. 发送消息

### 接口信息

- **请求路径**: `/chat/messages`
- **请求方法**: `POST`
- **接口描述**: 发送聊天消息

### 请求参数

#### Query参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| senderId | Long | 是 | 发送者ID |

#### Body参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| receiverId | Long | 是 | 接收者ID |
| messageType | String | 是 | 消息类型: TEXT, IMAGE, FILE, VOICE, VIDEO |
| content | String | 否 | 文本内容（TEXT类型必填） |
| fileId | Long | 否 | 文件ID（FILE/IMAGE/VOICE/VIDEO类型必填） |
| fileName | String | 否 | 文件名 |
| fileSize | Long | 否 | 文件大小（字节） |
| fileUrl | String | 否 | 文件URL |

#### 请求示例

##### 发送文本消息

```http
POST /api/v1/chat/messages?senderId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "receiverId": 2,
  "messageType": "TEXT",
  "content": "你好，请问案件进展如何？"
}
```

##### 发送图片消息

```http
POST /api/v1/chat/messages?senderId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "receiverId": 2,
  "messageType": "IMAGE",
  "fileId": 456,
  "fileName": "photo.jpg",
  "fileSize": 1024000,
  "fileUrl": "/file/download/456"
}
```

##### 发送文件消息

```http
POST /api/v1/chat/messages?senderId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "receiverId": 2,
  "messageType": "FILE",
  "fileId": 789,
  "fileName": "document.pdf",
  "fileSize": 2048000,
  "fileUrl": "/file/download/789"
}
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 124,
    "conversationId": 1,
    "senderId": 1,
    "senderName": "张三",
    "receiverId": 2,
    "receiverName": "李四",
    "messageType": "TEXT",
    "content": "你好，请问案件进展如何？",
    "fileId": null,
    "fileName": null,
    "fileSize": null,
    "fileUrl": null,
    "messageStatus": "SENT",
    "readTime": null,
    "isDeleted": false,
    "isRecalled": false,
    "createTime": "2026-01-12T10:40:00"
  }
}
```

### 错误响应示例

```json
{
  "code": 400,
  "message": "不能给自己发送消息",
  "data": null
}
```

---

## 7. 标记消息已读

### 接口信息

- **请求路径**: `/chat/messages/read`
- **请求方法**: `PUT`
- **接口描述**: 标记指定消息为已读状态

### 请求参数

#### Query参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | 是 | 用户ID |

#### Body参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| messageId | Long | 是 | 消息ID |

#### 请求示例

```http
PUT /api/v1/chat/messages/read?userId=2
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "messageId": 123
}
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 123,
    "conversationId": 1,
    "senderId": 1,
    "senderName": "张三",
    "receiverId": 2,
    "receiverName": "李四",
    "messageType": "TEXT",
    "content": "你好，请问案件进展如何？",
    "fileId": null,
    "fileName": null,
    "fileSize": null,
    "fileUrl": null,
    "messageStatus": "READ",
    "readTime": "2026-01-12T10:45:00",
    "isDeleted": false,
    "isRecalled": false,
    "createTime": "2026-01-12T10:30:00"
  }
}
```

---

## 8. 标记会话已读

### 接口信息

- **请求路径**: `/chat/conversations/read`
- **请求方法**: `PUT`
- **接口描述**: 标记会话中的所有消息为已读状态

### 请求参数

#### Query参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | 是 | 用户ID |
| conversationId | Long | 是 | 会话ID |

#### 请求示例

```http
PUT /api/v1/chat/conversations/read?userId=2&conversationId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": null
}
```

---

## 9. 撤回消息

### 接口信息

- **请求路径**: `/chat/messages/recall`
- **请求方法**: `PUT`
- **接口描述**: 撤回已发送的消息（仅限2分钟内）

### 请求参数

#### Query参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | 是 | 用户ID |

#### Body参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| messageId | Long | 是 | 消息ID |

#### 请求示例

```http
PUT /api/v1/chat/messages/recall?userId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "messageId": 124
}
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 124,
    "conversationId": 1,
    "senderId": 1,
    "senderName": "张三",
    "receiverId": 2,
    "receiverName": "李四",
    "messageType": "TEXT",
    "content": "你好，请问案件进展如何？",
    "fileId": null,
    "fileName": null,
    "fileSize": null,
    "fileUrl": null,
    "messageStatus": "SENT",
    "readTime": null,
    "isDeleted": false,
    "isRecalled": true,
    "createTime": "2026-01-12T10:40:00"
  }
}
```

### 错误响应示例

```json
{
  "code": 400,
  "message": "超过2分钟，无法撤回消息",
  "data": null
}
```

---

## 10. 删除消息

### 接口信息

- **请求路径**: `/chat/messages`
- **请求方法**: `DELETE`
- **接口描述**: 删除指定消息（仅删除自己的消息）

### 请求参数

#### Query参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | 是 | 用户ID |

#### Body参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| messageId | Long | 是 | 消息ID |

#### 请求示例

```http
DELETE /api/v1/chat/messages?userId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "messageId": 124
}
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": null
}
```

---

## 11. 删除会话

### 接口信息

- **请求路径**: `/chat/conversations`
- **请求方法**: `DELETE`
- **接口描述**: 删除指定会话（仅从自己的会话列表中移除）

### 请求参数

#### Query参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | 是 | 用户ID |
| conversationId | Long | 是 | 会话ID |

#### 请求示例

```http
DELETE /api/v1/chat/conversations?userId=1&conversationId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": null
}
```

---

## 12. 置顶/取消置顶会话

### 接口信息

- **请求路径**: `/chat/conversations/pin`
- **请求方法**: `PUT`
- **接口描述**: 设置会话的置顶状态

### 请求参数

#### Query参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | 是 | 用户ID |

#### Body参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| conversationId | Long | 是 | 会话ID |
| pinned | Boolean | 是 | 是否置顶：true-置顶，false-取消置顶 |

#### 请求示例

##### 置顶会话

```http
PUT /api/v1/chat/conversations/pin?userId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "conversationId": 1,
  "pinned": true
}
```

##### 取消置顶会话

```http
PUT /api/v1/chat/conversations/pin?userId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
Content-Type: application/json

{
  "conversationId": 1,
  "pinned": false
}
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": null
}
```

---

## 13. 获取未读消息数

### 接口信息

- **请求路径**: `/chat/unread/count`
- **请求方法**: `GET`
- **接口描述**: 获取用户的总未读消息数

### 请求参数

#### Query参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | 是 | 用户ID |

#### 请求示例

```http
GET /api/v1/chat/unread/count?userId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "totalUnread": 5,
    "conversationUnread": 0
  }
}
```

### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| totalUnread | Long | 总未读消息数 |
| conversationUnread | Long | 当前会话未读消息数（此接口固定为0） |

---

## 14. 获取会话未读消息数

### 接口信息

- **请求路径**: `/chat/conversations/unread/count`
- **请求方法**: `GET`
- **接口描述**: 获取指定会话的未读消息数

### 请求参数

#### Query参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| userId | Long | 是 | 用户ID |
| conversationId | Long | 是 | 会话ID |

#### 请求示例

```http
GET /api/v1/chat/conversations/unread/count?userId=1&conversationId=1
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "totalUnread": 0,
    "conversationUnread": 3
  }
}
```

### 响应字段说明

| 字段名 | 类型 | 说明 |
|--------|------|------|
| totalUnread | Long | 总未读消息数（此接口固定为0） |
| conversationUnread | Long | 当前会话未读消息数 |

---

## 15. WebSocket连接说明

### 连接信息

- **WebSocket端点**: `/ws`
- **协议**: STOMP over WebSocket (使用SockJS)
- **认证方式**: 通过Query参数传递JWT Token

### 连接示例

```javascript
import SockJS from 'sockjs-client';
import Stomp from 'stompjs';

// 连接WebSocket
const socket = new SockJS('http://your-domain/ws?token=YOUR_JWT_TOKEN');
const stompClient = Stomp.over(socket);

stompClient.connect({}, (frame) => {
    console.log('Connected: ' + frame);

    // 订阅个人消息
    stompClient.subscribe('/user/queue/chat', (message) => {
        const chatMessage = JSON.parse(message.body);
        console.log('收到新消息:', chatMessage);
        handleIncomingMessage(chatMessage);
    });

    // 订阅正在输入状态
    stompClient.subscribe('/topic/chat/typing', (message) => {
        const typingInfo = message.body.split(':');
        const userId = typingInfo[0];
        const conversationId = typingInfo[1];
        console.log(`用户 ${userId} 在会话 ${conversationId} 中正在输入`);
        handleTypingStatus(userId, conversationId);
    });
}, (error) => {
    console.log('Connection error: ' + error);
});
```

### 发送消息

#### 发送文本消息

```javascript
stompClient.send('/app/chat/send', {}, JSON.stringify({
    receiverId: 2,
    messageType: 'TEXT',
    content: '你好，请问案件进展如何？'
}));
```

#### 发送图片消息

```javascript
stompClient.send('/app/chat/send', {}, JSON.stringify({
    receiverId: 2,
    messageType: 'IMAGE',
    fileId: 456,
    fileName: 'photo.jpg',
    fileSize: 1024000,
    fileUrl: '/file/download/456'
}));
```

#### 标记消息已读

```javascript
stompClient.send('/app/chat/read/123', {}, '{}');
```

#### 撤回消息

```javascript
stompClient.send('/app/chat/recall/124', {}, '{}');
```

#### 发送正在输入状态

```javascript
stompClient.send('/app/chat/typing/1', {}, '{}');
```

### 断开连接

```javascript
stompClient.disconnect(() => {
    console.log('Disconnected');
});
```

### WebSocket消息格式

#### 新消息通知

```json
{
  "type": "NEW_MESSAGE",
  "userId": 2,
  "title": "新消息",
  "content": "你好，请问案件进展如何？",
  "data": {
    "id": 124,
    "conversationId": 1,
    "senderId": 1,
    "senderName": "张三",
    "receiverId": 2,
    "receiverName": "李四",
    "messageType": "TEXT",
    "content": "你好，请问案件进展如何？",
    "messageStatus": "SENT",
    "createTime": "2026-01-12T10:40:00"
  },
  "timestamp": 1704907200000
}
```

#### 消息已读通知

```json
{
  "type": "MESSAGE_READ",
  "userId": 1,
  "title": "消息已读",
  "content": "对方已阅读您的消息",
  "data": 123,
  "timestamp": 1704907200000
}
```

#### 消息撤回通知

```json
{
  "type": "MESSAGE_RECALLED",
  "userId": 2,
  "title": "消息撤回",
  "content": "对方撤回了一条消息",
  "data": 124,
  "timestamp": 1704907200000
}
```

---

## 16. 文件上传说明

### 文件上传接口

聊天功能的文件上传复用现有的文件上传接口，无需单独开发。

### 接口信息

- **请求路径**: `/file/upload`
- **请求方法**: `POST`
- **接口描述**: 上传聊天文件

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| file | File | 是 | 文件对象 |
| bizType | String | 是 | 业务类型，聊天功能固定为 "CHAT_MESSAGE" |
| bizId | Long | 是 | 业务ID，上传时可传0，发送消息时会更新 |

### 请求示例

```javascript
const formData = new FormData();
formData.append('file', fileObject);
formData.append('bizType', 'CHAT_MESSAGE');
formData.append('bizId', 0);

fetch('http://your-domain/api/v1/file/upload', {
    method: 'POST',
    headers: {
        'Authorization': 'Bearer YOUR_JWT_TOKEN'
    },
    body: formData
})
.then(response => response.json())
.then(data => {
    if (data.code === 200) {
        const fileRecord = data.data;
        console.log('文件上传成功:', fileRecord);
        console.log('文件ID:', fileRecord.id);
        console.log('文件URL:', fileRecord.filePath);
    }
});
```

### 成功响应示例

```json
{
  "code": 200,
  "message": "success",
  "data": {
    "id": 456,
    "originalFileName": "photo.jpg",
    "storedFileName": "20260112_abc123.jpg",
    "filePath": "/uploads/chat/20260112_abc123.jpg",
    "fileSize": 1024000,
    "fileExtension": "jpg",
    "mimeType": "image/jpeg",
    "fileHash": "abc123def456",
    "bizType": "CHAT_MESSAGE",
    "bizId": 0,
    "uploadTime": "2026-01-12T10:30:00",
    "uploadUserId": 1,
    "fileStatus": 1,
    "createTime": "2026-01-12T10:30:00"
  }
}
```

### 文件下载

文件下载使用现有的文件下载接口：

```http
GET /api/v1/file/download/{fileId}
Authorization: Bearer YOUR_JWT_TOKEN
```

### 完整发送文件消息流程

```javascript
// 1. 上传文件
async function uploadFile(file) {
    const formData = new FormData();
    formData.append('file', file);
    formData.append('bizType', 'CHAT_MESSAGE');
    formData.append('bizId', 0);

    const response = await fetch('http://your-domain/api/v1/file/upload', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer YOUR_JWT_TOKEN'
        },
        body: formData
    });

    const result = await response.json();
    return result.data;
}

// 2. 发送文件消息
async function sendFileMessage(receiverId, fileRecord) {
    const messageType = fileRecord.mimeType.startsWith('image/') ? 'IMAGE' : 'FILE';

    const messageData = {
        receiverId: receiverId,
        messageType: messageType,
        fileId: fileRecord.id,
        fileName: fileRecord.originalFileName,
        fileSize: fileRecord.fileSize,
        fileUrl: `/api/v1/file/download/${fileRecord.id}`
    };

    // 使用REST API发送
    const response = await fetch('http://your-domain/api/v1/chat/messages?senderId=1', {
        method: 'POST',
        headers: {
            'Authorization': 'Bearer YOUR_JWT_TOKEN',
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(messageData)
    });

    const result = await response.json();
    return result.data;
}

// 3. 完整流程
async function handleFileUploadAndSend(file, receiverId) {
    try {
        const fileRecord = await uploadFile(file);
        const message = await sendFileMessage(receiverId, fileRecord);
        console.log('文件消息发送成功:', message);
        return message;
    } catch (error) {
        console.error('发送文件消息失败:', error);
    }
}

// 使用示例
const fileInput = document.getElementById('fileInput');
fileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
        await handleFileUploadAndSend(file, 2);
    }
});
```

---

## 使用注意事项

### 1. 认证方式

所有接口都需要在请求头中携带JWT Token：

```
Authorization: Bearer {token}
```

WebSocket连接时通过Query参数传递Token：

```
ws://your-domain/ws?token={token}
```

### 2. 消息类型说明

| 类型 | 说明 | content字段 | fileId字段 |
|------|------|------------|------------|
| TEXT | 文本消息 | 必填 | 可选 |
| IMAGE | 图片消息 | 可选 | 必填 |
| FILE | 文件消息 | 可选 | 必填 |
| VOICE | 语音消息 | 可选 | 必填 |
| VIDEO | 视频消息 | 可选 | 必填 |

### 3. 消息状态说明

| 状态 | 说明 |
|------|------|
| SENT | 已发送 |
| DELIVERED | 已送达 |
| READ | 已读 |
| FAILED | 发送失败 |

### 4. 撤回消息限制

- 只能撤回自己发送的消息
- 撤回时间限制：发送后2分钟内
- 已撤回的消息无法再次撤回

### 5. 删除消息说明

- 只能删除自己发送的消息
- 删除操作是软删除，不会真正删除数据库记录
- 删除后消息不会在消息列表中显示

### 6. 会话删除说明

- 删除会话只是从自己的会话列表中移除
- 对方的会话不受影响
- 消息记录仍然保留在数据库中

### 7. 未读消息数

- 未读消息数是针对每个用户独立计算的
- 标记消息已读后，未读数会相应减少
- 建议定期轮询未读消息数接口更新UI

### 8. WebSocket连接管理

- 建议在页面加载时建立WebSocket连接
- 页面卸载时断开WebSocket连接
- 连接断开后应自动重连
- 处理网络异常情况

### 9. 文件大小限制

- 图片建议不超过10MB
- 文件建议不超过100MB
- 具体限制根据服务器配置而定

### 10. 分页加载建议

- 消息列表建议使用分页加载
- 初始加载20条消息
- 向上滚动时加载更多历史消息
- 建议实现消息缓存机制

### 11. 实时消息处理

- 收到新消息时，应更新消息列表
- 收到已读回执时，应更新消息状态
- 收到撤回通知时，应移除对应消息
- 收到正在输入状态时，应显示提示

### 12. 错误处理

- 所有接口都可能返回错误
- 建议统一处理错误响应
- 对用户友好的错误提示
- 记录错误日志便于排查

---

## 前端集成示例

### React集成示例

```javascript
import React, { useState, useEffect, useRef } from 'react';
import SockJS from 'sockjs-client';
import Stomp from 'stompjs';

function ChatComponent({ userId, currentUserId }) {
    const [messages, setMessages] = useState([]);
    const [inputText, setInputText] = useState('');
    const stompClientRef = useRef(null);

    useEffect(() => {
        const socket = new SockJS(`http://your-domain/ws?token=${getToken()}`);
        const stompClient = Stomp.over(socket);
        stompClientRef.current = stompClient;

        stompClient.connect({}, (frame) => {
            console.log('Connected:', frame);

            stompClient.subscribe('/user/queue/chat', (message) => {
                const chatMessage = JSON.parse(message.body);
                setMessages(prev => [...prev, chatMessage]);
            });
        }, (error) => {
            console.error('Connection error:', error);
        });

        return () => {
            if (stompClientRef.current) {
                stompClientRef.current.disconnect();
            }
        };
    }, []);

    const sendMessage = async () => {
        if (!inputText.trim()) return;

        const messageData = {
            receiverId: userId,
            messageType: 'TEXT',
            content: inputText
        };

        try {
            const response = await fetch('http://your-domain/api/v1/chat/messages?senderId=' + currentUserId, {
                method: 'POST',
                headers: {
                    'Authorization': 'Bearer ' + getToken(),
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(messageData)
            });

            const result = await response.json();
            if (result.code === 200) {
                setMessages(prev => [...prev, result.data]);
                setInputText('');
            }
        } catch (error) {
            console.error('发送消息失败:', error);
        }
    };

    return (
        <div>
            <div className="messages">
                {messages.map(msg => (
                    <div key={msg.id}>
                        <span>{msg.senderName}: </span>
                        <span>{msg.content}</span>
                    </div>
                ))}
            </div>
            <div className="input-area">
                <input
                    value={inputText}
                    onChange={(e) => setInputText(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && sendMessage()}
                />
                <button onClick={sendMessage}>发送</button>
            </div>
        </div>
    );
}

export default ChatComponent;
```

### Vue集成示例

```javascript
<template>
  <div class="chat-container">
    <div class="messages">
      <div v-for="msg in messages" :key="msg.id" class="message">
        <span class="sender">{{ msg.senderName }}: </span>
        <span class="content">{{ msg.content }}</span>
      </div>
    </div>
    <div class="input-area">
      <input
        v-model="inputText"
        @keypress.enter="sendMessage"
        placeholder="输入消息..."
      />
      <button @click="sendMessage">发送</button>
    </div>
  </div>
</template>

<script>
import SockJS from 'sockjs-client';
import Stomp from 'stompjs';

export default {
  name: 'ChatComponent',
  props: {
    userId: Number,
    currentUserId: Number
  },
  data() {
    return {
      messages: [],
      inputText: '',
      stompClient: null
    };
  },
  mounted() {
    this.connectWebSocket();
  },
  beforeDestroy() {
    if (this.stompClient) {
      this.stompClient.disconnect();
    }
  },
  methods: {
    connectWebSocket() {
      const socket = new SockJS(`http://your-domain/ws?token=${this.getToken()}`);
      this.stompClient = Stomp.over(socket);

      this.stompClient.connect({}, (frame) => {
        console.log('Connected:', frame);

        this.stompClient.subscribe('/user/queue/chat', (message) => {
          const chatMessage = JSON.parse(message.body);
          this.messages.push(chatMessage);
        });
      }, (error) => {
        console.error('Connection error:', error);
      });
    },
    async sendMessage() {
      if (!this.inputText.trim()) return;

      const messageData = {
        receiverId: this.userId,
        messageType: 'TEXT',
        content: this.inputText
      };

      try {
        const response = await fetch('http://your-domain/api/v1/chat/messages?senderId=' + this.currentUserId, {
          method: 'POST',
          headers: {
            'Authorization': 'Bearer ' + this.getToken(),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(messageData)
        });

        const result = await response.json();
        if (result.code === 200) {
          this.messages.push(result.data);
          this.inputText = '';
        }
      } catch (error) {
        console.error('发送消息失败:', error);
      }
    },
    getToken() {
      return localStorage.getItem('token');
    }
  }
};
</script>
```

---

## 附录

### A. 完整API列表速查

| 序号 | 接口名称 | 请求方法 | 请求路径 |
|------|---------|---------|---------|
| 1 | 获取或创建会话 | GET | /chat/conversation |
| 2 | 获取用户会话列表 | GET | /chat/conversations |
| 3 | 获取置顶会话 | GET | /chat/conversations/pinned |
| 4 | 获取未置顶会话 | GET | /chat/conversations/unpinned |
| 5 | 获取会话消息 | GET | /chat/messages |
| 6 | 发送消息 | POST | /chat/messages |
| 7 | 标记消息已读 | PUT | /chat/messages/read |
| 8 | 标记会话已读 | PUT | /chat/conversations/read |
| 9 | 撤回消息 | PUT | /chat/messages/recall |
| 10 | 删除消息 | DELETE | /chat/messages |
| 11 | 删除会话 | DELETE | /chat/conversations |
| 12 | 置顶/取消置顶会话 | PUT | /chat/conversations/pin |
| 13 | 获取未读消息数 | GET | /chat/unread/count |
| 14 | 获取会话未读消息数 | GET | /chat/conversations/unread/count |

### B. WebSocket订阅主题

| 主题 | 说明 |
|------|------|
| /user/queue/chat | 个人消息 |
| /topic/chat/typing | 正在输入状态 |

### C. WebSocket发送目的地

| 目的地 | 说明 |
|--------|------|
| /app/chat/send | 发送消息 |
| /app/chat/read/{messageId} | 标记消息已读 |
| /app/chat/recall/{messageId} | 撤回消息 |
| /app/chat/typing/{conversationId} | 发送正在输入状态 |

### D. 支持的文件类型

| 类型 | MIME类型 | 消息类型 |
|------|---------|---------|
| 图片 | image/jpeg, image/png, image/gif | IMAGE |
| 文档 | application/pdf, application/msword | FILE |
| 音频 | audio/mpeg, audio/wav | VOICE |
| 视频 | video/mp4, video/avi | VIDEO |

---

**文档结束**

如有疑问，请联系后端开发人员。
