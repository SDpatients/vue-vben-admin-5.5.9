# 前端动态与待办事项权限处理文档

## 目录
1. [功能概述](#1-功能概述)
2. [动态和待办事项的创建逻辑](#2-动态和待办事项的创建逻辑)
3. [权限控制方案](#3-权限控制方案)
4. [后端API接口说明](#4-后端api接口说明)
5. [前端调用示例](#5-前端调用示例)
6. [权限配置说明](#6-权限配置说明)
7. [使用场景示例](#7-使用场景示例)

---

## 1. 功能概述

### 1.1 动态模块（Activity）
动态模块用于记录系统中用户的各种操作行为，例如：
- 创建案件
- 更新案件
- 删除案件
- 提交审核
- 审核通过/驳回
- 完成待办事项

### 1.2 待办事项模块（Todo）
待办事项模块用于管理用户的任务列表，例如：
- 审核任务（由审核流程自动创建）
- 手动创建的待办事项
- 系统分配的待办事项

### 1.3 权限需求
- **普通用户**：只能查看自己的动态和待办事项
- **管理员/审核员**：可以查看所有用户的动态和待办事项
- **管理员**：可以为其他用户创建待办事项

---

## 2. 动态和待办事项的创建逻辑

### 2.1 动态的自动创建时机

#### 2.1.1 案件相关操作
当用户执行以下操作时，系统会自动创建动态记录：

| 操作 | 动态类型 | 动态内容示例 |
|------|---------|-------------|
| 创建案件 | CREATE_CASE | 张三 创建了新案件：破产案件001 |
| 更新案件 | UPDATE_CASE | 张三 更新了案件：破产案件001 |
| 删除案件 | DELETE_CASE | 张三 删除了案件：破产案件001 |

#### 2.1.2 审核相关操作
当用户执行审核操作时，系统会自动创建动态记录：

| 操作 | 动态类型 | 动态内容示例 |
|------|---------|-------------|
| 提交审核 | SUBMIT | 张三 提交审核申请：案件审核 |
| 审核通过 | APPROVE_PASS | 李四 审核通过：案件审核 |
| 审核驳回 | APPROVE_REJECT | 李四 审核驳回：案件审核 |

#### 2.1.3 待办相关操作
当用户对待办事项进行操作时，系统会自动创建动态记录：

| 操作 | 动态类型 | 动态内容示例 |
|------|---------|-------------|
| 创建待办 | CREATE_TODO | 张三 创建了待办事项：审核案件001 |
| 完成待办 | COMPLETE_TODO | 张三 完成了待办事项：审核案件001 |
| 取消待办 | CANCEL_TODO | 张三 取消了待办事项：审核案件001 |
| 删除待办 | DELETE_TODO | 张三 删除了待办事项：审核案件001 |

### 2.2 待办事项的自动创建时机

#### 2.2.1 审核流程自动创建待办
当用户提交审核申请时，系统会自动为审核人创建待办事项：

```java
// 审核提交时自动创建待办
todoService.createApprovalTodo(approval);
```

待办信息：
- 标题：审核任务：{审核标题}
- 描述：审核编号：{审核编号}
- 优先级：HIGH（高）
- 状态：PENDING（待处理）
- 来源类型：APPROVAL（审核任务）
- 关联ID：审核ID

#### 2.2.2 手动创建待办
用户可以手动创建待办事项：

```java
// 手动创建待办
todoService.createTodo(todoDTO);
```

待办信息：
- 标题：用户自定义
- 描述：用户自定义
- 优先级：用户自定义（默认MEDIUM）
- 状态：PENDING（待处理）
- 来源类型：MANUAL（手动创建）

#### 2.2.3 系统分配待办
管理员可以为其他用户创建待办事项：

```java
// 系统为指定用户创建待办
todoService.createTodoForUser(userId, title, description, priority, relatedType, relatedId);
```

待办信息：
- 标题：管理员指定
- 描述：管理员指定
- 优先级：管理员指定（默认MEDIUM）
- 状态：PENDING（待处理）
- 来源类型：SYSTEM（系统分配）

---

## 3. 权限控制方案

### 3.1 权限定义

| 权限编码 | 权限名称 | 说明 | 适用角色 |
|---------|---------|------|---------|
| activity:view:own | 查看自己的动态 | 普通用户默认权限 | LAWYER, REVIEWER, ADMIN |
| activity:view:all | 查看所有用户的动态 | 管理员和审核员权限 | REVIEWER, ADMIN |
| todo:view:own | 查看自己的待办 | 普通用户默认权限 | LAWYER, REVIEWER, ADMIN |
| todo:view:all | 查看所有用户的待办 | 管理员和审核员权限 | REVIEWER, ADMIN |
| todo:create:own | 创建自己的待办 | 普通用户默认权限 | LAWYER, REVIEWER, ADMIN |
| todo:create:all | 为其他用户创建待办 | 管理员权限 | ADMIN |

### 3.2 权限矩阵

| 操作 | LAWYER | REVIEWER | ADMIN |
|------|--------|----------|-------|
| 查看自己的动态 | ✓ | ✓ | ✓ |
| 查看所有用户的动态 | ✗ | ✓ | ✓ |
| 查看自己的待办 | ✓ | ✓ | ✓ |
| 查看所有用户的待办 | ✗ | ✓ | ✓ |
| 创建自己的待办 | ✓ | ✓ | ✓ |
| 为其他用户创建待办 | ✗ | ✗ | ✓ |

### 3.3 后端权限验证

#### 3.3.1 ActivityController 权限验证
```java
// 查看所有动态（需要 activity:view:all 权限）
@GetMapping("/list")
public Result getActivityList(HttpServletRequest request, ...) {
    Integer userId = getCurrentUserId(request);
    List<ActivityVO> list = activityService.getActivityList(type, page, pageSize);
    return Result.success("获取动态列表成功", list);
}

// 查看自己的动态
@GetMapping("/my")
public Result getMyActivityList(HttpServletRequest request, ...) {
    Integer userId = getCurrentUserId(request);
    List<ActivityVO> list = activityService.getActivityByUserId(userId, page, pageSize);
    return Result.success("获取我的动态成功", list);
}

// 查看指定用户的动态（需要 activity:view:all 权限）
@GetMapping("/user/{targetUserId}")
public Result getUserActivityList(
        HttpServletRequest request,
        @PathVariable Integer targetUserId, ...) {
    Integer currentUserId = getCurrentUserId(request);
    
    if (!canViewOtherActivities(currentUserId)) {
        return Result.error("无权查看其他用户的动态");
    }
    
    List<ActivityVO> list = activityService.getActivityByUserId(targetUserId, page, pageSize);
    return Result.success("获取用户动态成功", list);
}

private boolean canViewOtherActivities(Integer userId) {
    return permissionService.hasPermission(userId, "activity:view:all");
}
```

#### 3.3.2 TodoController 权限验证
```java
// 查看自己的待办
@GetMapping("/list")
public Result getTodoList(HttpServletRequest request, ...) {
    Integer userId = getCurrentUserId(request);
    List<TodoVO> list = todoService.getTodoList(userId, status, priority, page, pageSize);
    return Result.success("获取待办列表成功", list);
}

// 查看指定用户的待办（需要 todo:view:all 权限）
@GetMapping("/user/{targetUserId}")
public Result getUserTodoList(
        HttpServletRequest request,
        @PathVariable Integer targetUserId, ...) {
    Integer currentUserId = getCurrentUserId(request);
    
    if (!canViewOtherTodos(currentUserId)) {
        return Result.error("无权查看其他用户的待办事项");
    }
    
    List<TodoVO> list = todoService.getTodoList(targetUserId, status, priority, page, pageSize);
    return Result.success("获取用户待办列表成功", list);
}

// 创建自己的待办
@PostMapping
public Result createTodo(HttpServletRequest request, @RequestBody TodoDTO todoDTO) {
    Integer userId = getCurrentUserId(request);
    todoDTO.setUserId(userId);
    Long todoId = todoService.createTodo(todoDTO);
    return Result.success("创建待办成功", todoId);
}

// 为指定用户创建待办（需要 todo:create:all 权限）
@PostMapping("/user/{targetUserId}")
public Result createTodoForUser(
        HttpServletRequest request,
        @PathVariable Integer targetUserId,
        @RequestBody TodoDTO todoDTO) {
    Integer currentUserId = getCurrentUserId(request);
    
    if (!canCreateTodoForOthers(currentUserId)) {
        return Result.error("无权为其他用户创建待办事项");
    }
    
    todoService.createTodoForUser(
        targetUserId,
        todoDTO.getTitle(),
        todoDTO.getDescription(),
        todoDTO.getPriority(),
        todoDTO.getRelatedType(),
        todoDTO.getRelatedId()
    );
    return Result.success("为用户创建待办成功");
}

private boolean canViewOtherTodos(Integer userId) {
    return permissionService.hasPermission(userId, "todo:view:all");
}

private boolean canCreateTodoForOthers(Integer userId) {
    return permissionService.hasPermission(userId, "todo:create:all");
}
```

---

## 4. 后端API接口说明

### 4.1 动态相关接口

#### 4.1.1 获取所有动态列表
```
GET /api/activity/list
```

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| type | String | 否 | 动态类型筛选 |
| page | Integer | 否 | 页码，默认1 |
| pageSize | Integer | 否 | 每页数量，默认20 |

**响应示例：**
```json
{
  "code": 200,
  "message": "获取动态列表成功",
  "data": [
    {
      "id": 1,
      "userId": 1,
      "userName": "管理员",
      "type": "CREATE_CASE",
      "content": "创建了新案件：破产案件001",
      "relatedType": "CASE",
      "relatedId": 1,
      "createTime": "2025-12-29 10:00:00"
    }
  ]
}
```

#### 4.1.2 获取我的动态列表
```
GET /api/activity/my
```

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| page | Integer | 否 | 页码，默认1 |
| pageSize | Integer | 否 | 每页数量，默认20 |

**响应示例：**
```json
{
  "code": 200,
  "message": "获取我的动态成功",
  "data": [
    {
      "id": 2,
      "userId": 1,
      "userName": "张三",
      "type": "CREATE_TODO",
      "content": "创建了待办事项：审核案件001",
      "relatedType": "TODO",
      "relatedId": 1,
      "createTime": "2025-12-29 11:00:00"
    }
  ]
}
```

#### 4.1.3 获取指定用户的动态列表（需要权限）
```
GET /api/activity/user/{targetUserId}
```

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| targetUserId | Integer | 是 | 目标用户ID（路径参数） |
| page | Integer | 否 | 页码，默认1 |
| pageSize | Integer | 否 | 每页数量，默认20 |

**权限要求：** activity:view:all

**响应示例：**
```json
{
  "code": 200,
  "message": "获取用户动态成功",
  "data": [
    {
      "id": 3,
      "userId": 2,
      "userName": "李四",
      "type": "APPROVE_PASS",
      "content": "审核通过：案件审核",
      "relatedType": "APPROVAL",
      "relatedId": 1,
      "createTime": "2025-12-29 12:00:00"
    }
  ]
}
```

### 4.2 待办事项相关接口

#### 4.2.1 获取我的待办列表
```
GET /api/todo/list
```

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| status | String | 否 | 状态筛选（PENDING/IN_PROGRESS/COMPLETED/CANCELLED） |
| priority | String | 否 | 优先级筛选（HIGH/MEDIUM/LOW） |
| page | Integer | 否 | 页码，默认1 |
| pageSize | Integer | 否 | 每页数量，默认20 |

**响应示例：**
```json
{
  "code": 200,
  "message": "获取待办列表成功",
  "data": [
    {
      "id": 1,
      "userId": 1,
      "title": "审核案件001",
      "description": "需要审核破产案件001的申请材料",
      "priority": "HIGH",
      "status": "PENDING",
      "deadline": "2026-01-01 14:09:00",
      "sourceType": "APPROVAL",
      "sourceId": 1,
      "relatedType": "CASE",
      "relatedId": 1,
      "createTime": "2025-12-29 10:00:00",
      "updateTime": "2025-12-29 10:00:00"
    }
  ]
}
```

#### 4.2.2 获取指定用户的待办列表（需要权限）
```
GET /api/todo/user/{targetUserId}
```

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| targetUserId | Integer | 是 | 目标用户ID（路径参数） |
| status | String | 否 | 状态筛选 |
| priority | String | 否 | 优先级筛选 |
| page | Integer | 否 | 页码，默认1 |
| pageSize | Integer | 否 | 每页数量，默认20 |

**权限要求：** todo:view:all

**响应示例：**
```json
{
  "code": 200,
  "message": "获取用户待办列表成功",
  "data": [
    {
      "id": 2,
      "userId": 2,
      "title": "审核案件002",
      "description": "需要审核破产案件002的申请材料",
      "priority": "HIGH",
      "status": "PENDING",
      "deadline": "2026-01-02 10:00:00",
      "sourceType": "APPROVAL",
      "sourceId": 2,
      "relatedType": "CASE",
      "relatedId": 2,
      "createTime": "2025-12-29 11:00:00",
      "updateTime": "2025-12-29 11:00:00"
    }
  ]
}
```

#### 4.2.3 创建待办事项
```
POST /api/todo
```

**请求体：**
```json
{
  "title": "审核案件001",
  "description": "需要审核破产案件001的申请材料",
  "priority": "HIGH",
  "deadline": "2026-01-01 14:09:00",
  "relatedType": "CASE",
  "relatedId": 1
}
```

**响应示例：**
```json
{
  "code": 200,
  "message": "创建待办成功",
  "data": 1
}
```

#### 4.2.4 为指定用户创建待办事项（需要权限）
```
POST /api/todo/user/{targetUserId}
```

**请求参数：**
| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| targetUserId | Integer | 是 | 目标用户ID（路径参数） |

**请求体：**
```json
{
  "title": "审核案件001",
  "description": "需要审核破产案件001的申请材料",
  "priority": "HIGH",
  "relatedType": "CASE",
  "relatedId": 1
}
```

**权限要求：** todo:create:all

**响应示例：**
```json
{
  "code": 200,
  "message": "为用户创建待办成功",
  "data": null
}
```

#### 4.2.5 更新待办事项
```
PUT /api/todo/{id}
```

**请求体：**
```json
{
  "title": "更新后的标题",
  "description": "更新后的描述",
  "priority": "MEDIUM",
  "deadline": "2026-01-02 10:00:00"
}
```

**响应示例：**
```json
{
  "code": 200,
  "message": "更新待办成功",
  "data": null
}
```

#### 4.2.6 完成待办事项
```
PUT /api/todo/{id}/complete
```

**响应示例：**
```json
{
  "code": 200,
  "message": "完成待办成功",
  "data": null
}
```

#### 4.2.7 取消待办事项
```
PUT /api/todo/{id}/cancel
```

**响应示例：**
```json
{
  "code": 200,
  "message": "取消待办成功",
  "data": null
}
```

#### 4.2.8 删除待办事项
```
DELETE /api/todo/{id}
```

**响应示例：**
```json
{
  "code": 200,
  "message": "删除待办成功",
  "data": null
}
```

---

## 5. 前端调用示例

### 5.1 API层实现

#### 5.1.1 api/activity.ts
```typescript
import { requestClient } from '#/api/request';

export interface Activity {
  id: number;
  userId: number;
  userName: string;
  type: string;
  content: string;
  relatedType?: string;
  relatedId?: number;
  createTime: string;
}

export const activityApi = {
  // 获取所有动态列表
  getActivityList: (type?: string, page: number = 1, pageSize: number = 20) => {
    return requestClient.get('/api/activity/list', {
      params: { type, page, pageSize },
    });
  },

  // 获取我的动态列表
  getMyActivityList: (page: number = 1, pageSize: number = 20) => {
    return requestClient.get('/api/activity/my', {
      params: { page, pageSize },
    });
  },

  // 获取指定用户的动态列表
  getUserActivityList: (targetUserId: number, page: number = 1, pageSize: number = 20) => {
    return requestClient.get(`/api/activity/user/${targetUserId}`, {
      params: { page, pageSize },
    });
  },
};
```

#### 5.1.2 api/todo.ts
```typescript
import { requestClient } from '#/api/request';

export interface Todo {
  id: number;
  userId: number;
  title: string;
  description?: string;
  priority: string;
  status: string;
  deadline?: string;
  sourceType?: string;
  sourceId?: number;
  relatedType?: string;
  relatedId?: number;
  completedTime?: string;
  createTime: string;
  updateTime: string;
}

export interface TodoDTO {
  title: string;
  description?: string;
  priority?: string;
  deadline?: string;
  relatedType?: string;
  relatedId?: number;
}

export const todoApi = {
  // 获取我的待办列表
  getTodoList: (status?: string, priority?: string, page: number = 1, pageSize: number = 20) => {
    return requestClient.get('/api/todo/list', {
      params: { status, priority, page, pageSize },
    });
  },

  // 获取指定用户的待办列表
  getUserTodoList: (targetUserId: number, status?: string, priority?: string, page: number = 1, pageSize: number = 20) => {
    return requestClient.get(`/api/todo/user/${targetUserId}`, {
      params: { status, priority, page, pageSize },
    });
  },

  // 创建待办事项
  createTodo: (data: TodoDTO) => {
    return requestClient.post('/api/todo', data);
  },

  // 为指定用户创建待办事项
  createTodoForUser: (targetUserId: number, data: TodoDTO) => {
    return requestClient.post(`/api/todo/user/${targetUserId}`, data);
  },

  // 更新待办事项
  updateTodo: (id: number, data: Partial<TodoDTO>) => {
    return requestClient.put(`/api/todo/${id}`, data);
  },

  // 完成待办事项
  completeTodo: (id: number) => {
    return requestClient.put(`/api/todo/${id}/complete`);
  },

  // 取消待办事项
  cancelTodo: (id: number) => {
    return requestClient.put(`/api/todo/${id}/cancel`);
  },

  // 删除待办事项
  deleteTodo: (id: number) => {
    return requestClient.delete(`/api/todo/${id}`);
  },
};
```

### 5.2 组件实现

#### 5.2.1 动态列表组件
```vue
<template>
  <div class="activity-list">
    <div class="activity-header">
      <h3>最新动态</h3>
      <Select
        v-model:value="selectedType"
        style="width: 120px"
        @change="loadActivities"
      >
        <Select.Option value="">全部</Select.Option>
        <Select.Option value="CREATE_CASE">创建案件</Select.Option>
        <Select.Option value="UPDATE_CASE">更新案件</Select.Option>
        <Select.Option value="APPROVE_PASS">审核通过</Select.Option>
        <Select.Option value="APPROVE_REJECT">审核驳回</Select.Option>
      </Select>
      <Button
        v-if="canViewAllActivities"
        type="primary"
        @click="showUserSelector"
      >
        查看用户动态
      </Button>
    </div>
    <div class="activity-list" v-loading="loading">
      <Timeline>
        <Timeline.Item
          v-for="item in activities"
          :key="item.id"
          :color="getActivityColor(item.type)"
        >
          <div class="activity-item">
            <div class="activity-user">{{ item.userName }}</div>
            <div class="activity-content">{{ item.content }}</div>
            <div class="activity-time">{{ formatTime(item.createTime) }}</div>
          </div>
        </Timeline.Item>
      </Timeline>
      <div v-if="activities.length === 0" class="activity-empty">
        暂无动态
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue';
import { activityApi } from '#/api/activity';
import { useUserStore } from '#/store/modules/user';
import { Timeline, Select, Button, message } from 'ant-design-vue';
import { formatTime } from '#/utils/date';

const userStore = useUserStore();
const permissions = computed(() => userStore.getPermissions);

const loading = ref(false);
const activities = ref<any[]>([]);
const selectedType = ref('');
const currentPage = ref(1);
const pageSize = ref(10);

// 判断是否可以查看所有用户的动态
const canViewAllActivities = computed(() => {
  return permissions.value.includes('activity:view:all');
});

const loadActivities = async () => {
  loading.value = true;
  try {
    const res = await activityApi.getMyActivityList(
      currentPage.value,
      pageSize.value,
    );
    activities.value = res.data || [];
  } catch (error) {
    message.error('加载动态失败');
  } finally {
    loading.value = false;
  }
};

const showUserSelector = () => {
  // 显示用户选择器，让管理员选择要查看哪个用户的动态
  console.log('显示用户选择器');
};

const getActivityColor = (type: string) => {
  const colorMap: Record<string, string> = {
    CREATE_CASE: 'blue',
    UPDATE_CASE: 'blue',
    DELETE_CASE: 'red',
    APPROVE_PASS: 'green',
    APPROVE_REJECT: 'red',
    CREATE_TODO: 'blue',
    COMPLETE_TODO: 'green',
    CANCEL_TODO: 'orange',
    DELETE_TODO: 'red',
  };
  return colorMap[type] || 'gray';
};

onMounted(() => {
  loadActivities();
});
</script>
```

#### 5.2.2 待办事项列表组件
```vue
<template>
  <div class="todo-list">
    <div class="todo-header">
      <h3>待办事项</h3>
      <Button type="primary" size="small" @click="showCreateModal">
        <Icon icon="lucide:plus" :size="14" />
        新建
      </Button>
      <Button
        v-if="canViewAllTodos"
        type="default"
        size="small"
        @click="showUserSelector"
      >
        查看用户待办
      </Button>
    </div>
    <div class="todo-filters">
      <Radio.Group v-model:value="selectedStatus" @change="loadTodos">
        <Radio.Button value="">全部</Radio.Button>
        <Radio.Button value="PENDING">待处理</Radio.Button>
        <Radio.Button value="IN_PROGRESS">进行中</Radio.Button>
        <Radio.Button value="COMPLETED">已完成</Radio.Button>
      </Radio.Group>
      <Select
        v-model:value="selectedPriority"
        style="width: 100px; margin-left: 12px"
        @change="loadTodos"
      >
        <Select.Option value="">全部优先级</Select.Option>
        <Select.Option value="HIGH">高</Select.Option>
        <Select.Option value="MEDIUM">中</Select.Option>
        <Select.Option value="LOW">低</Select.Option>
      </Select>
    </div>
    <div class="todo-items" v-loading="loading">
      <div
        v-for="item in todos"
        :key="item.id"
        class="todo-item"
        :class="{
          completed: item.status === 'COMPLETED',
          high: item.priority === 'HIGH',
          medium: item.priority === 'MEDIUM',
          low: item.priority === 'LOW',
        }"
      >
        <div class="todo-checkbox">
          <Checkbox
            :checked="item.status === 'COMPLETED'"
            @change="toggleTodoStatus(item)"
          />
        </div>
        <div class="todo-content">
          <div class="todo-title">{{ item.title }}</div>
          <div v-if="item.description" class="todo-description">
            {{ item.description }}
          </div>
          <div class="todo-meta">
            <Tag :color="getPriorityColor(item.priority)">
              {{ getPriorityText(item.priority) }}
            </Tag>
            <span v-if="item.deadline" class="todo-deadline">
              <Icon icon="lucide:clock" :size="12" />
              {{ formatTime(item.deadline) }}
            </span>
          </div>
        </div>
        <div class="todo-actions">
          <Button type="text" size="small" @click="editTodo(item)">
            <Icon icon="lucide:edit-2" :size="14" />
          </Button>
          <Button type="text" size="small" danger @click="deleteTodo(item.id)">
            <Icon icon="lucide:trash-2" :size="14" />
          </Button>
        </div>
      </div>
      <div v-if="todos.length === 0" class="todo-empty">
        暂无待办事项
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, computed, onMounted } from 'vue';
import { todoApi, TodoDTO } from '#/api/todo';
import { useUserStore } from '#/store/modules/user';
import { Button, Checkbox, Tag, Select, Radio, Icon, message } from 'ant-design-vue';
import { formatTime } from '#/utils/date';

const userStore = useUserStore();
const permissions = computed(() => userStore.getPermissions);

const loading = ref(false);
const todos = ref<any[]>([]);
const selectedStatus = ref('');
const selectedPriority = ref('');

// 判断是否可以查看所有用户的待办
const canViewAllTodos = computed(() => {
  return permissions.value.includes('todo:view:all');
});

const loadTodos = async () => {
  loading.value = true;
  try {
    const res = await todoApi.getTodoList(
      selectedStatus.value || undefined,
      selectedPriority.value || undefined,
      1,
      20,
    );
    todos.value = res.data || [];
  } catch (error) {
    message.error('加载待办失败');
  } finally {
    loading.value = false;
  }
};

const toggleTodoStatus = async (item: any) => {
  if (item.status === 'COMPLETED') {
    await todoApi.updateTodo(item.id, { status: 'PENDING' });
  } else {
    await todoApi.completeTodo(item.id);
  }
  item.status = item.status === 'COMPLETED' ? 'PENDING' : 'COMPLETED';
};

const editTodo = (item: any) => {
  console.log('编辑待办:', item);
};

const deleteTodo = async (id: number) => {
  await todoApi.deleteTodo(id);
  todos.value = todos.value.filter((item) => item.id !== id);
};

const showCreateModal = () => {
  console.log('显示创建待办弹窗');
};

const showUserSelector = () => {
  // 显示用户选择器，让管理员选择要查看哪个用户的待办
  console.log('显示用户选择器');
};

const getPriorityColor = (priority: string) => {
  const colorMap: Record<string, string> = {
    HIGH: 'red',
    MEDIUM: 'orange',
    LOW: 'green',
  };
  return colorMap[priority] || 'default';
};

const getPriorityText = (priority: string) => {
  const textMap: Record<string, string> = {
    HIGH: '高',
    MEDIUM: '中',
    LOW: '低',
  };
  return textMap[priority] || priority;
};

onMounted(() => {
  loadTodos();
});
</script>
```

#### 5.2.3 管理员为用户创建待办组件
```vue
<template>
  <Modal
    v-model:open="visible"
    title="为用户创建待办事项"
    width="600px"
    @ok="handleCreate"
    @cancel="handleCancel"
  >
    <Form :model="form" layout="vertical">
      <Form.Item label="选择用户" required>
        <Select
          v-model:value="form.targetUserId"
          placeholder="请选择用户"
          :options="userOptions"
          show-search
          :filter-option="filterOption"
        />
      </Form.Item>
      <Form.Item label="待办标题" required>
        <Input
          v-model:value="form.title"
          placeholder="请输入待办标题"
        />
      </Form.Item>
      <Form.Item label="待办描述">
        <Input.TextArea
          v-model:value="form.description"
          placeholder="请输入待办描述"
          :rows="3"
        />
      </Form.Item>
      <Form.Item label="优先级">
        <Radio.Group v-model:value="form.priority">
          <Radio value="HIGH">高</Radio>
          <Radio value="MEDIUM">中</Radio>
          <Radio value="LOW">低</Radio>
        </Radio.Group>
      </Form.Item>
      <Form.Item label="截止时间">
        <DatePicker
          v-model:value="form.deadline"
          show-time
          format="YYYY-MM-DD HH:mm:ss"
          placeholder="请选择截止时间"
        />
      </Form.Item>
    </Form>
  </Modal>
</template>

<script setup lang="ts">
import { ref, watch } from 'vue';
import { Modal, Form, Input, Select, Radio, DatePicker, message } from 'ant-design-vue';
import { todoApi } from '#/api/todo';
import dayjs from 'dayjs';

interface Props {
  visible: boolean;
}

interface Emits {
  (e: 'update:visible', value: boolean): void;
  (e: 'success'): void;
}

const props = defineProps<Props>();
const emit = defineEmits<Emits>();

const visible = ref(false);
const form = ref({
  targetUserId: undefined,
  title: '',
  description: '',
  priority: 'MEDIUM',
  deadline: undefined,
});

const userOptions = ref([
  { label: '张三', value: 1 },
  { label: '李四', value: 2 },
  { label: '王五', value: 3 },
]);

watch(() => props.visible, (newVal) => {
  visible.value = newVal;
});

watch(visible, (newVal) => {
  emit('update:visible', newVal);
});

const filterOption = (input: string, option: any) => {
  return option.label.toLowerCase().includes(input.toLowerCase());
};

const handleCreate = async () => {
  if (!form.value.targetUserId) {
    message.warning('请选择用户');
    return;
  }
  if (!form.value.title) {
    message.warning('请输入待办标题');
    return;
  }

  try {
    await todoApi.createTodoForUser(form.value.targetUserId, {
      title: form.value.title,
      description: form.value.description,
      priority: form.value.priority,
      deadline: form.value.deadline ? form.value.deadline.format('YYYY-MM-DD HH:mm:ss') : undefined,
    });
    message.success('创建待办成功');
    visible.value = false;
    emit('success');
  } catch (error) {
    message.error('创建待办失败');
  }
};

const handleCancel = () => {
  visible.value = false;
  form.value = {
    targetUserId: undefined,
    title: '',
    description: '',
    priority: 'MEDIUM',
    deadline: undefined,
  };
};
</script>
```

---

## 6. 权限配置说明

### 6.1 数据库权限初始化SQL

```sql
-- 插入动态和待办相关权限
INSERT INTO TB_PERMISSION (perm_code, perm_name, perm_type, parent_id, sort_order, status) VALUES
('activity', '动态管理', '1', 0, 10, '1'),
('activity:view', '查看动态', '2', (SELECT perm_id FROM TB_PERMISSION WHERE perm_code = 'activity'), 1, '1'),
('activity:view:own', '查看自己的动态', '2', (SELECT perm_id FROM TB_PERMISSION WHERE perm_code = 'activity:view'), 1, '1'),
('activity:view:all', '查看所有用户的动态', '2', (SELECT perm_id FROM TB_PERMISSION WHERE perm_code = 'activity:view'), 2, '1'),
('todo', '待办管理', '1', 0, 11, '1'),
('todo:view', '查看待办', '2', (SELECT perm_id FROM TB_PERMISSION WHERE perm_code = 'todo'), 1, '1'),
('todo:view:own', '查看自己的待办', '2', (SELECT perm_id FROM TB_PERMISSION WHERE perm_code = 'todo:view'), 1, '1'),
('todo:view:all', '查看所有用户的待办', '2', (SELECT perm_id FROM TB_PERMISSION WHERE perm_code = 'todo:view'), 2, '1'),
('todo:create', '创建待办', '2', (SELECT perm_id FROM TB_PERMISSION WHERE perm_code = 'todo'), 2, '1'),
('todo:create:own', '创建自己的待办', '2', (SELECT perm_id FROM TB_PERMISSION WHERE perm_code = 'todo:create'), 1, '1'),
('todo:create:all', '为其他用户创建待办', '2', (SELECT perm_id FROM TB_PERMISSION WHERE perm_code = 'todo:create'), 2, '1');

-- 分配权限给角色
-- 律师角色
INSERT INTO TB_ROLE_PERMISSION (role_id, perm_id)
SELECT r.role_id, p.perm_id
FROM TB_ROLE r, TB_PERMISSION p
WHERE r.role_code = 'LAWYER'
AND p.perm_code IN (
  'activity', 'activity:view', 'activity:view:own',
  'todo', 'todo:view', 'todo:view:own', 'todo:create', 'todo:create:own'
);

-- 审核员角色
INSERT INTO TB_ROLE_PERMISSION (role_id, perm_id)
SELECT r.role_id, p.perm_id
FROM TB_ROLE r, TB_PERMISSION p
WHERE r.role_code = 'REVIEWER'
AND p.perm_code IN (
  'activity', 'activity:view', 'activity:view:own', 'activity:view:all',
  'todo', 'todo:view', 'todo:view:own', 'todo:view:all', 'todo:create', 'todo:create:own'
);

-- 管理员角色（拥有所有权限）
INSERT INTO TB_ROLE_PERMISSION (role_id, perm_id)
SELECT r.role_id, p.perm_id
FROM TB_ROLE r, TB_PERMISSION p
WHERE r.role_code = 'ADMIN';
```

### 6.2 权限检查流程

```
用户请求 → JWT拦截器 → 提取userId → 权限检查 → 返回结果
                                          ↓
                              permissionService.hasPermission(userId, permCode)
                                          ↓
                              查询用户角色和权限
                                          ↓
                              返回true/false
```

---

## 7. 使用场景示例

### 7.1 场景一：普通用户查看自己的动态和待办

**用户角色：** LAWYER（律师）

**操作流程：**
1. 用户登录系统
2. 进入工作台页面
3. 前端调用 `GET /api/activity/my` 获取我的动态
4. 前端调用 `GET /api/todo/list` 获取我的待办
5. 显示动态和待办列表

**前端代码示例：**
```typescript
// 获取我的动态
const loadMyActivities = async () => {
  const res = await activityApi.getMyActivityList(1, 20);
  activities.value = res.data || [];
};

// 获取我的待办
const loadMyTodos = async () => {
  const res = await todoApi.getTodoList('PENDING', null, 1, 20);
  todos.value = res.data || [];
};
```

### 7.2 场景二：审核员查看所有用户的动态和待办

**用户角色：** REVIEWER（审核员）

**操作流程：**
1. 审核员登录系统
2. 进入工作台页面
3. 前端检测到用户有 `activity:view:all` 和 `todo:view:all` 权限
4. 显示"查看用户动态"和"查看用户待办"按钮
5. 点击按钮，弹出用户选择器
6. 选择用户后，调用 `GET /api/activity/user/{targetUserId}` 和 `GET /api/todo/user/{targetUserId}`
7. 显示指定用户的动态和待办列表

**前端代码示例：**
```typescript
// 查看指定用户的动态
const loadUserActivities = async (targetUserId: number) => {
  const res = await activityApi.getUserActivityList(targetUserId, 1, 20);
  activities.value = res.data || [];
};

// 查看指定用户的待办
const loadUserTodos = async (targetUserId: number) => {
  const res = await todoApi.getUserTodoList(targetUserId, 'PENDING', null, 1, 20);
  todos.value = res.data || [];
};
```

### 7.3 场景三：管理员为用户创建待办事项

**用户角色：** ADMIN（管理员）

**操作流程：**
1. 管理员登录系统
2. 进入待办管理页面
3. 前端检测到用户有 `todo:create:all` 权限
4. 显示"为用户创建待办"按钮
5. 点击按钮，弹出创建待办弹窗
6. 选择目标用户，填写待办信息
7. 调用 `POST /api/todo/user/{targetUserId}` 创建待办
8. 成功后刷新列表

**前端代码示例：**
```typescript
// 为用户创建待办
const createTodoForUser = async (targetUserId: number, todoData: TodoDTO) => {
  const res = await todoApi.createTodoForUser(targetUserId, todoData);
  message.success('创建待办成功');
  loadUserTodos(targetUserId);
};
```

### 7.4 场景四：用户提交审核自动创建待办

**用户角色：** LAWYER（律师）

**操作流程：**
1. 用户创建案件并提交审核
2. 前端调用 `POST /api/approval` 提交审核申请
3. 后端自动为审核人创建待办事项
4. 后端自动记录动态
5. 后端发送通知给审核人
6. 审核人收到待办和通知

**后端代码示例：**
```java
// 提交审核时自动创建待办和动态
@Override
@Transactional
public Long submitApproval(ApprovalSubmitDTO submitDTO, Integer userId) {
    // ... 创建审核记录 ...
    
    // 为审核人创建待办
    todoService.createApprovalTodo(approval);
    
    // 记录动态
    activityService.recordActivity(
        userId, 
        submitDTO.getApplicantName(), 
        "SUBMIT", 
        "提交审核申请：" + approval.getTitle(), 
        "APPROVAL", 
        approval.getId()
    );
    
    // 发送通知
    notificationService.sendNotification(
        submitDTO.getApproverId(),
        "APPROVAL",
        "新的审核任务",
        "您有一条新的" + approval.getTitle() + "需要审核",
        "APPROVAL",
        approval.getId()
    );
    
    return approval.getId();
}
```

### 7.5 场景五：用户完成待办自动记录动态

**用户角色：** REVIEWER（审核员）

**操作流程：**
1. 审核员查看待办列表
2. 点击"完成"按钮
3. 前端调用 `PUT /api/todo/{id}/complete`
4. 后端更新待办状态
5. 后端自动记录动态
6. 前端刷新列表

**后端代码示例：**
```java
// 完成待办时自动记录动态
@Override
@Transactional
public void completeTodo(Long id, Integer userId) {
    Todo todo = todoMapper.selectById(id);
    if (todo != null && todo.getUserId().equals(userId)) {
        todoMapper.completeById(id);
        
        // 记录动态
        activityService.recordTodoActivity(
            userId,
            "当前用户",
            "COMPLETE",
            todo.getTitle(),
            todo.getId()
        );
    }
}
```

---

## 总结

本文档详细介绍了动态和待办事项的权限控制方案，包括：

1. **动态和待办事项的创建逻辑**：自动创建和手动创建的时机
2. **权限控制方案**：基于RBAC的权限模型
3. **后端API接口说明**：完整的接口文档
4. **前端调用示例**：Vue 3组件实现示例
5. **权限配置说明**：数据库初始化SQL
6. **使用场景示例**：常见业务场景的实现方案

通过本方案，可以实现：
- 普通用户只能查看和管理自己的动态和待办
- 审核员可以查看所有用户的动态和待办
- 管理员可以为其他用户创建待办事项
- 系统自动在关键操作时创建动态和待办记录
- 前后端权限验证双重保障

---

**文档版本**: v1.0
**更新时间**: 2025年12月31日
**适用技术栈**: Spring Boot 2.6.13 + Vue 3 + SQL Server 2008
