# 后端聊天开发指南

## 1. 系统架构设计

### 1.1 技术架构

- **后端框架**: Node.js + Express/Koa
- **数据库**: MySQL
- **实时通信**: Socket.IO
- **缓存**: Redis (用于会话管理、在线状态、未读消息计数)
- **文件存储**: 云存储服务 (如MinIO、OSS等)
- **认证授权**: JWT

### 1.2 模块划分

```
├── 联系人模块
│   ├── 联系人管理
│   ├── 联系人分组
│   └── 联系人关系
├── 聊天模块
│   ├── 消息管理
│   ├── 会话管理
│   ├── WebSocket服务
│   └── 消息推送
├── 文件模块
│   ├── 文件上传
│   ├── 文件下载
│   └── 文件管理
└── 通用模块
    ├── 认证授权
    ├── 日志管理
    └── 错误处理
```

### 1.3 模块交互关系

```
+-------------+     +-------------+     +-------------+
|  前端应用   | <--> | WebSocket服务 | <--> |  业务模块   |
|             |     |             |     |             |
|             | <--> |  REST API   | <--> |             |
+-------------+     +-------------+     +-------------+
                                      |
                                      v
                                  +-------------+
                                  |  数据库层   |
                                  +-------------+
```

## 2. 数据库设计

### 2.1 表结构定义

#### 2.1.1 用户表 (users)

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
|--------|----------|------|------|------|
| id | INT | 11 | PRIMARY KEY, AUTO_INCREMENT | 用户ID |
| username | VARCHAR | 50 | UNIQUE, NOT NULL | 用户名 |
| password | VARCHAR | 255 | NOT NULL | 密码（加密存储） |
| real_name | VARCHAR | 50 | NOT NULL | 真实姓名 |
| avatar | VARCHAR | 255 | | 头像URL |
| phone | VARCHAR | 20 | | 手机号 |
| email | VARCHAR | 100 | | 邮箱 |
| status | TINYINT | 1 | DEFAULT 1 | 状态（1:正常, 0:禁用） |
| created_at | DATETIME | | NOT NULL | 创建时间 |
| updated_at | DATETIME | | NOT NULL | 更新时间 |

#### 2.1.2 联系人表 (contacts)

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
|--------|----------|------|------|------|
| id | INT | 11 | PRIMARY KEY, AUTO_INCREMENT | 联系人ID |
| user_id | INT | 11 | NOT NULL, FOREIGN KEY | 所属用户ID |
| contact_user_id | INT | 11 | FOREIGN KEY | 联系人对应的系统用户ID（可为空，外部联系人） |
| name | VARCHAR | 50 | NOT NULL | 联系人姓名 |
| phone | VARCHAR | 20 | | 手机号 |
| email | VARCHAR | 100 | | 邮箱 |
| id_card | VARCHAR | 18 | | 身份证号 |
| avatar | VARCHAR | 255 | | 头像URL |
| description | TEXT | | | 描述 |
| is_system_user | TINYINT | 1 | DEFAULT 0 | 是否为系统用户（1:是, 0:否） |
| group_id | INT | 11 | FOREIGN KEY | 分组ID |
| is_online | TINYINT | 1 | DEFAULT 0 | 在线状态（1:在线, 0:离线） |
| last_online_time | DATETIME | | | 最后在线时间 |
| is_pinned | TINYINT | 1 | DEFAULT 0 | 是否置顶（1:是, 0:否） |
| created_by | VARCHAR | 50 | NOT NULL | 创建者 |
| created_at | DATETIME | | NOT NULL | 创建时间 |
| updated_by | VARCHAR | 50 | | 修改者 |
| updated_at | DATETIME | | NOT NULL | 更新时间 |

#### 2.1.3 联系人分组表 (contact_groups)

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
|--------|----------|------|------|------|
| id | INT | 11 | PRIMARY KEY, AUTO_INCREMENT | 分组ID |
| user_id | INT | 11 | NOT NULL, FOREIGN KEY | 所属用户ID |
| name | VARCHAR | 50 | NOT NULL | 分组名称 |
| sort_order | INT | 11 | DEFAULT 0 | 排序顺序 |
| color | VARCHAR | 20 | | 分组颜色 |
| created_by | VARCHAR | 50 | NOT NULL | 创建者 |
| created_at | DATETIME | | NOT NULL | 创建时间 |
| updated_by | VARCHAR | 50 | | 修改者 |
| updated_at | DATETIME | | NOT NULL | 更新时间 |

#### 2.1.4 聊天消息表 (chat_messages)

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
|--------|----------|------|------|------|
| id | BIGINT | 20 | PRIMARY KEY, AUTO_INCREMENT | 消息ID |
| sender_id | INT | 11 | NOT NULL, FOREIGN KEY | 发送者ID |
| receiver_id | INT | 11 | NOT NULL, FOREIGN KEY | 接收者ID |
| message_type | TINYINT | 1 | NOT NULL | 消息类型（1:文本, 2:图片, 3:文件, 4:系统消息） |
| content | TEXT | | | 消息内容 |
| file_url | VARCHAR | 255 | | 文件URL |
| file_name | VARCHAR | 255 | | 文件名 |
| file_size | BIGINT | 20 | | 文件大小 |
| thumbnail_url | VARCHAR | 255 | | 图片缩略图URL |
| is_recalled | TINYINT | 1 | DEFAULT 0 | 是否撤回（1:是, 0:否） |
| recall_time | DATETIME | | | 撤回时间 |
| read_status | TINYINT | 1 | DEFAULT 0 | 阅读状态（1:已读, 0:未读） |
| status | TINYINT | 1 | DEFAULT 1 | 消息状态（1:发送成功, 2:发送失败, 3:发送中） |
| created_at | DATETIME | | NOT NULL | 创建时间 |

#### 2.1.5 聊天会话表 (chat_sessions)

| 字段名 | 数据类型 | 长度 | 约束 | 描述 |
|--------|----------|------|------|------|
| id | INT | 11 | PRIMARY KEY, AUTO_INCREMENT | 会话ID |
| user_id | INT | 11 | NOT NULL, FOREIGN KEY | 所属用户ID |
| contact_id | INT | 11 | NOT NULL, FOREIGN KEY | 联系人ID |
| last_message_id | BIGINT | 20 | FOREIGN KEY | 最后一条消息ID |
| unread_count | INT | 11 | DEFAULT 0 | 未读消息数 |
| is_pinned | TINYINT | 1 | DEFAULT 0 | 是否置顶（1:是, 0:否） |
| last_activity_time | DATETIME | | NOT NULL | 最后活动时间 |
| created_at | DATETIME | | NOT NULL | 创建时间 |
| updated_at | DATETIME | | NOT NULL | 更新时间 |

### 2.2 索引设计

| 表名 | 索引名 | 索引字段 | 索引类型 | 描述 |
|------|--------|----------|----------|------|
| contacts | idx_user_id | user_id | 普通索引 | 加速查询用户的联系人列表 |
| contacts | idx_contact_user_id | contact_user_id | 普通索引 | 加速查询系统用户对应的联系人 |
| chat_messages | idx_sender_receiver | sender_id, receiver_id | 联合索引 | 加速查询双方聊天记录 |
| chat_messages | idx_receiver_created | receiver_id, created_at | 联合索引 | 加速查询接收者的消息列表 |
| chat_sessions | idx_user_contact | user_id, contact_id | 唯一索引 | 确保每个用户与联系人只有一个会话 |
| chat_sessions | idx_user_last_activity | user_id, last_activity_time | 联合索引 | 加速查询用户会话列表 |

### 2.3 数据关系图

```
+-----------------+     +-----------------+
|     users       |<----|   contacts      |
|                 |     |                 |
+-----------------+     +-----------------+
          ^                     ^
          |                     |
+-----------------+     +-----------------+
|  chat_messages  |<----|  chat_sessions  |
|                 |     |                 |
+-----------------+     +-----------------+
          ^                     ^
          |                     |
+-----------------+     +-----------------+
| contact_groups  |     |                 |
|                 |     |                 |
+-----------------+     +-----------------+
```

## 3. API接口规范

### 3.1 基础接口规范

#### 3.1.1 接口前缀
所有聊天相关接口前缀：`/api/web`

#### 3.1.2 请求头
```
Authorization: Bearer {token}  # JWT认证令牌
Content-Type: application/json  # 请求体类型
```

#### 3.1.3 响应格式

```json
{
  "status": "1",  # 1:成功, 0:失败
  "data": {},     # 响应数据
  "error": ""     # 错误信息
}
```

### 3.2 联系人管理接口

#### 3.2.1 获取联系人列表

- **接口地址**: `/api/web/contact`
- **请求方式**: GET
- **请求参数**:
  | 参数名 | 类型 | 必填 | 描述 |
  |--------|------|------|------|
  | group_id | INT | 否 | 分组ID，用于筛选特定分组的联系人 |
  | keyword | STRING | 否 | 搜索关键词，用于模糊搜索联系人 |
  | page | INT | 否 | 页码，默认1 |
  | page_size | INT | 否 | 每页条数，默认20 |

- **响应数据**:
  ```json
  {
    "status": "1",
    "data": {
      "records": [
        {
          "id": 1,
          "userId": 1,
          "contactUserId": 2,
          "name": "张三",
          "phone": "13800138000",
          "email": "zhangsan@example.com",
          "idCard": null,
          "avatar": null,
          "description": null,
          "isSystemUser": true,
          "groupId": 1,
          "isOnline": true,
          "lastOnlineTime": "2023-01-01 12:00:00",
          "isPinned": false,
          "createdAt": "2023-01-01 00:00:00",
          "updatedAt": "2023-01-01 00:00:00"
        }
      ],
      "total": 1,
      "page": 1,
      "pageSize": 20
    },
    "error": ""
  }
  ```

#### 3.2.2 新增联系人

- **接口地址**: `/api/web/contact`
- **请求方式**: POST
- **请求体**:
  ```json
  {
    "contactUserId": 2,  # 系统用户ID，外部联系人可为空
    "name": "张三",
    "phone": "13800138000",
    "email": "zhangsan@example.com",
    "idCard": null,
    "avatar": null,
    "description": null,
    "isSystemUser": true,
    "groupId": 1,
    "isPinned": false
  }
  ```

- **响应数据**:
  ```json
  {
    "status": "1",
    "data": {
      "id": 1
    },
    "error": ""
  }
  ```

#### 3.2.3 修改联系人

- **接口地址**: `/api/web/contact/:id`
- **请求方式**: PUT
- **请求体**: 同新增联系人
- **响应数据**: 同新增联系人

#### 3.2.4 删除联系人

- **接口地址**: `/api/web/contact/:id`
- **请求方式**: DELETE
- **响应数据**:
  ```json
  {
    "status": "1",
    "data": {
      "affectedRows": 1
    },
    "error": ""
  }
  ```

#### 3.2.5 获取联系人分组列表

- **接口地址**: `/api/web/contact-groups`
- **请求方式**: GET
- **响应数据**:
  ```json
  {
    "status": "1",
    "data": {
      "records": [
        {
          "id": 1,
          "userId": 1,
          "name": "同事",
          "sortOrder": 0,
          "color": "#409EFF",
          "createdAt": "2023-01-01 00:00:00"
        }
      ]
    },
    "error": ""
  }
  ```

#### 3.2.6 新增联系人分组

- **接口地址**: `/api/web/contact-groups`
- **请求方式**: POST
- **请求体**:
  ```json
  {
    "name": "朋友",
    "sortOrder": 1,
    "color": "#67C23A"
  }
  ```

- **响应数据**: 同新增联系人

#### 3.2.7 修改联系人分组

- **接口地址**: `/api/web/contact-groups/:id`
- **请求方式**: PUT
- **请求体**: 同新增联系人分组
- **响应数据**: 同新增联系人

#### 3.2.8 删除联系人分组

- **接口地址**: `/api/web/contact-groups/:id`
- **请求方式**: DELETE
- **响应数据**: 同删除联系人

### 3.3 聊天功能接口

#### 3.3.1 获取聊天记录

- **接口地址**: `/api/web/messages/:contactId`
- **请求方式**: GET
- **请求参数**:
  | 参数名 | 类型 | 必填 | 描述 |
  |--------|------|------|------|
  | page | INT | 否 | 页码，默认1 |
  | page_size | INT | 否 | 每页条数，默认20 |

- **响应数据**:
  ```json
  {
    "status": "1",
    "data": {
      "records": [
        {
          "id": 1,
          "senderId": 1,
          "receiverId": 2,
          "messageType": 1,
          "content": "你好",
          "fileUrl": null,
          "fileName": null,
          "fileSize": null,
          "thumbnailUrl": null,
          "isRecalled": false,
          "recallTime": null,
          "readStatus": true,
          "status": 1,
          "createdAt": "2023-01-01 12:00:00"
        }
      ],
      "total": 1,
      "page": 1,
      "pageSize": 20
    },
    "error": ""
  }
  ```

#### 3.3.2 发送消息（HTTP备用）

- **接口地址**: `/api/web/messages`
- **请求方式**: POST
- **请求体**:
  ```json
  {
    "receiverId": 2,
    "messageType": 1,
    "content": "你好",
    "fileUrl": null,
    "fileName": null,
    "fileSize": null,
    "thumbnailUrl": null
  }
  ```

- **响应数据**:
  ```json
  {
    "status": "1",
    "data": {
      "id": 1
    },
    "error": ""
  }
  ```

#### 3.3.3 撤回消息

- **接口地址**: `/api/web/messages/:id/recall`
- **请求方式**: PUT
- **响应数据**:
  ```json
  {
    "status": "1",
    "data": {
      "affectedRows": 1
    },
    "error": ""
  }
  ```

#### 3.3.4 标记消息为已读

- **接口地址**: `/api/web/messages/read`
- **请求方式**: PUT
- **请求体**:
  ```json
  {
    "contactId": 2,  # 联系人ID
    "messageIds": [1, 2, 3]  # 消息ID列表，可为空，为空则标记该联系人所有消息为已读
  }
  ```

- **响应数据**:
  ```json
  {
    "status": "1",
    "data": {
      "affectedRows": 3
    },
    "error": ""
  }
  ```

#### 3.3.5 获取聊天会话列表

- **接口地址**: `/api/web/sessions`
- **请求方式**: GET
- **响应数据**:
  ```json
  {
    "status": "1",
    "data": {
      "records": [
        {
          "id": 1,
          "contactId": 2,
          "lastMessage": {
            "id": 1,
            "content": "你好",
            "createdAt": "2023-01-01 12:00:00"
          },
          "unreadCount": 0,
          "isPinned": false,
          "lastActivityTime": "2023-01-01 12:00:00"
        }
      ]
    },
    "error": ""
  }
  ```

#### 3.3.6 搜索聊天记录

- **接口地址**: `/api/web/messages/search`
- **请求方式**: GET
- **请求参数**:
  | 参数名 | 类型 | 必填 | 描述 |
  |--------|------|------|------|
  | keyword | STRING | 是 | 搜索关键词 |
  | start_time | DATETIME | 否 | 开始时间 |
  | end_time | DATETIME | 否 | 结束时间 |
  | page | INT | 否 | 页码，默认1 |
  | page_size | INT | 否 | 每页条数，默认20 |

- **响应数据**: 同获取聊天记录

### 3.4 文件相关接口

#### 3.4.1 上传文件

- **接口地址**: `/api/web/files/upload`
- **请求方式**: POST
- **请求体**: FormData，包含file字段
- **响应数据**:
  ```json
  {
    "status": "1",
    "data": {
      "id": 1,
      "fileUrl": "http://example.com/files/1.jpg",
      "fileName": "1.jpg",
      "fileSize": 1024,
      "thumbnailUrl": "http://example.com/files/1_thumb.jpg"
    },
    "error": ""
  }
  ```

#### 3.4.2 下载文件

- **接口地址**: `/api/web/files/:id`
- **请求方式**: GET
- **响应**: 文件流

## 4. 业务逻辑实现

### 4.1 消息发送与接收机制

#### 4.1.1 WebSocket连接流程

1. 客户端发起WebSocket连接请求，携带JWT令牌
2. 服务器验证令牌，建立连接
3. 服务器记录连接信息，更新用户在线状态
4. 客户端定期发送心跳包，保持连接
5. 服务器定期检查心跳，清理无效连接

#### 4.1.2 消息发送流程

1. 客户端通过WebSocket发送消息
2. 服务器接收消息，验证消息合法性
3. 服务器将消息存储到数据库
4. 服务器更新聊天会话信息
5. 服务器通过WebSocket将消息推送给接收者
6. 服务器返回发送结果给发送者

#### 4.1.3 消息接收流程

1. 服务器通过WebSocket推送消息给接收者
2. 客户端接收消息，更新本地状态
3. 客户端显示新消息
4. 客户端发送已读确认

### 4.2 消息状态同步

#### 4.2.1 发送状态
- 发送中：消息已发送到服务器，但尚未确认
- 发送成功：消息已成功存储到数据库
- 发送失败：消息发送失败，需要重试

#### 4.2.2 阅读状态
- 未读：消息已送达，但接收者尚未阅读
- 已读：接收者已阅读消息

#### 4.2.3 状态同步机制
- 使用WebSocket实时同步消息状态
- 定期从服务器拉取最新状态（备用机制）

### 4.3 会话管理

#### 4.3.1 会话创建
- 当用户发送第一条消息时，自动创建会话
- 会话关联用户和联系人

#### 4.3.2 会话更新
- 当有新消息时，更新会话的最后消息和最后活动时间
- 当消息被阅读时，更新会话的未读消息数

#### 4.3.3 会话置顶
- 支持用户将重要会话置顶
- 置顶会话在列表中优先显示

### 4.4 联系人状态维护

#### 4.4.1 在线状态
- 通过WebSocket连接状态实时更新
- 连接建立时，更新为在线
- 连接断开时，更新为离线

#### 4.4.2 最后在线时间
- 记录用户最后一次在线的时间
- 用于显示离线用户的最后活跃时间

## 5. 数据操作指南

### 5.1 CRUD操作示例

#### 5.1.1 联系人CRUD示例

```javascript
// 创建联系人
async function createContact(contactData) {
  const [result] = await db.execute(
    'INSERT INTO contacts (user_id, contact_user_id, name, phone, email, is_system_user, group_id) VALUES (?, ?, ?, ?, ?, ?, ?)',
    [contactData.userId, contactData.contactUserId, contactData.name, contactData.phone, contactData.email, contactData.isSystemUser, contactData.groupId]
  );
  return result.insertId;
}

// 查询联系人列表
async function getContacts(userId, params) {
  const { groupId, keyword, page = 1, pageSize = 20 } = params;
  let query = 'SELECT * FROM contacts WHERE user_id = ?';
  const queryParams = [userId];
  
  if (groupId) {
    query += ' AND group_id = ?';
    queryParams.push(groupId);
  }
  
  if (keyword) {
    query += ' AND (name LIKE ? OR phone LIKE ? OR email LIKE ?)';
    queryParams.push(`%${keyword}%`, `%${keyword}%`, `%${keyword}%`);
  }
  
  query += ' ORDER BY is_pinned DESC, id DESC LIMIT ? OFFSET ?';
  queryParams.push(pageSize, (page - 1) * pageSize);
  
  const [rows] = await db.execute(query, queryParams);
  return rows;
}
```

#### 5.1.2 消息CRUD示例

```javascript
// 发送消息
async function sendMessage(messageData) {
  // 开启事务
  await db.beginTransaction();
  
  try {
    // 插入消息
    const [messageResult] = await db.execute(
      'INSERT INTO chat_messages (sender_id, receiver_id, message_type, content, file_url, file_name, file_size, thumbnail_url) VALUES (?, ?, ?, ?, ?, ?, ?, ?)',
      [messageData.senderId, messageData.receiverId, messageData.messageType, messageData.content, messageData.fileUrl, messageData.fileName, messageData.fileSize, messageData.thumbnailUrl]
    );
    
    const messageId = messageResult.insertId;
    
    // 更新或创建会话
    const [sessionResult] = await db.execute(
      'INSERT INTO chat_sessions (user_id, contact_id, last_message_id, unread_count, last_activity_time) VALUES (?, ?, ?, 1, NOW()) ON DUPLICATE KEY UPDATE last_message_id = ?, unread_count = unread_count + 1, last_activity_time = NOW()',
      [messageData.senderId, messageData.receiverId, messageId, messageId]
    );
    
    // 为接收者更新或创建会话
    await db.execute(
      'INSERT INTO chat_sessions (user_id, contact_id, last_message_id, unread_count, last_activity_time) VALUES (?, ?, ?, 1, NOW()) ON DUPLICATE KEY UPDATE last_message_id = ?, unread_count = unread_count + 1, last_activity_time = NOW()',
      [messageData.receiverId, messageData.senderId, messageId, messageId]
    );
    
    // 提交事务
    await db.commit();
    
    return messageId;
  } catch (error) {
    // 回滚事务
    await db.rollback();
    throw error;
  }
}

// 标记消息为已读
async function markMessagesAsRead(userId, contactId, messageIds = []) {
  if (messageIds.length > 0) {
    // 标记指定消息为已读
    await db.execute(
      'UPDATE chat_messages SET read_status = 1 WHERE receiver_id = ? AND sender_id = ? AND id IN (?)',
      [userId, contactId, messageIds]
    );
  } else {
    // 标记所有消息为已读
    await db.execute(
      'UPDATE chat_messages SET read_status = 1 WHERE receiver_id = ? AND sender_id = ?',
      [userId, contactId]
    );
  }
  
  // 重置会话未读消息数
  await db.execute(
    'UPDATE chat_sessions SET unread_count = 0 WHERE user_id = ? AND contact_id = ?',
    [userId, contactId]
  );
}
```

### 5.2 事务处理

- 在消息发送、撤回等关键操作中使用事务
- 确保数据一致性和完整性
- 事务失败时进行回滚处理

### 5.3 性能优化策略

1. **数据库优化**
   - 使用合适的索引
   - 分页查询，限制返回数据量
   - 定期清理无用数据
   - 使用读写分离（可选）

2. **缓存优化**
   - 使用Redis缓存热点数据（如联系人列表、会话列表）
   - 缓存用户在线状态
   - 缓存未读消息计数

3. **WebSocket优化**
   - 使用连接池管理WebSocket连接
   - 实现消息队列，异步处理消息
   - 压缩消息数据，减少网络传输

4. **文件处理优化**
   - 使用CDN加速文件访问
   - 实现文件分片上传
   - 异步生成缩略图

### 5.4 数据安全措施

1. **数据加密**
   - 敏感数据（如密码）加密存储
   - 传输数据加密（HTTPS、WSS）
   - 数据库字段级加密（可选）

2. **访问控制**
   - 基于角色的权限控制
   - 接口访问频率限制
   - IP白名单（可选）

3. **数据验证**
   - 输入数据合法性验证
   - 防止SQL注入
   - 防止XSS攻击

4. **数据备份与恢复**
   - 定期数据库备份
   - 备份数据异地存储
   - 制定数据恢复计划

## 6. 前端信息交互

### 6.1 实时消息推送方案

- 使用Socket.IO实现实时消息推送
- 支持多种消息类型：文本、图片、文件、系统消息
- 支持消息状态推送：发送状态、阅读状态
- 支持在线状态推送：用户上线、下线通知

### 6.2 WebSocket事件定义

#### 6.2.1 客户端发送事件

| 事件名 | 数据格式 | 描述 |
|--------|----------|------|
| message | `{ receiverId, messageType, content, fileUrl, fileName, fileSize, thumbnailUrl }` | 发送消息 |
| read | `{ contactId, messageIds }` | 标记消息为已读 |
| typing | `{ contactId, isTyping }` | 输入状态通知 |
| ping | 无 | 心跳包 |

#### 6.2.2 服务器推送事件

| 事件名 | 数据格式 | 描述 |
|--------|----------|------|
| message | 完整消息对象 | 新消息通知 |
| messageStatus | `{ messageId, status }` | 消息状态更新 |
| readStatus | `{ messageId, readStatus }` | 阅读状态更新 |
| onlineStatusChange | `{ userId, isOnline, lastOnlineTime }` | 在线状态变化 |
| typing | `{ userId, isTyping }` | 对方输入状态通知 |
| pong | 无 | 心跳响应 |

### 6.3 数据更新策略

1. **实时更新**
   - 新消息、消息状态、在线状态等通过WebSocket实时更新

2. **定期拉取**
   - 联系人列表、会话列表等定期从服务器拉取最新数据
   - 拉取频率可根据业务需求调整

3. **主动刷新**
   - 支持用户手动刷新数据
   - 页面切换时主动刷新数据

## 7. 性能与安全要求

### 7.1 性能指标

- WebSocket连接建立时间：< 1秒
- 消息延迟：< 500毫秒
- 支持并发连接数：> 10000
- 消息存储查询时间：< 100毫秒
- API响应时间：< 200毫秒

### 7.2 并发处理策略

1. **使用集群模式**
   - 部署多个WebSocket服务器实例
   - 使用Redis共享状态
   - 使用负载均衡分发请求

2. **异步处理**
   - 使用消息队列异步处理耗时操作
   - 非阻塞I/O操作

3. **资源限制**
   - 限制单个连接的消息发送频率
   - 限制单个用户的并发连接数
   - 限制消息大小

### 7.3 数据加密方案

1. **传输加密**
   - 使用HTTPS/WSS协议
   - 确保数据传输安全

2. **存储加密**
   - 密码使用bcrypt加密存储
   - 敏感数据使用AES加密存储

3. **密钥管理**
   - 使用环境变量管理密钥
   - 定期更换密钥
   - 密钥泄露应急预案

### 7.4 安全防护措施

1. **身份认证**
   - 使用JWT进行身份验证
   - 定期刷新令牌
   - 令牌过期机制

2. **权限控制**
   - 基于角色的访问控制
   - 接口级权限验证
   - 数据级权限验证

3. **防止攻击**
   - 防止SQL注入
   - 防止XSS攻击
   - 防止CSRF攻击
   - 防止DDoS攻击

4. **安全审计**
   - 记录关键操作日志
   - 定期安全审计
   - 漏洞扫描

## 8. 错误处理机制

### 8.1 统一错误处理策略

1. **错误分类**
   - 业务错误：如参数错误、权限不足等
   - 系统错误：如数据库连接失败、服务器内部错误等
   - 网络错误：如WebSocket连接失败、超时等

2. **错误码定义**
   - 200：成功
   - 400：请求参数错误
   - 401：未认证
   - 403：无权限
   - 404：资源不存在
   - 500：服务器内部错误
   - 503：服务不可用

3. **错误信息格式**
   - 统一错误响应格式
   - 包含错误码和错误描述
   - 详细错误信息仅在开发环境返回

### 8.2 异常捕获机制

1. **全局异常捕获**
   - 使用中间件捕获所有异常
   - 统一处理和返回错误

2. **局部异常捕获**
   - 关键操作使用try-catch捕获异常
   - 记录详细错误信息
   - 进行错误恢复或降级处理

### 8.3 日志记录规范

1. **日志级别**
   - DEBUG：调试信息
   - INFO：普通信息
   - WARN：警告信息
   - ERROR：错误信息
   - FATAL：致命错误

2. **日志内容**
   - 包含时间戳、日志级别、请求ID、用户ID、操作内容、错误信息等
   - 敏感信息脱敏处理

3. **日志存储**
   - 日志文件按天分割
   - 重要日志持久化存储
   - 支持日志检索和分析

4. **日志监控**
   - 实时监控错误日志
   - 异常告警机制
   - 日志分析和统计

## 9. 开发与部署指南

### 9.1 开发环境配置

1. **环境要求**
   - Node.js >= 16.x
   - MySQL >= 8.0
   - Redis >= 6.0

2. **依赖安装**
   ```bash
   npm install
   ```

3. **配置文件**
   - 复制`.env.example`为`.env`
   - 配置数据库连接、Redis连接、JWT密钥等

4. **数据库初始化**
   ```bash
   npm run migrate
   ```

5. **开发服务器启动**
   ```bash
   npm run dev
   ```

### 9.2 代码规范

1. **编码规范**
   - 使用ESLint进行代码检查
   - 遵循JavaScript/TypeScript编码规范
   - 使用Prettier进行代码格式化

2. **命名规范**
   - 变量名：小驼峰命名
   - 函数名：小驼峰命名
   - 类名：大驼峰命名
   - 常量名：全大写，下划线分隔

3. **注释规范**
   - 关键函数和类添加JSDoc注释
   - 复杂逻辑添加注释说明
   - 注释清晰、简洁

### 9.3 测试策略

1. **单元测试**
   - 测试核心函数和方法
   - 使用Jest进行单元测试
   - 测试覆盖率>=80%

2. **集成测试**
   - 测试模块间的交互
   - 测试API接口
   - 使用Supertest进行API测试

3. **端到端测试**
   - 测试完整业务流程
   - 使用Cypress进行端到端测试

4. **性能测试**
   - 测试系统并发能力
   - 测试响应时间
   - 使用Artillery进行性能测试

### 9.4 部署流程

1. **构建**
   ```bash
   npm run build
   ```

2. **部署方式**
   - 容器化部署（Docker + Kubernetes）
   - 传统部署（PM2 + Nginx）

3. **部署架构**
   - 多实例部署
   - 负载均衡
   - 高可用设计

4. **监控与告警**
   - 使用Prometheus + Grafana进行监控
   - 配置CPU、内存、磁盘、网络等监控指标
   - 配置错误告警、性能告警

5. **灰度发布**
   - 支持灰度发布
   - 支持版本回滚
   - 监控灰度发布指标

## 10. 总结

本后端聊天开发指南详细描述了聊天模块与联系人模块的系统架构设计、数据库设计、API接口规范、业务逻辑实现、数据操作指南、前端信息交互、性能与安全要求、错误处理机制以及开发与部署指南。

通过遵循本指南，后端开发人员可以完整实现聊天与联系人模块的所有功能，确保系统的稳定性、性能和安全性。同时，本指南也为前后端协作提供了清晰的接口规范和数据交互方式，确保整个通信功能的顺利实现。
