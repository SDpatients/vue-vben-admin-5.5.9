
### JSON编码规则
approval_content 格式：

```
{
  "task": {
    "id": 任务ID,
    "taskCode": "任务编码",
    "taskName": "任务名称",
    "taskDescription": "任务描述",
    "status": "任务状态",
    "sortOrder": 排序
  },
  "submissions": [
    {
      "id": 提交记录ID,
      "submissionTitle": "提交标题",
      "submissionContent": "提交内容
      ",
      "submissionType": "提交类型",
      "submissionNumber": 提交次数,
      "status": "状态",
      "reviewerId": 审核人ID,
      "reviewOpinion": "审核意见",
      "reviewTime": "审核时间",
      "createTime": "创建时间"
    }
  ]
}
```
approval_attachment 格式：

```
{
  "files": {
    "提交记录ID1": [
      {
        "id": 文件ID,
        "originalFileName": "原始文件
        名",
        "storedFileName": "存储文件名
        ",
        "filePath": "文件路径",
        "fileSize": 文件大小,
        "fileExtension": "文件扩展名
        ",
        "mimeType": "MIME类型",
        "description": "文件描述",
        "sortOrder": 排序,
        "uploadTime": "上传时间"
      }
    ],
    "提交记录ID2": [...]
  }
}
```
前端可以直接使用 JSON.parse() 解析这两个字段获取完整的任务、提交记录和文件信息。

前端需要做以下修改来正确调用和处理修改后的审批接口：

## 1. 接口调用方式
### 基本调用
前端仍然通过 POST 请求调用 api/v1/approval 接口，请求参数保持不变：

```
// 请求示例
fetch('api/v1/approval', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/
    json',
  },
  body: JSON.stringify({
    caseId: 16,
    approvalType: "TASK_003",
    approvalTitle: "流程审批 - 一、破
    产申请与受理 - 破产原因实质审查",
    approvalContent: "阶段：一、破产申
    请与受理\n任务：破产原因实质审查",
    approvalAttachment: "",
    remark: ""
  })
})
.then(response => response.json())
.then(data => {
  console.log('审批创建成功:', data);
})
.catch(error => {
  console.error('错误:', error);
});
```
## 2. 数据处理修改
### 2.1 处理返回的审批详情
当获取审批详情时（如通过 GET api/v1/approval/{approvalId} ），前端需要解析 approvalContent 和 approvalAttachment 字段：

```
// 解析审批详情示例
fetch(`api/v1/approval/${approvalId}
`)
.then(response => response.json())
.then(data => {
  if (data.success && data.data) {
    const approval = data.data;
    
    // 解析 approvalContent
    if (approval.approvalContent) {
      try {
        const contentData = JSON.
        parse(approval.
        approvalContent);
        console.log('任务信息:', 
        contentData.task);
        console.log('提交记录:', 
        contentData.submissions);
      } catch (e) {
        console.error('解析 
        approvalContent 失败:', e);
      }
    }
    
    // 解析 approvalAttachment
    if (approval.
    approvalAttachment) {
      try {
        const attachmentData = JSON.
        parse(approval.
        approvalAttachment);
        console.log('文件信息:', 
        attachmentData.files);
      } catch (e) {
        console.error('解析 
        approvalAttachment 失败:', 
        e);
      }
    }
  }
});
```
### 2.2 显示数据
前端可以根据解析后的数据构建界面：
 任务信息展示
```
// 显示任务信息
function renderTaskInfo(task) {
  return `
    <div class="task-info">
      <h3>${task.taskName}</h3>
      <p>任务编码: ${task.taskCode}</
      p>
      <p>状态: ${task.status}</p>
      ${task.taskDescription ? `<p>
      描述: ${task.taskDescription}
      </p>` : ''}
    </div>
  `;
}
``` 提交记录展示
```
// 显示提交记录
function renderSubmissions
(submissions) {
  return submissions.map(submission 
  => `
    <div class="submission-item">
      <h4>提交记录 #${submission.
      submissionNumber}: $
      {submission.submissionTitle}</
      h4>
      <p>类型: ${submission.
      submissionType}</p>
      <p>状态: ${submission.status}
      </p>
      ${submission.
      submissionContent ? `<p>内容: 
      ${submission.
      submissionContent}</p>` : ''}
      ${submission.reviewOpinion ? 
      `<p>审核意见: ${submission.
      reviewOpinion}</p>` : ''}
      <p>提交时间: ${submission.
      createTime}</p>
    </div>
  `).join('');
}
``` 文件展示
```
// 显示文件列表
function renderFiles
(filesBySubmission, submissions) {
  return Object.entries
  (filesBySubmission).map
  (([submissionId, files]) => {
    const submission = submissions.
    find(s => s.id.toString() === 
    submissionId);
    return `
      <div class="files-section">
        <h4>提交记录 #${submission?.
        submissionNumber} 的文件</
        h4>
        <ul>
          ${files.map(file => `
            <li>
              <a href="${file.
              filePath}" 
              target="_blank">$
              {file.
              originalFileName}</a>
              <span>($
              {formatFileSize(file.
              fileSize)})</span>
            </li>
          `).join('')}
        </ul>
      </div>
    `;
  }).join('');
}

// 格式化文件大小
function formatFileSize(bytes) {
  if (bytes === 0) return '0 B';
  const k = 1024;
  const sizes = ['B', 'KB', 'MB', 
  'GB'];
  const i = Math.floor(Math.log
  (bytes) / Math.log(k));
  return parseFloat((bytes / Math.
  pow(k, i)).toFixed(2)) + ' ' + 
  sizes[i];
}
```
## 3. 完整集成示例
```
// 完整示例：获取审批详情并渲染
async function getApprovalDetails
(approvalId) {
  try {
    const response = await fetch
    (`api/v1/approval/${approvalId}
    `);
    const data = await response.json
    ();
    
    if (data.success && data.data) {
      const approval = data.data;
      
      // 解析数据
      let taskInfo = null;
      let submissions = [];
      let filesBySubmission = {};
      
      if (approval.approvalContent) 
      {
        const contentData = JSON.
        parse(approval.
        approvalContent);
        taskInfo = contentData.task;
        submissions = contentData.
        submissions;
      }
      
      if (approval.
      approvalAttachment) {
        const attachmentData = JSON.
        parse(approval.
        approvalAttachment);
        filesBySubmission = 
        attachmentData.files;
      }
      
      // 渲染界面
      document.getElementById
      ('approval-title').
      textContent = approval.
      approvalTitle;
      
      if (taskInfo) {
        document.getElementById
        ('task-info').innerHTML = 
        renderTaskInfo(taskInfo);
      }
      
      if (submissions.length > 0) {
        document.getElementById
        ('submissions').innerHTML = 
        renderSubmissions
        (submissions);
      }
      
      if (Object.keys
      (filesBySubmission).length > 
      0) {
        document.getElementById
        ('files').innerHTML = 
        renderFiles
        (filesBySubmission, 
        submissions);
      }
      
    }
  } catch (error) {
    console.error('获取审批详情失败
    :', error);
  }
}
```
## 4. 兼容性处理
为了确保兼容性，前端应该添加错误处理：

1. 空值处理 ：检查字段是否存在
2. 解析错误处理 ：使用 try-catch 处理 JSON 解析错误
3. 向后兼容 ：如果字段不是 JSON 格式，保持原有处理逻辑
```
// 兼容处理示例
function parseApprovalContent
(content) {
  if (!content) return null;
  
  try {
    return JSON.parse(content);
  } catch (e) {
    // 如果不是 JSON，返回原始内容
    return { originalContent: 
    content };
  }
}

function parseApprovalAttachment
(attachment) {
  if (!attachment) return null;
  
  try {
    return JSON.parse(attachment);
  } catch (e) {
    // 如果不是 JSON，返回原始内容
    return { originalAttachment: 
    attachment };
  }
}
```
这样，前端就可以正确调用修改后的接口并处理返回的数据了！
